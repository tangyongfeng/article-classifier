#!/usr/bin/env python3
"""
分类规范化脚本
将重复和不一致的分类统一到标准分类体系中
"""

import json
from pathlib import Path
from typing import List, Dict

# 分类映射规则：将旧的分类路径映射到新的标准分类路径
CATEGORY_MAPPINGS = {
    # 语言学习相关 - 统一到 "教育 > 语言学习"
    ("语言学习", "德语"): ["教育", "语言学习", "德语"],
    ("语言学习", "德语", "语法"): ["教育", "语言学习", "德语", "语法"],
    ("语言学习", "德语", "词汇"): ["教育", "语言学习", "德语", "词汇"],
    ("语言学习", "德语", "动词变位"): ["教育", "语言学习", "德语", "语法", "动词变位"],
    ("语言学习", "德语", "形容词词尾"): ["教育", "语言学习", "德语", "语法", "形容词"],
    ("语言学习", "德语", "形容词"): ["教育", "语言学习", "德语", "语法", "形容词"],
    ("语言学习", "德语", "词汇与语法"): ["教育", "语言学习", "德语"],
    ("语言学习", "德语", "词汇前缀"): ["教育", "语言学习", "德语", "词汇"],
    ("语言学习", "德语词汇", "时间表达"): ["教育", "语言学习", "德语", "词汇", "时间"],
    ("语言学习", "德语语法", "格"): ["教育", "语言学习", "德语", "语法", "格"],
    ("语言学习", "语法"): ["教育", "语言学习", "语法"],
    ("语言学习",): ["教育", "语言学习"],

    # "语言" 改为 "教育 > 语言学习"
    ("语言", "德语"): ["教育", "语言学习", "德语"],
    ("语言", "德语", "语法"): ["教育", "语言学习", "德语", "语法"],
    ("语言", "德语", "语法-否定"): ["教育", "语言学习", "德语", "语法", "否定"],
    ("语言", "词汇", "形容词"): ["教育", "语言学习", "词汇", "形容词"],
    ("语言", "语法"): ["教育", "语言学习", "语法"],
    ("语言", "语法", "动词"): ["教育", "语言学习", "语法", "动词"],

    # "语言学" 改为 "教育 > 语言学习"
    ("语言学", "德语", "语法"): ["教育", "语言学习", "德语", "语法"],
    ("语言学", "语法", "从句连词"): ["教育", "语言学习", "语法", "从句"],

    # 金融相关 - 统一术语
    ("金融", "股票市场"): ["金融", "股市"],
    ("金融", "股票市场", "公司分析"): ["金融", "股市", "公司分析"],
    ("金融", "股票市场", "量化策略"): ["金融", "股市", "量化策略"],
    ("金融", "股票交易"): ["金融", "股市", "股票交易"],
    ("金融", "股票交易", "TD Ameritrade"): ["金融", "股市", "股票交易", "券商"],
    ("未分类", "金融"): ["金融"],

    # 旅行相关 - 统一术语
    ("旅行", "旅行经验"): ["旅行", "旅行经历"],
    ("旅行", "旅行经验", "一般"): ["旅行", "旅行经历", "通用"],
    ("旅行", "旅行经验", "其他"): ["旅行", "旅行经历", "其他"],
    ("旅行", "旅行偏好", "团队游与独自游"): ["旅行", "旅行经历", "独自游与团队游"],
    ("旅行", "独自旅行", "个人经历"): ["旅行", "旅行经历", "独自游与团队游"],
    ("旅行", "常旅客"): ["旅行"],

    # 技术创新 - 归并
    ("商务", "技术创新"): ["技术", "技术创新"],
    ("商务", "技术创新", "区块链应用"): ["技术", "区块链", "应用"],
    ("技术", "技术创新", "区块链应用"): ["技术", "区块链", "应用"],

    # 交通相关 - 统一
    ("交通", "驾照"): ["交通", "驾驶", "驾照"],
    ("交通", "驾照", "驾驶理论"): ["交通", "驾驶", "驾照", "理论"],
    ("交通", "驾驶", "驾驶指令"): ["交通", "驾驶", "驾驶规则"],
    ("交通", "驾驶知识", "驾驶规则"): ["交通", "驾驶", "驾驶规则"],
    ("交通安全", "驾驶考试", "词汇"): ["交通", "驾驶", "驾照", "考试"],
    ("城市生活", "交通"): ["交通"],
    ("城市生活", "交通", "停车冲突"): ["交通", "城市交通", "停车"],
    ("城市生活",): ["社会", "城市生活"],

    # 社交相关
    ("社交", "家庭活动"): ["社会", "家庭", "活动"],
    ("社交", "家庭活动", "婚礼祝贺"): ["社会", "家庭", "活动", "婚礼"],
    ("社交", "家庭关系"): ["社会", "家庭", "关系"],
    ("社交", "家庭讨论"): ["社会", "家庭", "讨论"],
    ("社会", "家庭讨论"): ["社会", "家庭", "讨论"],
    ("社交",): ["社会", "社交"],

    # 品牌相关
    ("商务", "品牌管理", "假洋品牌"): ["商务", "品牌", "品牌管理"],
    ("商务", "品牌国际化"): ["商务", "品牌", "国际化"],

    # 网络安全
    ("无线安全",): ["技术", "网络安全", "无线安全"],

    # 个人发展
    ("个人发展", "青年成长", "生活规划"): ["个人发展", "生活规划"],
}

def normalize_category_path(cat_path: List[str]) -> List[str]:
    """
    规范化分类路径
    """
    cat_tuple = tuple(cat_path)

    # 直接匹配
    if cat_tuple in CATEGORY_MAPPINGS:
        return CATEGORY_MAPPINGS[cat_tuple]

    # 返回原路径
    return cat_path

def process_articles():
    """
    处理所有文章，规范化分类
    """
    articles_dir = Path('data/json/articles')
    processed_count = 0
    changed_count = 0

    for json_file in articles_dir.rglob('*.json'):
        try:
            with open(json_file, 'r', encoding='utf-8') as f:
                article = json.load(f)

            if 'classification' in article and 'category_path' in article['classification']:
                old_path = article['classification']['category_path']
                new_path = normalize_category_path(old_path)

                if old_path != new_path:
                    article['classification']['category_path'] = new_path

                    # 写回文件
                    with open(json_file, 'w', encoding='utf-8') as f:
                        json.dump(article, f, ensure_ascii=False, indent=2)

                    print(f"✓ {json_file.name}: {' > '.join(old_path)} → {' > '.join(new_path)}")
                    changed_count += 1

                processed_count += 1

                if processed_count % 100 == 0:
                    print(f"已处理 {processed_count} 篇文章...")

        except Exception as e:
            print(f"✗ 处理 {json_file} 时出错: {e}")

    print(f"\n完成！共处理 {processed_count} 篇文章，修改了 {changed_count} 篇。")

if __name__ == '__main__':
    process_articles()
