---
title: 另类挂钩-RING3数据包监视（Delphi版）
updated: 2021-02-09 22:22:47Z
created: 2021-02-09 22:22:32Z
author: tangyongfeng@gmail.com
---


<en-note><div>unit&nbsp;uNtDeviceIoControl;</div><div>{</div><div>&nbsp;&nbsp;原理：Hook&nbsp;ntdll!NtDeviceIoControlFile</div><div>&nbsp;&nbsp;&nbsp;&nbsp;拦截&nbsp;AFD_RECV&nbsp;和&nbsp;AFD_SEND&nbsp;对TCP包进行监视，</div><div>&nbsp;&nbsp;&nbsp;&nbsp;通过比较&nbsp;send&nbsp;函数的&nbsp;Buffer&nbsp;是否为&nbsp;GET/POST</div><div>&nbsp;&nbsp;&nbsp;&nbsp;recv&nbsp;函数的&nbsp;Buffer&nbsp;是否为&nbsp;HTTP，来判断HTTP包</div><div><br/></div><div>&nbsp;&nbsp;&nbsp;&nbsp;代码思路相当清晰，又有注释（原来就有），我就不多说了。</div><div>}</div><div>interface</div><div><br/></div><div>uses</div><div>&nbsp;&nbsp;SysUtils,&nbsp;Windows;</div><div><br/></div><div>const</div><div>&nbsp;&nbsp;AFD_RECV&nbsp;=&nbsp;$12017;</div><div>&nbsp;&nbsp;AFD_SEND&nbsp;=&nbsp;$1201f;</div><div><br/></div><div>&nbsp;&nbsp;HTTP_GET:&nbsp;AnsiString&nbsp;=&nbsp;&apos;GET&nbsp;&apos;;</div><div>&nbsp;&nbsp;HTTP_POST:&nbsp;AnsiString&nbsp;=&nbsp;&apos;POST&nbsp;&apos;;</div><div>&nbsp;&nbsp;HTTP_RESPONSE:&nbsp;AnsiString&nbsp;=&nbsp;&apos;HTTP&apos;;</div><div><br/></div><div>type</div><div>&nbsp;&nbsp;NTSTATUS&nbsp;=&nbsp;DWORD;</div><div>&nbsp;&nbsp;PVOID&nbsp;=&nbsp;Pointer;</div><div><br/></div><div>&nbsp;&nbsp;_AFD_WSABUF&nbsp;=&nbsp;record</div><div>&nbsp;&nbsp;&nbsp;&nbsp;len:&nbsp;DWORD;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;buf:&nbsp;PAnsiChar;</div><div>&nbsp;&nbsp;end;</div><div>&nbsp;&nbsp;TAFD_WSABUF&nbsp;=&nbsp;_AFD_WSABUF;</div><div>&nbsp;&nbsp;PAFD_WSABUF&nbsp;=&nbsp;^TAFD_WSABUF;</div><div><br/></div><div>&nbsp;&nbsp;_AFD_INFO&nbsp;=&nbsp;record</div><div>&nbsp;&nbsp;&nbsp;&nbsp;BufferArray:&nbsp;PAFD_WSABUF;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;BufferCount:&nbsp;DWORD;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;AfdFlags:&nbsp;DWORD;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;TdiFlags:&nbsp;DWORD;</div><div>&nbsp;&nbsp;end;</div><div>&nbsp;&nbsp;TAFD_INFO&nbsp;=&nbsp;_AFD_INFO;</div><div>&nbsp;&nbsp;PAFD_INFO&nbsp;=&nbsp;^TAFD_INFO;</div><div><br/></div><div>&nbsp;&nbsp;_IO_STATUS_BLOCK&nbsp;=&nbsp;record</div><div>&nbsp;&nbsp;&nbsp;&nbsp;//union&nbsp;{</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Status:&nbsp;NTSTATUS;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;PVOID&nbsp;Pointer;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;//}</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Information:&nbsp;ULONG_PTR;</div><div>&nbsp;&nbsp;end;</div><div>&nbsp;&nbsp;IO_STATUS_BLOCK&nbsp;=&nbsp;_IO_STATUS_BLOCK;</div><div>&nbsp;&nbsp;PIO_STATUS_BLOCK&nbsp;=&nbsp;^IO_STATUS_BLOCK;</div><div>&nbsp;&nbsp;TIoStatusBlock&nbsp;=&nbsp;IO_STATUS_BLOCK;</div><div>&nbsp;&nbsp;PIoStatusBlock&nbsp;=&nbsp;^TIoStatusBlock;</div><div><br/></div><div>&nbsp;&nbsp;PIO_APC_ROUTINE&nbsp;=&nbsp;procedure(ApcContext:&nbsp;PVOID;&nbsp;IoStatusBlock:&nbsp;PIO_STATUS_BLOCK;&nbsp;Reserved:&nbsp;ULONG);&nbsp;stdcall;</div><div><br/></div><div>&nbsp;&nbsp;PIMAGE_IMPORT_DESCRIPTOR&nbsp;=&nbsp;^_IMAGE_IMPORT_DESCRIPTOR;</div><div>&nbsp;&nbsp;PImageImportDescriptor&nbsp;=&nbsp;PIMAGE_IMPORT_DESCRIPTOR;</div><div>&nbsp;&nbsp;_IMAGE_IMPORT_DESCRIPTOR&nbsp;=&nbsp;packed&nbsp;record</div><div>&nbsp;&nbsp;&nbsp;&nbsp;CharacteristicsOrOriginalFirstThunk:&nbsp;DWord;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;TimeDateStamp:&nbsp;DWord;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;ForwarderChain:&nbsp;DWord;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Name:&nbsp;DWord;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;FirstThunk:&nbsp;DWord;</div><div>&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;PIMAGE_THUNK_DATA&nbsp;=&nbsp;^_IMAGE_THUNK_DATA;</div><div>&nbsp;&nbsp;PImageThunkData&nbsp;=&nbsp;PIMAGE_THUNK_DATA;</div><div>&nbsp;&nbsp;_IMAGE_THUNK_DATA&nbsp;=&nbsp;packed&nbsp;record</div><div>&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;Integer&nbsp;of</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;:&nbsp;(ForwarderString:&nbsp;DWord);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;:&nbsp;(Function_:&nbsp;DWord);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;:&nbsp;(Ordinal:&nbsp;DWord);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;:&nbsp;(AddressOfData:&nbsp;DWord);</div><div>&nbsp;&nbsp;end;</div><div><br/></div><div>function&nbsp;NT_SUCCESS(Status:&nbsp;NTSTATUS):&nbsp;BOOL;</div><div>{$EXTERNALSYM&nbsp;NT_SUCCESS}</div><div><br/></div><div>var</div><div>&nbsp;&nbsp;OldNtDeviceIoControl:&nbsp;DWORD;</div><div><br/></div><div>procedure&nbsp;SuperHookDeviceIoControl();</div><div><br/></div><div>implementation</div><div><br/></div><div>function&nbsp;NT_SUCCESS(Status:&nbsp;NTSTATUS):&nbsp;BOOL;</div><div>begin</div><div>&nbsp;&nbsp;//Result&nbsp;:=&nbsp;Status&nbsp;&gt;=&nbsp;0;</div><div>&nbsp;&nbsp;Result&nbsp;:=&nbsp;Status&nbsp;&lt;&nbsp;$80000000;</div><div>end;</div><div><br/></div><div>//////////////////////////////////////////////////////////////////////////</div><div>///</div><div>///&nbsp;LookupSendPacket</div><div>///&nbsp;检查Send包</div><div>///&nbsp;目前实现了过滤HTTP请求（GET&nbsp;AND&nbsp;POST）</div><div>///</div><div>//////////////////////////////////////////////////////////////////////////</div><div>function&nbsp;LookupSendPacket(Buffer:&nbsp;Pointer;&nbsp;Len:&nbsp;DWORD):&nbsp;Boolean;</div><div>begin</div><div>&nbsp;&nbsp;Result&nbsp;:=&nbsp;False;</div><div>&nbsp;&nbsp;//&nbsp;过滤长度太小的包</div><div>&nbsp;&nbsp;if&nbsp;(Len&nbsp;&lt;&nbsp;10)&nbsp;then&nbsp;Exit;</div><div>&nbsp;&nbsp;//&nbsp;检查是不是GET或POST</div><div>&nbsp;&nbsp;if&nbsp;(&nbsp;CompareMem(Buffer,&nbsp;@HTTP_GET[1],&nbsp;4)</div><div>&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;CompareMem(Buffer,&nbsp;@HTTP_POST[1],&nbsp;4)&nbsp;)&nbsp;then</div><div>&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Result&nbsp;:=&nbsp;True;</div><div>&nbsp;&nbsp;end;</div><div>end;</div><div><br/></div><div>//////////////////////////////////////////////////////////////////////////</div><div>///</div><div>///&nbsp;LookupRecvPacket</div><div>///</div><div>///&nbsp;检查Recv包</div><div>///&nbsp;在这里可以实现Recv包查字典功能</div><div>///&nbsp;目前实现了过滤HTTP返回数据包的功能</div><div>///</div><div>///</div><div>///////////////////////////////////////////////////////////////////////////</div><div>function&nbsp;LookupRecvPacket(Buffer:&nbsp;Pointer;&nbsp;Len:&nbsp;DWORD):&nbsp;Boolean;</div><div>begin</div><div>&nbsp;&nbsp;Result&nbsp;:=&nbsp;False;</div><div>&nbsp;&nbsp;if&nbsp;(Len&nbsp;&lt;&nbsp;10)&nbsp;then&nbsp;Exit;</div><div><br/></div><div>&nbsp;&nbsp;if&nbsp;(&nbsp;CompareMem(Buffer,&nbsp;@HTTP_RESPONSE[1],&nbsp;4)&nbsp;)&nbsp;then</div><div>&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Result&nbsp;:=&nbsp;True;</div><div>&nbsp;&nbsp;end;</div><div>end;</div><div><br/></div><div>{&nbsp;HOOK&nbsp;函数&nbsp;}</div><div><br/></div><div>//////////////////////////////////////////////////////////////////////////</div><div>///</div><div>///&nbsp;NtDeviceIoControlFile的HOOK函数</div><div>///&nbsp;ws2_32.dll的send&nbsp;,&nbsp;recv最终会调用到mswsock.dll内的数据发送函数</div><div>///&nbsp;mswsock.dll会调用NtDeviceIoControl向TDI&nbsp;Client驱动发送Send&nbsp;Recv指令</div><div>///&nbsp;我们在这里做拦截，可以过滤所有的TCP&nbsp;收发包（UDP之类亦可，不过要更改指令）</div><div>///</div><div>//////////////////////////////////////////////////////////////////////////</div><div>///&nbsp;Compatibility:&nbsp;NT3,&nbsp;NT4,&nbsp;W2K,&nbsp;WXP,&nbsp;2K3</div><div>function&nbsp;NewNtDeviceIoControlFile(</div><div>&nbsp;&nbsp;&nbsp;&nbsp;FileHandle&nbsp;:&nbsp;THANDLE;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Event&nbsp;:&nbsp;THANDLE;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;ApcRoutine&nbsp;:&nbsp;PIO_APC_ROUTINE;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;ApcContext&nbsp;:&nbsp;PVOID;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;IoStatusBlock&nbsp;:&nbsp;PIO_STATUS_BLOCK;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;IoControlCode&nbsp;:&nbsp;ULONG;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;InputBuffer&nbsp;:&nbsp;PVOID;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;InputBufferLength&nbsp;:&nbsp;ULONG;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;OutputBuffer&nbsp;:&nbsp;PVOID;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;OutputBufferLength&nbsp;:&nbsp;ULONG</div><div>&nbsp;&nbsp;):&nbsp;NTSTATUS;&nbsp;stdcall;</div><div>var</div><div>&nbsp;&nbsp;AfdInfo:&nbsp;PAFD_INFO;</div><div>&nbsp;&nbsp;Buffer:&nbsp;PAnsiChar;</div><div>&nbsp;&nbsp;Len:&nbsp;DWORD;</div><div>begin</div><div>&nbsp;&nbsp;//&nbsp;先调用原始函数</div><div>&nbsp;&nbsp;asm</div><div>&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;OutputBufferLength</div><div>&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;OutputBuffer</div><div>&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;InputBufferLength</div><div>&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;InputBuffer</div><div>&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;IoControlCode</div><div>&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;IoStatusBlock</div><div>&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;ApcContext</div><div>&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;ApcRoutine</div><div>&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;Event</div><div>&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;FileHandle</div><div>&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;OldNtDeviceIoControl</div><div>&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;Result,&nbsp;eax</div><div>&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;//&nbsp;如果原始函数失败了（例如RECV无数据）</div><div>&nbsp;&nbsp;if&nbsp;(Not&nbsp;NT_SUCCESS(Result))&nbsp;then</div><div>&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Exit;</div><div>&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;//&nbsp;检查是否为TCP收发指令</div><div>&nbsp;&nbsp;if&nbsp;(IoControlCode&nbsp;&lt;&gt;&nbsp;AFD_SEND)</div><div>&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;(IoControlCode&nbsp;&lt;&gt;&nbsp;AFD_RECV)&nbsp;then</div><div>&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Exit;</div><div>&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;//&nbsp;访问AFD&nbsp;INFO结构，获得SEND或RECV的BUFFER信息</div><div>&nbsp;&nbsp;//&nbsp;这里可能是有问题的BUFFER，因此我们要加TRY&nbsp;EXCEPT</div><div>&nbsp;&nbsp;try</div><div>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;从&nbsp;InputBuffer&nbsp;得到&nbsp;Buffer&nbsp;和&nbsp;Len</div><div>&nbsp;&nbsp;&nbsp;&nbsp;AfdInfo&nbsp;:=&nbsp;PAFD_INFO(InputBuffer);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Buffer&nbsp;:=&nbsp;AfdInfo.BufferArray.buf;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Len&nbsp;:=&nbsp;AfdInfo.BufferArray.len;</div><div><br/></div><div>&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;IoControlCode&nbsp;of</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AFD_SEND:</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;LookupSendPacket(Buffer,&nbsp;Len)&nbsp;)&nbsp;then</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;输出包内容</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(PChar(Format(&apos;[HTTP&nbsp;Send]&nbsp;Length&nbsp;=&nbsp;%d&apos;,&nbsp;[Len])));</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(PChar(Format(&apos;%s&apos;,&nbsp;[StrPas(Buffer)])));</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AFD_RECV:</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;LookupRecvPacket(Buffer,&nbsp;Len)&nbsp;)&nbsp;then</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;输出包内容</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(PChar(Format(&apos;[HTTP&nbsp;Recv]&nbsp;Length&nbsp;=&nbsp;%d&apos;,&nbsp;[Len])));</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(PChar(Format(&apos;%s&apos;,&nbsp;[StrPas(Buffer)])));</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;end;</div><div>&nbsp;&nbsp;except</div><div>&nbsp;&nbsp;end;</div><div>end;</div><div><br/></div><div>//////////////////////////////////////////////////////////////////////////</div><div>///</div><div>///&nbsp;&nbsp;Hook&nbsp;mswsock.dll导出表的Ntdll!NtDeviceIoControlFile</div><div>///&nbsp;&nbsp;并过滤其对TDI&nbsp;Cilent的请求来过滤封包</div><div>///&nbsp;&nbsp;稳定，隐蔽，RING3下最底层的包过滤~</div><div>///</div><div>//////////////////////////////////////////////////////////////////////////</div><div>procedure&nbsp;SuperHookDeviceIoControl();</div><div>var</div><div>&nbsp;&nbsp;hMod:&nbsp;HMODULE;</div><div>&nbsp;&nbsp;pDosHeader:&nbsp;PImageDosHeader;</div><div>&nbsp;&nbsp;pNtHeaders:&nbsp;PImageNtHeaders;</div><div>&nbsp;&nbsp;ImportDescriptor:&nbsp;PImageImportDescriptor;</div><div>&nbsp;&nbsp;ThunkData:&nbsp;PImageThunkData;</div><div>&nbsp;&nbsp;dll_name,&nbsp;func_name:&nbsp;PAnsiChar;</div><div>&nbsp;&nbsp;iNum:&nbsp;Integer;</div><div>&nbsp;&nbsp;lpAddr:&nbsp;Pointer;</div><div>&nbsp;&nbsp;myaddr,&nbsp;btw:&nbsp;DWORD;</div><div>begin</div><div>&nbsp;&nbsp;//得到ws2_32.dll的模块基址</div><div>&nbsp;&nbsp;hMod&nbsp;:=&nbsp;LoadLibrary(&apos;mswsock.dll&apos;);</div><div>&nbsp;&nbsp;if&nbsp;(hMod&nbsp;=&nbsp;0)&nbsp;then</div><div>&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(PChar(Format(&apos;LoadLibrary(%s)失败！&apos;,&nbsp;[&apos;mswsock.dll&apos;])));</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Exit;</div><div>&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;//得到DOS头</div><div>&nbsp;&nbsp;pDosHeader&nbsp;:=&nbsp;PImageDosHeader(hMod);</div><div>&nbsp;&nbsp;//如果DOS头无效</div><div>&nbsp;&nbsp;if&nbsp;(&nbsp;pDosHeader^.e_magic&nbsp;&lt;&gt;&nbsp;IMAGE_DOS_SIGNATURE&nbsp;)&nbsp;then</div><div>&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Exit;</div><div>&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;//得到NT头</div><div>&nbsp;&nbsp;pNtHeaders&nbsp;:=&nbsp;PImageNtHeaders(hMod&nbsp;+&nbsp;DWORD(pDosHeader^._lfanew));</div><div>&nbsp;&nbsp;//如果NT头无效</div><div>&nbsp;&nbsp;if&nbsp;(&nbsp;pNtHeaders^.Signature&nbsp;&lt;&gt;&nbsp;IMAGE_NT_SIGNATURE&nbsp;)&nbsp;then</div><div>&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Exit;</div><div>&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;//检查输入表数据目录是否存在</div><div>&nbsp;&nbsp;if&nbsp;(pNtHeaders^.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress&nbsp;=&nbsp;0)</div><div>&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;(pNtHeaders^.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].Size&nbsp;=&nbsp;0)&nbsp;then</div><div>&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;Exit;</div><div>&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;//OutputDebugString(PChar(Format(&apos;[HOOK]&nbsp;lock&nbsp;mswsock.dll,&nbsp;waiting&apos;,&nbsp;[])));</div><div><br/></div><div>&nbsp;&nbsp;//得到输入表描述指针</div><div>&nbsp;&nbsp;ImportDescriptor&nbsp;:=&nbsp;PImageImportDescriptor(hMod&nbsp;+&nbsp;pNtHeaders^.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress);</div><div><br/></div><div>&nbsp;&nbsp;//检查每个输入项</div><div>&nbsp;&nbsp;while&nbsp;(ImportDescriptor^.FirstThunk&nbsp;&lt;&gt;&nbsp;0)&nbsp;do</div><div>&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;检查输入表项是否为ntdll.dll</div><div>&nbsp;&nbsp;&nbsp;&nbsp;dll_name&nbsp;:=&nbsp;PAnsiChar(hMod&nbsp;+&nbsp;ImportDescriptor^.Name);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;如果不是，则跳到下一个处理</div><div>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(StrIComp(dll_name,&nbsp;&apos;ntdll.dll&apos;)&nbsp;&lt;&gt;&nbsp;0)&nbsp;then</div><div>&nbsp;&nbsp;&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ImportDescriptor&nbsp;:=&nbsp;PImageImportDescriptor(DWORD(ImportDescriptor)&nbsp;+&nbsp;SizeOf(_IMAGE_IMPORT_DESCRIPTOR));</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Continue;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;&nbsp;&nbsp;ThunkData&nbsp;:=&nbsp;PImageThunkData(hMod&nbsp;+&nbsp;ImportDescriptor^.CharacteristicsOrOriginalFirstThunk);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;iNum&nbsp;:=&nbsp;1;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(ThunkData^.Function_&nbsp;&lt;&gt;&nbsp;0)&nbsp;do</div><div>&nbsp;&nbsp;&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;检查函数是否为NtDeviceIoControlFile</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func_name&nbsp;:=&nbsp;PAnsiChar(hMod&nbsp;+&nbsp;ThunkData^.AddressOfData&nbsp;+&nbsp;2);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//OutputDebugString(PChar(Format(&apos;[HOOK]&nbsp;find&nbsp;API:&nbsp;%s&apos;,&nbsp;[StrPas(func_name)])));</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(StrIComp(func_name&nbsp;,&nbsp;&apos;NtDeviceIoControlFile&apos;)&nbsp;=&nbsp;0)&nbsp;then</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(PChar(Format(&apos;[HOOK]&nbsp;Lock&nbsp;&quot;%s&quot;&nbsp;for&nbsp;HOOK.&apos;,&nbsp;[StrPas(func_name)])));</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;如果是，那么记录原始函数地址</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;HOOK我们的函数地址</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;序号&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RVA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;偏移&nbsp;&nbsp;Name</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;9A&nbsp;&nbsp;D8E3&nbsp;&nbsp;CCE3&nbsp;&nbsp;NtDeviceIoControlFile</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myaddr&nbsp;:=&nbsp;DWORD(@NewNtDeviceIoControlFile);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lpAddr&nbsp;:=&nbsp;Pointer(hMod&nbsp;+&nbsp;ImportDescriptor^.FirstThunk&nbsp;+&nbsp;DWORD(iNum-1)*4);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OldNtDeviceIoControl&nbsp;:=&nbsp;PDWORD(lpAddr)^;</div><div><br/></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(PChar(Format(&apos;[HOOK]&nbsp;Base=%0.8X,&nbsp;Thunk=%0.8X,&nbsp;ID=%X&apos;,&nbsp;[hMod,&nbsp;ImportDescriptor^.FirstThunk,&nbsp;iNum-1])));</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(PChar(Format(&apos;[HOOK]&nbsp;Orign[0x%0.8X]=0x%0.8X,&nbsp;new&nbsp;Addr=0x%0.8X&apos;,&nbsp;[DWORD(lpAddr),&nbsp;PDWORD(lpAddr)^,&nbsp;myaddr])));</div><div><br/></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteProcessMemory(GetCurrentProcess(),&nbsp;lpAddr,&nbsp;@myaddr,&nbsp;4,&nbsp;btw);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exit;</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Inc(iNum);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ThunkData&nbsp;:=&nbsp;PImageThunkData(DWORD(ThunkData)&nbsp;+&nbsp;SizeOf(_IMAGE_THUNK_DATA));</div><div>&nbsp;&nbsp;&nbsp;&nbsp;end;</div><div><br/></div><div>&nbsp;&nbsp;&nbsp;&nbsp;Inc(ImportDescriptor);</div><div>&nbsp;&nbsp;end;</div><div>end;</div><div><br/></div><div>end.</div></en-note>      