{
  "ingest_source": {
    "id": "fdce7b40-18ae-420b-97f5-137763641775",
    "source_type": "evernote_html",
    "source_path": "/Users/tang/workbench/article-classifier/backups/2023年6月/IT技术/openwrt 无线结构 - 华六的博客 - CSDN博客.html",
    "collected_at": "2025-11-09T20:01:35.014122Z",
    "external_id": null,
    "title_hint": null,
    "language_hint": "en",
    "captured_at": null,
    "checksum": "16a8f9be05dc5e6342b93d6434431f38b8b2c8dea89f387cafd511ed5d35cee4",
    "status": "pending",
    "notes": {
      "batch_id": null
    }
  },
  "note": {
    "id": "7e323a2e-1619-443a-8fb8-8f745adf9962",
    "ingest_source_id": "fdce7b40-18ae-420b-97f5-137763641775",
    "canonical_title": "openwrt 无线结构 - 华六的博客 - CSDN博客",
    "language": "en",
    "ingested_at": "2025-11-09T20:01:35.014126Z",
    "created_at": null,
    "status": "active",
    "importance": 0,
    "attributes": {
      "source_filename": "openwrt 无线结构 - 华六的博客 - CSDN博客.html"
    }
  },
  "variants": [
    {
      "id": "0cd9b471-c6aa-425d-bec2-212db043a4a6",
      "note_id": "7e323a2e-1619-443a-8fb8-8f745adf9962",
      "variant_type": "raw_html",
      "version": 1,
      "created_by": "evernote_ingest:v0",
      "created_at": "2025-11-09T20:01:35.014129Z",
      "content": "---\ntitle: openwrt 无线结构 - 华六的博客 - CSDN博客\nupdated: 2018-11-02 08:58:07Z\ncreated: 2018-11-02 08:58:07Z\nsource: https://blog.csdn.net/zimiao815/article/details/55511338\n---\n\n\n<en-note>\n  <div>\n<div STYLE=\"font-size: 16px; display: inline-block;  min-width: 100%;\"><div STYLE=\"background-color:transparent;font:inherit;vertical-align:baseline;\"><div STYLE=\"font-family:&quot;PT Serif&quot;;font-size:16px;line-height:1.5em;color:rgb(31, 9, 9);text-align:left;background-color:transparent;font:inherit;vertical-align:baseline;\"><div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\"><div STYLE=\"width:36em;z-index:200;padding-left:2em;padding-right:2em;margin-left:auto;margin-right:auto;position:relative;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\"><div STYLE=\"position:relative;margin-left:-25px;margin-right:25px;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\"><div STYLE=\"padding-top:4.5em;padding-bottom:9em;position:relative;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\"><div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"><div STYLE=\"margin-bottom:0px;position:relative;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\"><div STYLE=\"margin-bottom:0px;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\"><div STYLE=\"margin-bottom:0px;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\"><h1 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;padding:0px;margin:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:normal;font-size:35px;line-height:35px;margin-bottom:20px;\">openwrt 无线结构</h1><div STYLE=\"margin-bottom:0px;position:relative;margin:0px;height:1em;line-height:1;text-align:center;padding:0px;border:0px;font:inherit;vertical-align:baseline;padding-top:1.5em;padding-bottom:1.5em;\"><div STYLE=\"background:-webkit-linear-gradient(0deg, rgb(243, 242, 238) 1%, rgb(31, 9, 9) 50%, rgb(243, 242, 238) 99%);margin-bottom:0px;position:absolute;left:-4em;top:50%;z-index:10;width:100%;padding-left:4em;padding-right:4em;height:0.1em;margin:0px;opacity:0.5;padding:0px;border:0px;font:inherit;vertical-align:baseline;\"><span STYLE=\"font:inherit;background:-webkit-linear-gradient(0deg, rgb(243, 242, 238) 1%, rgb(31, 9, 9) 50%, rgb(243, 242, 238) 99%);position:absolute;left:-4em;top:50%;z-index:10;width:100%;padding-left:4em;padding-right:4em;height:0.1em;margin:0px;opacity:0.5;\"></span></div></div></div>\n&Tab;&Tab;&Tab;<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n&Tab;&Tab;&Tab;&Tab;<div STYLE=\"margin-bottom:0px;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\">\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;2017年02月17日 15:49:34\n&Tab;&Tab;&Tab;&Tab;&Tab;<a HREF=\"https://me.csdn.net/zimiao815\" TARGET=\"_blank\" STYLE=\"color:rgb(6, 85, 136);margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;text-decoration:none;\">子妙815</a>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;阅读数：1175\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;</div>\n&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;</div>\n&Tab;&Tab;\n&Tab;\n&Tab;<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;display:block;\">\n&Tab;&Tab;<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;            \n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<div STYLE=\"margin-bottom:0px;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\">\n                \n<h2 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">转载有道：http://blog.csdn.net/myarrow/article/details/9274443#<br/>\n</h2>\n<h2 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">1. &nbsp;无线网络驱动(ath9k_htc)</h2>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp;ath9k_htc是一个基于USB接口的SoftMAC无线网络适配器。为了其驱动能正常工作，首先必须调用usb_register来注册驱动定义的usb_driver，以借助USB Core的力量来处理与USB协议相关的事件。其代码如下：</p>\n<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n\n<ol STYLE=\"margin:0px 0px 1.5em 1.5em;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style:decimal outside none;list-style-type:decimal;\">\n<li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstaticstruct&nbsp;usb_driver&nbsp;ath9k_hif_usb_driver&nbsp;=&nbsp;{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.name&nbsp;=&nbsp;KBUILD_MODNAME,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.probe&nbsp;=&nbsp;ath9k_hif_usb_probe,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.disconnect&nbsp;=&nbsp;ath9k_hif_usb_disconnect,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n#ifdef&nbsp;CONFIG_PM</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.suspend&nbsp;=&nbsp;ath9k_hif_usb_suspend,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.resume&nbsp;=&nbsp;ath9k_hif_usb_resume,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.reset_resume&nbsp;=&nbsp;ath9k_hif_usb_resume,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n#endif</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.id_table&nbsp;=&nbsp;ath9k_hif_usb_ids,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.soft_unbind&nbsp;=&nbsp;1,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n};&nbsp;&nbsp;</li></ol>\n</div>\n<h2 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">2. 关键数据结构</h2>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">1)&nbsp;struct ieee80211_hw: 它包含802.11 PHY的<strong STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;\">配置</strong>和<strong STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;\">硬件</strong>信息。</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p><div STYLE=\"display:block;text-align:center;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1em;margin-top:1em;\"><img src=\"../_resources/SouthEast-1\"  type=\"image/png\" hash=\"4fd9e06eaac96ec057013674a53b59c5\" width=\"472\" height=\"469\" style=\"display:block;max-width:100%;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\" alt=\"SouthEast\" /></en-media></div><p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p>\n<h3 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:normal;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">2.1 各层间关键数据接口</h3>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p><div STYLE=\"display:block;text-align:center;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1em;margin-top:1em;\"><img src=\"../_resources/SouthEast\"  type=\"image/png\" hash=\"0059a7398707f6826daa279c66a58fc9\" width=\"466\" height=\"650\" style=\"display:block;max-width:100%;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\" alt=\"SouthEast\" /></en-media></div><p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p>\n<h2 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">3. USB无线适配器枚举过程&nbsp;</h2>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp;当此基于USB接口的无线网络适配器被枚举时，ath9k_hif_usb_probe将被调用。其调用流程如下图所示：</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p><div STYLE=\"display:block;text-align:center;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1em;margin-top:1em;\"><img src=\"../_resources/SouthEast-7\"  type=\"image/png\" hash=\"e69200e2370ce1e12234dbc75391cb12\" width=\"557\" height=\"527\" style=\"display:block;max-width:100%;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\" alt=\"SouthEast\" /></en-media></div><p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p>\n<h3 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:normal;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">3.1 struct ieee80211_ops 实例 ath9k_htc_ops(驱动实现)</h3>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp; &nbsp;ath9k_htc_ops: mac80211通过这些回调函数回调driver的处理函数。ath9k_htc为了接受mac80211的管理，它必须首先向mac80211注册，以申明自己的存在，从而可以接受mac80211的调用。</p>\n<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n\n<ol STYLE=\"margin:0px 0px 1.5em 1.5em;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style:decimal outside none;list-style-type:decimal;\">\n<li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstruct&nbsp;ieee80211_ops&nbsp;ath9k_htc_ops&nbsp;=&nbsp;{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.tx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_tx,&nbsp;&nbsp;//&nbsp;发送mac80211要求发送的帧</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_start,&nbsp;//&nbsp;第一个被attach到此硬件的net_device被enable之前被调用,之后，可以接收帧数据</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.stop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_stop,&nbsp;&nbsp;//&nbsp;最后一个被attach到此硬件的net_device被disable之后被调用,之后，不可以接收帧数据</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.add_interface&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_add_interface,&nbsp;//&nbsp;当一个被attach到此硬件的net_device被enable时被调用</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.remove_interface&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_remove_interface,&nbsp;//&nbsp;通知driver一个接口将要going&nbsp;down</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.config&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_config,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;mac802.11调用它修改硬件配置</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.configure_filter&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_configure_filter,&nbsp;//&nbsp;配置设备的接收过滤器</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.sta_add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_sta_add,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.sta_remove&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_sta_remove,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.conf_tx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_conf_tx,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.bss_info_changed&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_bss_info_changed,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_key&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_set_key,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.get_tsf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_get_tsf,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_tsf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_set_tsf,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.reset_tsf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_reset_tsf,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.ampdu_action&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_ampdu_action,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.sw_scan_start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_sw_scan_start,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.sw_scan_complete&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_sw_scan_complete,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_rts_threshold&nbsp;&nbsp;=&nbsp;ath9k_htc_set_rts_threshold,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.rfkill_poll&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_rfkill_poll_state,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_coverage_class&nbsp;=&nbsp;ath9k_htc_set_coverage_class,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_bitrate_mask&nbsp;&nbsp;&nbsp;=&nbsp;ath9k_htc_set_bitrate_mask,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n};&nbsp;&nbsp;</li></ol>\n</div>\n<h3 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:normal;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">3.2&nbsp;struct cfg80211_ops 实例 mac80211_config_ops(mac80211实现)&nbsp;&nbsp;</h3>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp;cfg80211_ops定义了无线配置的操作，在它的增加虚拟接口(ieee80211_add_iface)中，它将创建并注册net_device。在mac80211中，其定义如下所示：</p>\n<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n\n<ol STYLE=\"margin:0px 0px 1.5em 1.5em;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style:decimal outside none;list-style-type:decimal;\">\n<li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstruct&nbsp;cfg80211_ops&nbsp;mac80211_config_ops&nbsp;=&nbsp;{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.add_virtual_intf&nbsp;=&nbsp;ieee80211_add_iface,&nbsp;//使用给定的名字创建一个&quot;虚拟接口&quot;,在wiphy的命名空间中创建net_device并返回</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.del_virtual_intf&nbsp;=&nbsp;ieee80211_del_iface,&nbsp;//删除由ifindex指定的&quot;虚拟接口&quot;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.change_virtual_intf&nbsp;=&nbsp;ieee80211_change_iface,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.add_key&nbsp;=&nbsp;ieee80211_add_key,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.del_key&nbsp;=&nbsp;ieee80211_del_key,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.get_key&nbsp;=&nbsp;ieee80211_get_key,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_default_key&nbsp;=&nbsp;ieee80211_config_default_key,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_default_mgmt_key&nbsp;=&nbsp;ieee80211_config_default_mgmt_key,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.add_beacon&nbsp;=&nbsp;ieee80211_add_beacon,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_beacon&nbsp;=&nbsp;ieee80211_set_beacon,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.del_beacon&nbsp;=&nbsp;ieee80211_del_beacon,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.add_station&nbsp;=&nbsp;ieee80211_add_station,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.del_station&nbsp;=&nbsp;ieee80211_del_station,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.change_station&nbsp;=&nbsp;ieee80211_change_station,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.get_station&nbsp;=&nbsp;ieee80211_get_station,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.dump_station&nbsp;=&nbsp;ieee80211_dump_station,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.dump_survey&nbsp;=&nbsp;ieee80211_dump_survey,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n#ifdef&nbsp;CONFIG_MAC80211_MESH</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.add_mpath&nbsp;=&nbsp;ieee80211_add_mpath,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.del_mpath&nbsp;=&nbsp;ieee80211_del_mpath,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.change_mpath&nbsp;=&nbsp;ieee80211_change_mpath,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.get_mpath&nbsp;=&nbsp;ieee80211_get_mpath,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.dump_mpath&nbsp;=&nbsp;ieee80211_dump_mpath,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.update_mesh_config&nbsp;=&nbsp;ieee80211_update_mesh_config,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.get_mesh_config&nbsp;=&nbsp;ieee80211_get_mesh_config,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.join_mesh&nbsp;=&nbsp;ieee80211_join_mesh,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.leave_mesh&nbsp;=&nbsp;ieee80211_leave_mesh,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n#endif</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.change_bss&nbsp;=&nbsp;ieee80211_change_bss,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_txq_params&nbsp;=&nbsp;ieee80211_set_txq_params,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_channel&nbsp;=&nbsp;ieee80211_set_channel,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.suspend&nbsp;=&nbsp;ieee80211_suspend,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.resume&nbsp;=&nbsp;ieee80211_resume,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.scan&nbsp;=&nbsp;ieee80211_scan,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.sched_scan_start&nbsp;=&nbsp;ieee80211_sched_scan_start,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.sched_scan_stop&nbsp;=&nbsp;ieee80211_sched_scan_stop,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.auth&nbsp;=&nbsp;ieee80211_auth,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.assoc&nbsp;=&nbsp;ieee80211_assoc,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.deauth&nbsp;=&nbsp;ieee80211_deauth,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.disassoc&nbsp;=&nbsp;ieee80211_disassoc,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.join_ibss&nbsp;=&nbsp;ieee80211_join_ibss,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.leave_ibss&nbsp;=&nbsp;ieee80211_leave_ibss,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_wiphy_params&nbsp;=&nbsp;ieee80211_set_wiphy_params,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_tx_power&nbsp;=&nbsp;ieee80211_set_tx_power,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.get_tx_power&nbsp;=&nbsp;ieee80211_get_tx_power,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_wds_peer&nbsp;=&nbsp;ieee80211_set_wds_peer,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.rfkill_poll&nbsp;=&nbsp;ieee80211_rfkill_poll,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;CFG80211_TESTMODE_CMD(ieee80211_testmode_cmd)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_power_mgmt&nbsp;=&nbsp;ieee80211_set_power_mgmt,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_bitrate_mask&nbsp;=&nbsp;ieee80211_set_bitrate_mask,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.remain_on_channel&nbsp;=&nbsp;ieee80211_remain_on_channel,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.cancel_remain_on_channel&nbsp;=&nbsp;ieee80211_cancel_remain_on_channel,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.mgmt_tx&nbsp;=&nbsp;ieee80211_mgmt_tx,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.mgmt_tx_cancel_wait&nbsp;=&nbsp;ieee80211_mgmt_tx_cancel_wait,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_cqm_rssi_config&nbsp;=&nbsp;ieee80211_set_cqm_rssi_config,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.mgmt_frame_register&nbsp;=&nbsp;ieee80211_mgmt_frame_register,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_antenna&nbsp;=&nbsp;ieee80211_set_antenna,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.get_antenna&nbsp;=&nbsp;ieee80211_get_antenna,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.set_ringparam&nbsp;=&nbsp;ieee80211_set_ringparam,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.get_ringparam&nbsp;=&nbsp;ieee80211_get_ringparam,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n}&nbsp;&nbsp;</li></ol>\n</div>\n<h3 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:normal;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">3.3&nbsp;struct iw_handler_def &nbsp;实例 cfg80211_wext_handler(wireless实现)</h3>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp; cfg80211_wext_handler实现了wext要求的ioctl操作，将通过net_device-&gt;wireless_handlers-&gt;standard[ioctl cmd- SIOCIWFIRST]来进行调用。在net/wireless/wext-compat.c中的定义如下所示：</p>\n<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n\n<ol STYLE=\"margin:0px 0px 1.5em 1.5em;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style:decimal outside none;list-style-type:decimal;\">\n<li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstaticconst&nbsp;iw_handler&nbsp;cfg80211_handlers[]&nbsp;=&nbsp;{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWNAME)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwname,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWFREQ)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwfreq,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWFREQ)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwfreq,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWMODE)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwmode,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWMODE)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwmode,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWRANGE)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwrange,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWAP)]&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwap,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWAP)]&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwap,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWMLME)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwmlme,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWSCAN)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwscan,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWSCAN)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwscan,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWESSID)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwessid,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWESSID)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwessid,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWRATE)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwrate,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWRATE)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwrate,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWRTS)]&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwrts,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWRTS)]&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwrts,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWFRAG)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwfrag,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWFRAG)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwfrag,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWTXPOW)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwtxpower,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWTXPOW)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwtxpower,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWRETRY)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwretry,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWRETRY)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwretry,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWENCODE)]&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwencode,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWENCODE)]&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwencode,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWPOWER)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwpower,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWPOWER)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwpower,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWGENIE)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwgenie,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWAUTH)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwauth,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCGIWAUTH)]&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_giwauth,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWENCODEEXT)]=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwencodeext,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWPMKSA)]&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;(iw_handler)&nbsp;cfg80211_wext_siwpmksa,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;[IW_IOCTL_IDX(SIOCSIWPRIV)]&nbsp;=&nbsp;(iw_handler)cfg80211_wext_setpriv&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n};&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nconststruct&nbsp;iw_handler_def&nbsp;cfg80211_wext_handler&nbsp;=&nbsp;{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.num_standard&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ARRAY_SIZE(cfg80211_handlers),&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.standard&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;cfg80211_handlers,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.get_wireless_stats&nbsp;=&nbsp;cfg80211_wireless_stats,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n}&nbsp;&nbsp;</li></ol>\n</div>\n<h2 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">4. 创建并注册net_device</h2>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;当执行mac80211_config_ops-&gt;&nbsp;ieee80211_add_iface时，它将创建net_device和对应的ieee80211_sub_if_data, 然后主要做了以下几件事：</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp; &nbsp; 1) 把net_device对应的名字增加到/sys/class/net/目录下 &nbsp;&nbsp;</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp; &nbsp; 2) 把新创建的net_device插入到init_net-&gt;dev_base_head中</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp; &nbsp; 3) 通知上层协议，有一个新的net_device出现了，大家可以使用它了</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp; &nbsp; 4) 把新创建的ieee80211_sub_if_data增加到ieee80211_local的interfaces列表中</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp; &nbsp; 其流程如下图所示：</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p><div STYLE=\"display:block;text-align:center;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1em;margin-top:1em;\"><img src=\"../_resources/SouthEast-2\"  type=\"image/png\" hash=\"86dcfbdceb141bc36816e81c7b4de625\" width=\"532\" height=\"542\" style=\"display:block;max-width:100%;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\" alt=\"SouthEast\" /></en-media></div><p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp; &nbsp; mac80211中定义的net_device_ops ieee80211_dataif_ops，以下这些方法，都有一个struct net_device参数。其具体定义如下：</p>\n<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n\n<ol STYLE=\"margin:0px 0px 1.5em 1.5em;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style:decimal outside none;list-style-type:decimal;\">\n<li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstaticconststruct&nbsp;net_device_ops&nbsp;ieee80211_dataif_ops&nbsp;=&nbsp;{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.ndo_open&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ieee80211_open,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;net_device变换到&nbsp;UP&nbsp;时被调用</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.ndo_stop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ieee80211_stop,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;net_device变换到&nbsp;Down&nbsp;时被调用</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.ndo_uninit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ieee80211_teardown_sdata,&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;取消注册或注册失败时调用</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.ndo_start_xmit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ieee80211_subif_start_xmit,&nbsp;&nbsp;//&nbsp;需要发送包时被调用</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.ndo_set_multicast_list&nbsp;=&nbsp;ieee80211_set_multicast_list,//&nbsp;多播地址列表变化时被调用</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.ndo_change_mtu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ieee80211_change_mtu,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;当用户想改变一个设备的MTU时被调用</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.ndo_set_mac_address&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;ieee80211_change_mac,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;mac地址需要改变时被调用</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.ndo_select_queue&nbsp;&nbsp;&nbsp;=&nbsp;ieee80211_netdev_select_queue,&nbsp;//当net_device支持多个发送队列时，用来决定使用哪个队列</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n};&nbsp;&nbsp;</li></ol>\n</div>\nmac80211中初始化net_device-&gt;netdev_ops:\n<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n\n<ol STYLE=\"margin:0px 0px 1.5em 1.5em;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style:decimal outside none;list-style-type:decimal;\">\n<li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstaticvoid&nbsp;ieee80211_if_setup(struct&nbsp;net_device&nbsp;*dev)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;ether_setup(dev);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;dev-&gt;priv_flags&nbsp;&amp;=&nbsp;~IFF_TX_SKB_SHARING;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;dev-&gt;netdev_ops&nbsp;=&nbsp;&amp;ieee80211_dataif_ops;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;dev-&gt;destructor&nbsp;=&nbsp;free_netdev;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n}&nbsp;&nbsp;</li></ol>\n</div>\n<h2 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">5. 数据接收(Data RX)流程</h2>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp;数据接收流程如下图所示：</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p><div STYLE=\"display:block;text-align:center;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1em;margin-top:1em;\"><img src=\"../_resources/SouthEast-5\"  type=\"image/png\" hash=\"c6735034bd2b37c52a32f74b60ca3f18\" width=\"423\" height=\"699\" style=\"display:block;max-width:100%;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\" alt=\"SouthEast\" /></en-media></div><p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">IP层与TCP/UDP层接口定义如下：</p>\n<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n\n<ol STYLE=\"margin:0px 0px 1.5em 1.5em;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style:decimal outside none;list-style-type:decimal;\">\n<li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstaticconststruct&nbsp;net_protocol&nbsp;tcp_protocol&nbsp;=&nbsp;{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.handler&nbsp;=&nbsp;&nbsp;tcp_v4_rcv,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.err_handler&nbsp;=&nbsp;&nbsp;tcp_v4_err,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.gso_send_check&nbsp;=&nbsp;tcp_v4_gso_send_check,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.gso_segment&nbsp;=&nbsp;&nbsp;tcp_tso_segment,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.gro_receive&nbsp;=&nbsp;&nbsp;tcp4_gro_receive,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.gro_complete&nbsp;=&nbsp;tcp4_gro_complete,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.no_policy&nbsp;=&nbsp;&nbsp;&nbsp;&nbsp;1,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.netns_ok&nbsp;=&nbsp;1,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n};&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstaticconststruct&nbsp;net_protocol&nbsp;udp_protocol&nbsp;=&nbsp;{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.handler&nbsp;=&nbsp;&nbsp;udp_rcv,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.err_handler&nbsp;=&nbsp;&nbsp;udp_err,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.gso_send_check&nbsp;=&nbsp;udp4_ufo_send_check,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.gso_segment&nbsp;=&nbsp;udp4_ufo_fragment,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.no_policy&nbsp;=&nbsp;&nbsp;&nbsp;&nbsp;1,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.netns_ok&nbsp;=&nbsp;1,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n};&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstaticconststruct&nbsp;net_protocol&nbsp;icmp_protocol&nbsp;=&nbsp;{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.handler&nbsp;=&nbsp;&nbsp;icmp_rcv,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.err_handler&nbsp;=&nbsp;&nbsp;ping_err,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.no_policy&nbsp;=&nbsp;&nbsp;&nbsp;&nbsp;1,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.netns_ok&nbsp;=&nbsp;1,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n};&nbsp;&nbsp;</li></ol>\n</div>\nIP层与net/core层接口定义如下：\n<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n\n<ol STYLE=\"margin:0px 0px 1.5em 1.5em;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style:decimal outside none;list-style-type:decimal;\">\n<li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstaticstruct&nbsp;packet_type&nbsp;ip_packet_type&nbsp;__read_mostly&nbsp;=&nbsp;{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.type&nbsp;=&nbsp;cpu_to_be16(ETH_P_IP),&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.func&nbsp;=&nbsp;ip_rcv,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.gso_send_check&nbsp;=&nbsp;inet_gso_send_check,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.gso_segment&nbsp;=&nbsp;inet_gso_segment,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.gro_receive&nbsp;=&nbsp;inet_gro_receive,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;.gro_complete&nbsp;=&nbsp;inet_gro_complete,&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n};&nbsp;&nbsp;</li></ol>\n</div>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p><div STYLE=\"display:block;text-align:center;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1em;margin-top:1em;\"><img src=\"../_resources/SouthEast-3\"  type=\"image/png\" hash=\"b8a30921db1a0b9864ccbe3bab0529a0\" width=\"512\" height=\"812\" style=\"display:block;max-width:100%;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\" alt=\"SouthEast\" /></en-media></div><p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">接收下半部stack如下所示：</p>\n<div STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">\n\n<ol STYLE=\"margin:0px 0px 1.5em 1.5em;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style:decimal outside none;list-style-type:decimal;\">\n<li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646628]&nbsp;[&lt;c07d8b24&gt;]&nbsp;(tcp_rcv_established+0x648/0x9b0)&nbsp;from&nbsp;[&lt;c07e04cc&gt;]&nbsp;(tcp_v4_do_rcv+0x74/0x2a8)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646661]&nbsp;[&lt;c07e04cc&gt;]&nbsp;(tcp_v4_do_rcv+0x74/0x2a8)&nbsp;from&nbsp;[&lt;c07e0c40&gt;]&nbsp;(tcp_v4_rcv+0x540/0x908)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646678]&nbsp;[&lt;c07e0c40&gt;]&nbsp;(tcp_v4_rcv+0x540/0x908)&nbsp;from&nbsp;[&lt;c07c23d4&gt;]&nbsp;(ip_local_deliver_finish+0x158/0x318)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646694]&nbsp;[&lt;c07c23d4&gt;]&nbsp;(ip_local_deliver_finish+0x158/0x318)&nbsp;from&nbsp;[&lt;c07c1e44&gt;]&nbsp;(ip_rcv_finish+0x420/0x440)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646715]&nbsp;[&lt;c07c1e44&gt;]&nbsp;(ip_rcv_finish+0x420/0x440)&nbsp;from&nbsp;[&lt;c0772dcc&gt;]&nbsp;(__netif_receive_skb+0x4d0/0x534)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646730]&nbsp;[&lt;c0772dcc&gt;]&nbsp;(__netif_receive_skb+0x4d0/0x534)&nbsp;from&nbsp;[&lt;c0774434&gt;]&nbsp;(netif_receive_skb+0x9c/0xb4)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646752]&nbsp;[&lt;c0774434&gt;]&nbsp;(netif_receive_skb+0x9c/0xb4)&nbsp;from&nbsp;[&lt;c08b8e6c&gt;]&nbsp;(ieee80211_deliver_skb+0x134/0x164)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646769]&nbsp;[&lt;c08b8e6c&gt;]&nbsp;(ieee80211_deliver_skb+0x134/0x164)&nbsp;from&nbsp;[&lt;c08b9ed8&gt;]&nbsp;(ieee80211_rx_handlers+0x103c/0x1978)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646785]&nbsp;[&lt;c08b9ed8&gt;]&nbsp;(ieee80211_rx_handlers+0x103c/0x1978)&nbsp;from&nbsp;[&lt;c08baf10&gt;]&nbsp;(ieee80211_prepare_and_rx_handle+0x6fc/0x788)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646802]&nbsp;[&lt;c08baf10&gt;]&nbsp;(ieee80211_prepare_and_rx_handle+0x6fc/0x788)&nbsp;from&nbsp;[&lt;c08bb920&gt;]&nbsp;(ieee80211_rx+0x908/0x988)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646819]&nbsp;[&lt;c08bb920&gt;]&nbsp;(ieee80211_rx+0x908/0x988)&nbsp;from&nbsp;[&lt;c068a578&gt;]&nbsp;(ath9k_rx_tasklet+0x4e4/0x54c)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646835]&nbsp;[&lt;c068a578&gt;]&nbsp;(ath9k_rx_tasklet+0x4e4/0x54c)&nbsp;from&nbsp;[&lt;c0467d98&gt;]&nbsp;(tasklet_action+0xa8/0x14c)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646850]&nbsp;[&lt;c0467d98&gt;]&nbsp;(tasklet_action+0xa8/0x14c)&nbsp;from&nbsp;[&lt;c0468144&gt;]&nbsp;(__do_softirq+0x88/0x158)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646863]&nbsp;[&lt;c0468144&gt;]&nbsp;(__do_softirq+0x88/0x158)&nbsp;from&nbsp;[&lt;c0468414&gt;]&nbsp;(irq_exit+0x48/0xac)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646882]&nbsp;[&lt;c0468414&gt;]&nbsp;(irq_exit+0x48/0xac)&nbsp;from&nbsp;[&lt;c04313c0&gt;]&nbsp;(do_local_timer+0x50/0x80)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n[&nbsp;&nbsp;336.646898]&nbsp;[&lt;c04313c0&gt;]&nbsp;(do_local_timer+0x50/0x80)&nbsp;from&nbsp;[&lt;c0436708&gt;]&nbsp;(__irq_svc+0x48/0xe0)&nbsp;&nbsp;</li></ol>\n</div>\n<h2 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">6. 数据发送(Data TX)流珵</h2>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp;数据发送流程如下图所示：</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p><div STYLE=\"display:block;text-align:center;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1em;margin-top:1em;\"><img src=\"../_resources/SouthEast-6\"  type=\"image/png\" hash=\"cf8d2588e0c3b6337f8fd908ecc43825\" width=\"384\" height=\"632\" style=\"display:block;max-width:100%;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\" alt=\"SouthEast\" /></en-media></div><p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p><div STYLE=\"display:block;text-align:center;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1em;margin-top:1em;\"><img src=\"../_resources/SouthEast-4\"  type=\"image/png\" hash=\"bb5d5500b401ccad646a63ccfb5f49cc\" width=\"467\" height=\"767\" style=\"display:block;max-width:100%;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\" alt=\"SouthEast\" /></en-media></div><p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\"></p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">上半部分涉及到的相关代码如下所示（以上流程主要通过dump_stack获取）：</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; &nbsp;net/socket.c<br/>\n&nbsp; &nbsp; &nbsp;net/ipv4/af_net.c<br/>\n&nbsp; &nbsp; &nbsp;net/ipv4/tcp.c<br/>\n&nbsp; &nbsp; &nbsp;net/ipv4/tcp_output.c<br/>\n&nbsp; &nbsp; &nbsp;net/ipv4/ip_output.c<br/>\n&nbsp; &nbsp; &nbsp;net/core/neighbour.c<br/>\n&nbsp; &nbsp; &nbsp;net/core/dev.c</p>\n<h2 STYLE=\"font-family:&quot;PT Serif&quot;;text-align:left;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;font-weight:bold;font-size:30px;line-height:35px;margin-top:35px;margin-bottom:15px;\">7. INET初始化</h2>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; INET为<a HREF=\"http://lib.csdn.net/base/linux\" TITLE=\"Linux知识库\" TARGET=\"_blank\" STYLE=\"color:rgb(6, 85, 136);margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;text-decoration:none;\">Linux</a>&nbsp;OS实现了TCP/IP协议集，它使用BSD\n Socket接口作为与User通讯的方式。其初始化代码如下所示：</p>\n<p STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">&nbsp; &nbsp; 代码位于：net/ipv4/af_inet.c。</p>\n<div STYLE=\"margin-bottom:0px;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\">\n\n<ol STYLE=\"margin:0px 0px 1.5em 1.5em;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style:decimal outside none;list-style-type:decimal;\">\n<li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nstaticint&nbsp;__init&nbsp;inet_init(void)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n{&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;sk_buff&nbsp;*dummy_skb;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;inet_protosw&nbsp;*q;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;list_head&nbsp;*r;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;rc&nbsp;=&nbsp;-EINVAL;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;BUILD_BUG_ON(sizeof(struct&nbsp;inet_skb_parm)&nbsp;&gt;&nbsp;sizeof(dummy_skb-&gt;cb));&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;sysctl_local_reserved_ports&nbsp;=&nbsp;kzalloc(65536&nbsp;/&nbsp;8,&nbsp;GFP_KERNEL);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!sysctl_local_reserved_ports)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;out;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;proto_register(&amp;tcp_prot,&nbsp;1);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rc)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;out_free_reserved_ports;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;proto_register(&amp;udp_prot,&nbsp;1);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rc)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;out_unregister_tcp_proto;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;proto_register(&amp;raw_prot,&nbsp;1);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rc)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;out_unregister_udp_proto;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;proto_register(&amp;ping_prot,&nbsp;1);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(rc)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;out_unregister_raw_proto;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Tell&nbsp;SOCKET&nbsp;that&nbsp;we&nbsp;are&nbsp;alive...&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;(void)sock_register(&amp;inet_family_ops);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n#ifdef&nbsp;CONFIG_SYSCTL</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;ip_static_sysctl_init();&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n#endif</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Add&nbsp;all&nbsp;the&nbsp;base&nbsp;protocols.&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(inet_add_protocol(&amp;icmp_protocol,&nbsp;IPPROTO_ICMP)&nbsp;&lt;&nbsp;0)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk(KERN_CRIT&nbsp;&quot;inet_init:&nbsp;Cannot&nbsp;add&nbsp;ICMP&nbsp;protocol\\n&quot;);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(inet_add_protocol(&amp;udp_protocol,&nbsp;IPPROTO_UDP)&nbsp;&lt;&nbsp;0)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk(KERN_CRIT&nbsp;&quot;inet_init:&nbsp;Cannot&nbsp;add&nbsp;UDP&nbsp;protocol\\n&quot;);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(inet_add_protocol(&amp;tcp_protocol,&nbsp;IPPROTO_TCP)&nbsp;&lt;&nbsp;0)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk(KERN_CRIT&nbsp;&quot;inet_init:&nbsp;Cannot&nbsp;add&nbsp;TCP&nbsp;protocol\\n&quot;);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n#ifdef&nbsp;CONFIG_IP_MULTICAST</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(inet_add_protocol(&amp;igmp_protocol,&nbsp;IPPROTO_IGMP)&nbsp;&lt;&nbsp;0)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk(KERN_CRIT&nbsp;&quot;inet_init:&nbsp;Cannot&nbsp;add&nbsp;IGMP&nbsp;protocol\\n&quot;);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n#endif</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Register&nbsp;the&nbsp;socket-side&nbsp;information&nbsp;for&nbsp;inet_create.&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(r&nbsp;=&nbsp;&amp;inetsw[0];&nbsp;r&nbsp;&lt;&nbsp;&amp;inetsw[SOCK_MAX];&nbsp;++r)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INIT_LIST_HEAD(r);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(q&nbsp;=&nbsp;inetsw_array;&nbsp;q&nbsp;&lt;&nbsp;&amp;inetsw_array[INETSW_ARRAY_LEN];&nbsp;++q)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet_register_protosw(q);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Set&nbsp;the&nbsp;ARP&nbsp;module&nbsp;up&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;arp_init();&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Set&nbsp;the&nbsp;IP&nbsp;module&nbsp;up&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;ip_init();&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;tcp_v4_init();&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Setup&nbsp;TCP&nbsp;slab&nbsp;cache&nbsp;for&nbsp;open&nbsp;requests.&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;tcp_init();&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Setup&nbsp;UDP&nbsp;memory&nbsp;threshold&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;udp_init();&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Add&nbsp;UDP-Lite&nbsp;(RFC&nbsp;3828)&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;udplite4_register();&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;ping_init();&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Set&nbsp;the&nbsp;ICMP&nbsp;layer&nbsp;up&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(icmp_init()&nbsp;&lt;&nbsp;0)&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panic(&quot;Failed&nbsp;to&nbsp;create&nbsp;the&nbsp;ICMP&nbsp;control&nbsp;socket.\\n&quot;);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Initialise&nbsp;the&nbsp;multicast&nbsp;router&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n#if&nbsp;defined(CONFIG_IP_MROUTE)</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ip_mr_init())&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk(KERN_CRIT&nbsp;&quot;inet_init:&nbsp;Cannot&nbsp;init&nbsp;ipv4&nbsp;mroute\\n&quot;);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n#endif</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&nbsp;Initialise&nbsp;per-cpu&nbsp;ipv4&nbsp;mibs&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(init_ipv4_mibs())&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printk(KERN_CRIT&nbsp;&quot;inet_init:&nbsp;Cannot&nbsp;init&nbsp;ipv4&nbsp;mibs\\n&quot;);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;ipv4_proc_init();&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;ipfrag_init();&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;dev_add_pack(&amp;ip_packet_type);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;rc&nbsp;=&nbsp;0;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nout:&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;rc;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nout_unregister_raw_proto:&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;proto_unregister(&amp;raw_prot);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nout_unregister_udp_proto:&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;proto_unregister(&amp;udp_prot);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nout_unregister_tcp_proto:&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;proto_unregister(&amp;tcp_prot);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\nout_free_reserved_ports:&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;kfree(sysctl_local_reserved_ports);&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;out;&nbsp;&nbsp;</li><li STYLE=\"margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;list-style-type:inherit;list-style-position:outside;\">\n} &nbsp;</li></ol>\n</div>\n            </div>\n                </div>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<div STYLE=\"margin-bottom:0px;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\">\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<a TARGET=\"_blank\" STYLE=\"color:rgb(6, 85, 136);margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;text-decoration:none;\">阅读更多</a>\n&Tab;&Tab;&Tab;&Tab;&Tab;</div>\n&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;</div>\n&Tab;\n</div></div></div><div STYLE=\"position:absolute;top:-1000px;left:-1000px;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;margin-bottom:1.5em;\">Measure</div><div STYLE=\"margin-bottom:0px;position:absolute;top:-1000px;left:-1000px;line-height:1;margin:0px;padding:0px;border:0px;font:inherit;vertical-align:baseline;\">Measure</div></div></div></div></div></div></div></div>\n</div>\n</en-note>      ",
      "content_path": null,
      "diff_base_variant_id": null,
      "metadata": {
        "checksum": "16a8f9be05dc5e6342b93d6434431f38b8b2c8dea89f387cafd511ed5d35cee4",
        "path": "/Users/tang/workbench/article-classifier/backups/2023年6月/IT技术/openwrt 无线结构 - 华六的博客 - CSDN博客.html"
      }
    },
    {
      "id": "3b5c7629-2a4f-4af5-8244-2dc724126adf",
      "note_id": "7e323a2e-1619-443a-8fb8-8f745adf9962",
      "variant_type": "clean_text",
      "version": 1,
      "created_by": "evernote_ingest:v0",
      "created_at": "2025-11-09T20:01:35.014132Z",
      "content": "---\ntitle: openwrt 无线结构 - 华六的博客 - CSDN博客\nupdated: 2018-11-02 08:58:07Z\ncreated: 2018-11-02 08:58:07Z\nsource: https://blog.csdn.net/zimiao815/article/details/55511338\n---\n\nopenwrt 无线结构\n\n 2017年02月17日 15:49:34\n\n子妙815\n\n 阅读数：1175\n\n转载有道：http://blog.csdn.net/myarrow/article/details/9274443#\n\n1.  无线网络驱动(ath9k_htc)\n\n     ath9k_htc是一个基于USB接口的SoftMAC无线网络适配器。为了其驱动能正常工作，首先必须调用usb_register来注册驱动定义的usb_driver，以借助USB Core的力量来处理与USB协议相关的事件。其代码如下：\n\nstaticstruct usb_driver ath9k_hif_usb_driver = {  \n\n    .name = KBUILD_MODNAME,  \n\n    .probe = ath9k_hif_usb_probe,  \n\n    .disconnect = ath9k_hif_usb_disconnect,  \n\n#ifdef CONFIG_PM\n\n    .suspend = ath9k_hif_usb_suspend,  \n\n    .resume = ath9k_hif_usb_resume,  \n\n    .reset_resume = ath9k_hif_usb_resume,  \n\n    .id_table = ath9k_hif_usb_ids,  \n\n    .soft_unbind = 1,  \n\n};  \n\n2. 关键数据结构\n\n1) struct ieee80211_hw: 它包含802.11 PHY的\n配置\n和\n硬件\n信息。\n\n2.1 各层间关键数据接口\n\n3. USB无线适配器枚举过程 \n\n     当此基于USB接口的无线网络适配器被枚举时，ath9k_hif_usb_probe将被调用。其调用流程如下图所示：\n\n3.1 struct ieee80211_ops 实例 ath9k_htc_ops(驱动实现)\n\n       ath9k_htc_ops: mac80211通过这些回调函数回调driver的处理函数。ath9k_htc为了接受mac80211的管理，它必须首先向mac80211注册，以申明自己的存在，从而可以接受mac80211的调用。\n\nstruct ieee80211_ops ath9k_htc_ops = {  \n\n    .tx                 = ath9k_htc_tx,  // 发送mac80211要求发送的帧\n\n    .start              = ath9k_htc_start, // 第一个被attach到此硬件的net_device被enable之前被调用,之后，可以接收帧数据\n\n    .stop               = ath9k_htc_stop,  // 最后一个被attach到此硬件的net_device被disable之后被调用,之后，不可以接收帧数据\n\n    .add_interface      = ath9k_htc_add_interface, // 当一个被attach到此硬件的net_device被enable时被调用\n\n    .remove_interface   = ath9k_htc_remove_interface, // 通知driver一个接口将要going down\n\n    .config             = ath9k_htc_config,           // mac802.11调用它修改硬件配置\n\n    .configure_filter   = ath9k_htc_configure_filter, // 配置设备的接收过滤器\n\n    .sta_add            = ath9k_htc_sta_add,  \n\n    .sta_remove         = ath9k_htc_sta_remove,  \n\n    .conf_tx            = ath9k_htc_conf_tx,  \n\n    .bss_info_changed   = ath9k_htc_bss_info_changed,  \n\n    .set_key            = ath9k_htc_set_key,  \n\n    .get_tsf            = ath9k_htc_get_tsf,  \n\n    .set_tsf            = ath9k_htc_set_tsf,  \n\n    .reset_tsf          = ath9k_htc_reset_tsf,  \n\n    .ampdu_action       = ath9k_htc_ampdu_action,  \n\n    .sw_scan_start      = ath9k_htc_sw_scan_start,  \n\n    .sw_scan_complete   = ath9k_htc_sw_scan_complete,  \n\n    .set_rts_threshold  = ath9k_htc_set_rts_threshold,  \n\n    .rfkill_poll        = ath9k_htc_rfkill_poll_state,  \n\n    .set_coverage_class = ath9k_htc_set_coverage_class,  \n\n    .set_bitrate_mask   = ath9k_htc_set_bitrate_mask,  \n\n};  \n\n3.2 struct cfg80211_ops 实例 mac80211_config_ops(mac80211实现)  \n\n   cfg80211_ops定义了无线配置的操作，在它的增加虚拟接口(ieee80211_add_iface)中，它将创建并注册net_device。在mac80211中，其定义如下所示：\n\nstruct cfg80211_ops mac80211_config_ops = {  \n\n    .add_virtual_intf = ieee80211_add_iface, //使用给定的名字创建一个\"虚拟接口\",在wiphy的命名空间中创建net_device并返回\n\n    .del_virtual_intf = ieee80211_del_iface, //删除由ifindex指定的\"虚拟接口\"\n\n    .change_virtual_intf = ieee80211_change_iface,  \n\n    .add_key = ieee80211_add_key,  \n\n    .del_key = ieee80211_del_key,  \n\n    .get_key = ieee80211_get_key,  \n\n    .set_default_key = ieee80211_config_default_key,  \n\n    .set_default_mgmt_key = ieee80211_config_default_mgmt_key,  \n\n    .add_beacon = ieee80211_add_beacon,  \n\n    .set_beacon = ieee80211_set_beacon,  \n\n    .del_beacon = ieee80211_del_beacon,  \n\n    .add_station = ieee80211_add_station,  \n\n    .del_station = ieee80211_del_station,  \n\n    .change_station = ieee80211_change_station,  \n\n    .get_station = ieee80211_get_station,  \n\n    .dump_station = ieee80211_dump_station,  \n\n    .dump_survey = ieee80211_dump_survey,  \n\n#ifdef CONFIG_MAC80211_MESH\n\n    .add_mpath = ieee80211_add_mpath,  \n\n    .del_mpath = ieee80211_del_mpath,  \n\n    .change_mpath = ieee80211_change_mpath,  \n\n    .get_mpath = ieee80211_get_mpath,  \n\n    .dump_mpath = ieee80211_dump_mpath,  \n\n    .update_mesh_config = ieee80211_update_mesh_config,  \n\n    .get_mesh_config = ieee80211_get_mesh_config,  \n\n    .join_mesh = ieee80211_join_mesh,  \n\n    .leave_mesh = ieee80211_leave_mesh,  \n\n    .change_bss = ieee80211_change_bss,  \n\n    .set_txq_params = ieee80211_set_txq_params,  \n\n    .set_channel = ieee80211_set_channel,  \n\n    .suspend = ieee80211_suspend,  \n\n    .resume = ieee80211_resume,  \n\n    .scan = ieee80211_scan,  \n\n    .sched_scan_start = ieee80211_sched_scan_start,  \n\n    .sched_scan_stop = ieee80211_sched_scan_stop,  \n\n    .auth = ieee80211_auth,  \n\n    .assoc = ieee80211_assoc,  \n\n    .deauth = ieee80211_deauth,  \n\n    .disassoc = ieee80211_disassoc,  \n\n    .join_ibss = ieee80211_join_ibss,  \n\n    .leave_ibss = ieee80211_leave_ibss,  \n\n    .set_wiphy_params = ieee80211_set_wiphy_params,  \n\n    .set_tx_power = ieee80211_set_tx_power,  \n\n    .get_tx_power = ieee80211_get_tx_power,  \n\n    .set_wds_peer = ieee80211_set_wds_peer,  \n\n    .rfkill_poll = ieee80211_rfkill_poll,  \n\n    CFG80211_TESTMODE_CMD(ieee80211_testmode_cmd)  \n\n    .set_power_mgmt = ieee80211_set_power_mgmt,  \n\n    .set_bitrate_mask = ieee80211_set_bitrate_mask,  \n\n    .remain_on_channel = ieee80211_remain_on_channel,  \n\n    .cancel_remain_on_channel = ieee80211_cancel_remain_on_channel,  \n\n    .mgmt_tx = ieee80211_mgmt_tx,  \n\n    .mgmt_tx_cancel_wait = ieee80211_mgmt_tx_cancel_wait,  \n\n    .set_cqm_rssi_config = ieee80211_set_cqm_rssi_config,  \n\n    .mgmt_frame_register = ieee80211_mgmt_frame_register,  \n\n    .set_antenna = ieee80211_set_antenna,  \n\n    .get_antenna = ieee80211_get_antenna,  \n\n    .set_ringparam = ieee80211_set_ringparam,  \n\n    .get_ringparam = ieee80211_get_ringparam,  \n\n}  \n\n3.3 struct iw_handler_def  实例 cfg80211_wext_handler(wireless实现)\n\n      cfg80211_wext_handler实现了wext要求的ioctl操作，将通过net_device->wireless_handlers->standard[ioctl cmd- SIOCIWFIRST]来进行调用。在net/wireless/wext-compat.c中的定义如下所示：\n\nstaticconst iw_handler cfg80211_handlers[] = {  \n\n    [IW_IOCTL_IDX(SIOCGIWNAME)] = (iw_handler) cfg80211_wext_giwname,  \n\n    [IW_IOCTL_IDX(SIOCSIWFREQ)] = (iw_handler) cfg80211_wext_siwfreq,  \n\n    [IW_IOCTL_IDX(SIOCGIWFREQ)] = (iw_handler) cfg80211_wext_giwfreq,  \n\n    [IW_IOCTL_IDX(SIOCSIWMODE)] = (iw_handler) cfg80211_wext_siwmode,  \n\n    [IW_IOCTL_IDX(SIOCGIWMODE)] = (iw_handler) cfg80211_wext_giwmode,  \n\n    [IW_IOCTL_IDX(SIOCGIWRANGE)]    = (iw_handler) cfg80211_wext_giwrange,  \n\n    [IW_IOCTL_IDX(SIOCSIWAP)]   = (iw_handler) cfg80211_wext_siwap,  \n\n    [IW_IOCTL_IDX(SIOCGIWAP)]   = (iw_handler) cfg80211_wext_giwap,  \n\n    [IW_IOCTL_IDX(SIOCSIWMLME)] = (iw_handler) cfg80211_wext_siwmlme,  \n\n    [IW_IOCTL_IDX(SIOCSIWSCAN)] = (iw_handler) cfg80211_wext_siwscan,  \n\n    [IW_IOCTL_IDX(SIOCGIWSCAN)] = (iw_handler) cfg80211_wext_giwscan,  \n\n    [IW_IOCTL_IDX(SIOCSIWESSID)]    = (iw_handler) cfg80211_wext_siwessid,  \n\n    [IW_IOCTL_IDX(SIOCGIWESSID)]    = (iw_handler) cfg80211_wext_giwessid,  \n\n    [IW_IOCTL_IDX(SIOCSIWRATE)] = (iw_handler) cfg80211_wext_siwrate,  \n\n    [IW_IOCTL_IDX(SIOCGIWRATE)] = (iw_handler) cfg80211_wext_giwrate,  \n\n    [IW_IOCTL_IDX(SIOCSIWRTS)]  = (iw_handler) cfg80211_wext_siwrts,  \n\n    [IW_IOCTL_IDX(SIOCGIWRTS)]  = (iw_handler) cfg80211_wext_giwrts,  \n\n    [IW_IOCTL_IDX(SIOCSIWFRAG)] = (iw_handler) cfg80211_wext_siwfrag,  \n\n    [IW_IOCTL_IDX(SIOCGIWFRAG)] = (iw_handler) cfg80211_wext_giwfrag,  \n\n    [IW_IOCTL_IDX(SIOCSIWTXPOW)]    = (iw_handler) cfg80211_wext_siwtxpower,  \n\n    [IW_IOCTL_IDX(SIOCGIWTXPOW)]    = (iw_handler) cfg80211_wext_giwtxpower,  \n\n    [IW_IOCTL_IDX(SIOCSIWRETRY)]    = (iw_handler) cfg80211_wext_siwretry,  \n\n    [IW_IOCTL_IDX(SIOCGIWRETRY)]    = (iw_handler) cfg80211_wext_giwretry,  \n\n    [IW_IOCTL_IDX(SIOCSIWENCODE)]   = (iw_handler) cfg80211_wext_siwencode,  \n\n    [IW_IOCTL_IDX(SIOCGIWENCODE)]   = (iw_handler) cfg80211_wext_giwencode,  \n\n    [IW_IOCTL_IDX(SIOCSIWPOWER)]    = (iw_handler) cfg80211_wext_siwpower,  \n\n    [IW_IOCTL_IDX(SIOCGIWPOWER)]    = (iw_handler) cfg80211_wext_giwpower,  \n\n    [IW_IOCTL_IDX(SIOCSIWGENIE)]    = (iw_handler) cfg80211_wext_siwgenie,  \n\n    [IW_IOCTL_IDX(SIOCSIWAUTH)] = (iw_handler) cfg80211_wext_siwauth,  \n\n    [IW_IOCTL_IDX(SIOCGIWAUTH)] = (iw_handler) cfg80211_wext_giwauth,  \n\n    [IW_IOCTL_IDX(SIOCSIWENCODEEXT)]= (iw_handler) cfg80211_wext_siwencodeext,  \n\n    [IW_IOCTL_IDX(SIOCSIWPMKSA)]    = (iw_handler) cfg80211_wext_siwpmksa,  \n\n  [IW_IOCTL_IDX(SIOCSIWPRIV)] = (iw_handler)cfg80211_wext_setpriv  \n\n};  \n\nconststruct iw_handler_def cfg80211_wext_handler = {  \n\n    .num_standard       = ARRAY_SIZE(cfg80211_handlers),  \n\n    .standard       = cfg80211_handlers,  \n\n    .get_wireless_stats = cfg80211_wireless_stats,  \n\n}  \n\n4. 创建并注册net_device\n\n             当执行mac80211_config_ops-> ieee80211_add_iface时，它将创建net_device和对应的ieee80211_sub_if_data, 然后主要做了以下几件事：\n\n        1) 把net_device对应的名字增加到/sys/class/net/目录下   \n\n        2) 把新创建的net_device插入到init_net->dev_base_head中\n\n        3) 通知上层协议，有一个新的net_device出现了，大家可以使用它了\n\n        4) 把新创建的ieee80211_sub_if_data增加到ieee80211_local的interfaces列表中\n\n        其流程如下图所示：\n\n        mac80211中定义的net_device_ops ieee80211_dataif_ops，以下这些方法，都有一个struct net_device参数。其具体定义如下：\n\nstaticconststruct net_device_ops ieee80211_dataif_ops = {  \n\n    .ndo_open       = ieee80211_open,              // net_device变换到 UP 时被调用\n\n    .ndo_stop       = ieee80211_stop,              // net_device变换到 Down 时被调用\n\n    .ndo_uninit     = ieee80211_teardown_sdata,    // 取消注册或注册失败时调用\n\n    .ndo_start_xmit     = ieee80211_subif_start_xmit,  // 需要发送包时被调用\n\n    .ndo_set_multicast_list = ieee80211_set_multicast_list,// 多播地址列表变化时被调用\n\n    .ndo_change_mtu     = ieee80211_change_mtu,        // 当用户想改变一个设备的MTU时被调用\n\n    .ndo_set_mac_address    = ieee80211_change_mac,        // mac地址需要改变时被调用\n\n    .ndo_select_queue   = ieee80211_netdev_select_queue, //当net_device支持多个发送队列时，用来决定使用哪个队列\n\n};  \n\nmac80211中初始化net_device->netdev_ops:\n\nstaticvoid ieee80211_if_setup(struct net_device *dev)  \n\n{  \n\n    ether_setup(dev);  \n\n    dev->priv_flags &= ~IFF_TX_SKB_SHARING;  \n\n    dev->netdev_ops = &ieee80211_dataif_ops;  \n\n    dev->destructor = free_netdev;  \n\n}  \n\n5. 数据接收(Data RX)流程\n\n   数据接收流程如下图所示：\n\nIP层与TCP/UDP层接口定义如下：\n\nstaticconststruct net_protocol tcp_protocol = {  \n\n    .handler =  tcp_v4_rcv,  \n\n    .err_handler =  tcp_v4_err,  \n\n    .gso_send_check = tcp_v4_gso_send_check,  \n\n    .gso_segment =  tcp_tso_segment,  \n\n    .gro_receive =  tcp4_gro_receive,  \n\n    .gro_complete = tcp4_gro_complete,  \n\n    .no_policy =    1,  \n\n    .netns_ok = 1,  \n\n};  \n\nstaticconststruct net_protocol udp_protocol = {  \n\n    .handler =  udp_rcv,  \n\n    .err_handler =  udp_err,  \n\n    .gso_send_check = udp4_ufo_send_check,  \n\n    .gso_segment = udp4_ufo_fragment,  \n\n    .no_policy =    1,  \n\n    .netns_ok = 1,  \n\n};  \n\nstaticconststruct net_protocol icmp_protocol = {  \n\n    .handler =  icmp_rcv,  \n\n    .err_handler =  ping_err,  \n\n    .no_policy =    1,  \n\n    .netns_ok = 1,  \n\n};  \n\nIP层与net/core层接口定义如下：\n\nstaticstruct packet_type ip_packet_type __read_mostly = {  \n\n    .type = cpu_to_be16(ETH_P_IP),  \n\n    .func = ip_rcv,  \n\n    .gso_send_check = inet_gso_send_check,  \n\n    .gso_segment = inet_gso_segment,  \n\n    .gro_receive = inet_gro_receive,  \n\n    .gro_complete = inet_gro_complete,  \n\n};  \n\n接收下半部stack如下所示：\n\n[  336.646628] [<c07d8b24>] (tcp_rcv_established+0x648/0x9b0) from [<c07e04cc>] (tcp_v4_do_rcv+0x74/0x2a8)  \n\n[  336.646661] [<c07e04cc>] (tcp_v4_do_rcv+0x74/0x2a8) from [<c07e0c40>] (tcp_v4_rcv+0x540/0x908)  \n\n[  336.646678] [<c07e0c40>] (tcp_v4_rcv+0x540/0x908) from [<c07c23d4>] (ip_local_deliver_finish+0x158/0x318)  \n\n[  336.646694] [<c07c23d4>] (ip_local_deliver_finish+0x158/0x318) from [<c07c1e44>] (ip_rcv_finish+0x420/0x440)  \n\n[  336.646715] [<c07c1e44>] (ip_rcv_finish+0x420/0x440) from [<c0772dcc>] (__netif_receive_skb+0x4d0/0x534)  \n\n[  336.646730] [<c0772dcc>] (__netif_receive_skb+0x4d0/0x534) from [<c0774434>] (netif_receive_skb+0x9c/0xb4)  \n\n[  336.646752] [<c0774434>] (netif_receive_skb+0x9c/0xb4) from [<c08b8e6c>] (ieee80211_deliver_skb+0x134/0x164)  \n\n[  336.646769] [<c08b8e6c>] (ieee80211_deliver_skb+0x134/0x164) from [<c08b9ed8>] (ieee80211_rx_handlers+0x103c/0x1978)  \n\n[  336.646785] [<c08b9ed8>] (ieee80211_rx_handlers+0x103c/0x1978) from [<c08baf10>] (ieee80211_prepare_and_rx_handle+0x6fc/0x788)  \n\n[  336.646802] [<c08baf10>] (ieee80211_prepare_and_rx_handle+0x6fc/0x788) from [<c08bb920>] (ieee80211_rx+0x908/0x988)  \n\n[  336.646819] [<c08bb920>] (ieee80211_rx+0x908/0x988) from [<c068a578>] (ath9k_rx_tasklet+0x4e4/0x54c)  \n\n[  336.646835] [<c068a578>] (ath9k_rx_tasklet+0x4e4/0x54c) from [<c0467d98>] (tasklet_action+0xa8/0x14c)  \n\n[  336.646850] [<c0467d98>] (tasklet_action+0xa8/0x14c) from [<c0468144>] (__do_softirq+0x88/0x158)  \n\n[  336.646863] [<c0468144>] (__do_softirq+0x88/0x158) from [<c0468414>] (irq_exit+0x48/0xac)  \n\n[  336.646882] [<c0468414>] (irq_exit+0x48/0xac) from [<c04313c0>] (do_local_timer+0x50/0x80)  \n\n[  336.646898] [<c04313c0>] (do_local_timer+0x50/0x80) from [<c0436708>] (__irq_svc+0x48/0xe0)  \n\n6. 数据发送(Data TX)流珵\n\n   数据发送流程如下图所示：\n\n上半部分涉及到的相关代码如下所示（以上流程主要通过dump_stack获取）：\n\n     net/socket.c\n\n     net/ipv4/af_net.c\n\n     net/ipv4/tcp.c\n\n     net/ipv4/tcp_output.c\n\n     net/ipv4/ip_output.c\n\n     net/core/neighbour.c\n\n     net/core/dev.c\n\n7. INET初始化\n\n    INET为\nLinux\n OS实现了TCP/IP协议集，它使用BSD\n Socket接口作为与User通讯的方式。其初始化代码如下所示：\n\n    代码位于：net/ipv4/af_inet.c。\n\nstaticint __init inet_init(void)  \n\n{  \n\n    struct sk_buff *dummy_skb;  \n\n    struct inet_protosw *q;  \n\n    struct list_head *r;  \n\n    int rc = -EINVAL;  \n\n    BUILD_BUG_ON(sizeof(struct inet_skb_parm) > sizeof(dummy_skb->cb));  \n\n    sysctl_local_reserved_ports = kzalloc(65536 / 8, GFP_KERNEL);  \n\n    if (!sysctl_local_reserved_ports)  \n\n        goto out;  \n\n    rc = proto_register(&tcp_prot, 1);  \n\n    if (rc)  \n\n        goto out_free_reserved_ports;  \n\n    rc = proto_register(&udp_prot, 1);  \n\n    if (rc)  \n\n        goto out_unregister_tcp_proto;  \n\n    rc = proto_register(&raw_prot, 1);  \n\n    if (rc)  \n\n        goto out_unregister_udp_proto;  \n\n    rc = proto_register(&ping_prot, 1);  \n\n    if (rc)  \n\n        goto out_unregister_raw_proto;  \n\n    /* \n\n     *  Tell SOCKET that we are alive... \n\n     */\n\n    (void)sock_register(&inet_family_ops);  \n\n#ifdef CONFIG_SYSCTL\n\n    ip_static_sysctl_init();  \n\n    /* \n\n     *  Add all the base protocols. \n\n     */\n\n    if (inet_add_protocol(&icmp_protocol, IPPROTO_ICMP) < 0)  \n\n        printk(KERN_CRIT \"inet_init: Cannot add ICMP protocol\\n\");  \n\n    if (inet_add_protocol(&udp_protocol, IPPROTO_UDP) < 0)  \n\n        printk(KERN_CRIT \"inet_init: Cannot add UDP protocol\\n\");  \n\n    if (inet_add_protocol(&tcp_protocol, IPPROTO_TCP) < 0)  \n\n        printk(KERN_CRIT \"inet_init: Cannot add TCP protocol\\n\");  \n\n#ifdef CONFIG_IP_MULTICAST\n\n    if (inet_add_protocol(&igmp_protocol, IPPROTO_IGMP) < 0)  \n\n        printk(KERN_CRIT \"inet_init: Cannot add IGMP protocol\\n\");  \n\n    /* Register the socket-side information for inet_create. */\n\n    for (r = &inetsw[0]; r < &inetsw[SOCK_MAX]; ++r)  \n\n        INIT_LIST_HEAD(r);  \n\n    for (q = inetsw_array; q < &inetsw_array[INETSW_ARRAY_LEN]; ++q)  \n\n        inet_register_protosw(q);  \n\n    /* \n\n     *  Set the ARP module up \n\n     */\n\n    arp_init();  \n\n    /* \n\n     *  Set the IP module up \n\n     */\n\n    ip_init();  \n\n    tcp_v4_init();  \n\n    /* Setup TCP slab cache for open requests. */\n\n    tcp_init();  \n\n    /* Setup UDP memory threshold */\n\n    udp_init();  \n\n    /* Add UDP-Lite (RFC 3828) */\n\n    udplite4_register();  \n\n    ping_init();  \n\n    /* \n\n     *  Set the ICMP layer up \n\n     */\n\n    if (icmp_init() < 0)  \n\n        panic(\"Failed to create the ICMP control socket.\\n\");  \n\n    /* \n\n     *  Initialise the multicast router \n\n     */\n\n#if defined(CONFIG_IP_MROUTE)\n\n    if (ip_mr_init())  \n\n        printk(KERN_CRIT \"inet_init: Cannot init ipv4 mroute\\n\");  \n\n    /* \n\n     *  Initialise per-cpu ipv4 mibs \n\n     */\n\n    if (init_ipv4_mibs())  \n\n        printk(KERN_CRIT \"inet_init: Cannot init ipv4 mibs\\n\");  \n\n    ipv4_proc_init();  \n\n    ipfrag_init();  \n\n    dev_add_pack(&ip_packet_type);  \n\n    rc = 0;  \n\nout:  \n\n    return rc;  \n\nout_unregister_raw_proto:  \n\n    proto_unregister(&raw_prot);  \n\nout_unregister_udp_proto:  \n\n    proto_unregister(&udp_prot);  \n\nout_unregister_tcp_proto:  \n\n    proto_unregister(&tcp_prot);  \n\nout_free_reserved_ports:  \n\n    kfree(sysctl_local_reserved_ports);  \n\n    goto out;  \n\n}  \n\n阅读更多\n\nMeasure",
      "content_path": null,
      "diff_base_variant_id": null,
      "metadata": {
        "language": "en",
        "length": 16325,
        "rule_count": 3,
        "applied_rules": [
          {
            "rule_id": "social_handles",
            "description": "Drop standalone social handles and hashtags",
            "note": "removed social handle only lines"
          },
          {
            "rule_id": "dedupe_lines",
            "description": "Collapse adjacent duplicate lines",
            "note": "collapsed duplicate adjacent lines"
          },
          {
            "rule_id": "whitespace",
            "description": "Normalize whitespace",
            "note": "collapsed whitespace"
          }
        ]
      }
    }
  ],
  "extractions": [],
  "journal": {
    "id": "60b71e72-ab86-424e-8779-04381ce4b8a8",
    "note_id": "7e323a2e-1619-443a-8fb8-8f745adf9962",
    "stage": "ingest",
    "agent_id": "evernote_ingest:v0",
    "started_at": "2025-11-09T20:01:35.014137Z",
    "finished_at": "2025-11-09T20:01:35.014138Z",
    "status": "success",
    "input_ref": {
      "task_id": "738acc6b-c81a-4561-9b50-c75b3ab4aee0",
      "source_path": "/Users/tang/workbench/article-classifier/backups/2023年6月/IT技术/openwrt 无线结构 - 华六的博客 - CSDN博客.html",
      "checksum": "16a8f9be05dc5e6342b93d6434431f38b8b2c8dea89f387cafd511ed5d35cee4"
    },
    "output_ref": {
      "ingest_source": "fdce7b40-18ae-420b-97f5-137763641775",
      "note": "7e323a2e-1619-443a-8fb8-8f745adf9962",
      "variants": [
        "0cd9b471-c6aa-425d-bec2-212db043a4a6",
        "3b5c7629-2a4f-4af5-8244-2dc724126adf"
      ]
    },
    "error_detail": null
  }
}