---
title: FreeBsd也可以部署KVM
updated: 2019-02-18 07:46:29Z
created: 2019-02-18 07:46:29Z
source: https://zhuanlan.zhihu.com/p/38089691
---

FreeBsd也可以部署KVM
Alex
公众号：身边的行囊，传播正确的知识。
一．修改freebsd默认安装源
Freebsd默认安装源无法安装以下软件，所以需要更换新的安装源
1.更换软件源
Setenv PACKAGESITE
http://mirror.its.dal.ca/freebsd/releases/amd64/9.2-RELEASE/packages/Latest/
 freebsd-update fetch install
 portsnap fetch extract
2.安装 kqemu-kmod和qemu
 pkg_add -r kqemu-kmod
 pkg_add -r qemu
3.加载kvm核心模块
kldload kqemu
kldload aio
二．创建和安装虚拟机系统
1.为了便于管理新建虚拟机相关文件夹
mkdir /vm
mkdir /vm/iso
mkdir /vm/FreeBSD
2.创建image文件（创建虚拟机硬盘）创建了一个50G的硬盘空间，具体空间可以根据实际需要设置
qemu-img create -f qcow2 /vm/FreeBSD/freebsd.img 50G
3.创建和安装虚拟机系统
一定要根据安装的系统选择32位安装命令或64位安装命令，否则执行后在安装系统时会提示cpu不支持（-vnc和冒号之间有空格）
安装32位系统
qemu -cdrom /vm/iso/freebsd9.2.iso -hda /vm/freebsd.img -m 1024 -boot d kernel-kqemu -vnc :0 –localtime
安装64位系统
qemu-system-x86_64 -cdrom FreeBSD-9.2-RELEASE-amd64-disc1.iso -hda freebsd.img -m 1024 -boot d kernel-kqemu -vnc :0 -localtime
参数说明：
-cdrom：指定从光盘启动，也可以用该参数指定iso文件
-had：指定硬盘文件
-m：指定内存单位M
-boot：指定启动方式，d是从光盘启动
-vnc：指定vnc端口:0表示5900端口
-localtime：制动虚拟机使用宿主机时间
4.系统安装完成后直接ctrl+c结束掉进程，然后执行下面的命令启动虚拟机
（按下面的命令启动虚拟后虚拟机是无法和外面进行通信的，因为没有给虚拟机指定和宿主机通信网卡）
qemu-system-x86_64  -hda /vm/FreeBSD_9.2x64/freebsd.img -m 1024 kernel-kqemu -vnc :0 -localtime
三．创建bridge和tap接口
虚拟机和宿主机之间通信使用的是Linux bridge
1.开启tap支持
echo net.link.tap.user_open=1 >> /etc/sysctl.conf
echo net.link.tap.up_on_open=1 >> /etc/sysctl.conf
2.开机开启kqemu
在/etc/rc.conf下添加
ifconfig_em1=" inet 192.168.1.29 netmask 255.255.255.0"
kqemu_enable="YES"
3.创建bridge和tap接口
chmod 0660 /dev/tap0----不执行这条命令创建tap0时会报错
ifconfig bridge0 create
ifconfig tap0 create
ifconfig bridge0 addm em1 addm tap0 up ---将em1和tap0加入到bridge0
（ifconfig bridge0 destroy 删除接口命令）
四．常见问题
1.bridge和tap的在创建后会自动生产mac地址，虚拟机也会自动生成mac地址，也就是说bridge、tap和虚拟机中的网口都会重新自动生成mac地址不会引用真实网卡的mac地址
2.在openstack中需要清除物理口的ip地址，然后将ip地址设置到bridge接口虚拟机才可以正常和外部通信，但是在这里无需如此，只需正确创建接口即可正常通信
3.一个bridge下可以有多个物理口和tap口，一个物理接口只能属于一个bridge。
4.一个bridge下可以有多个tap接口，当在启动虚拟机时命令中指定的tap接口如果已经在用，系统会自动按顺序分配一个没在用的tap接口。
下面启动的2个虚拟机在启动参数中都指定的是tap0接口，当启动时后启动的虚拟机会自动给分配到tap1接口下
在tap接口下可以看到使用该接口的虚拟机进程号
微信公众号ID：snmp161
Measure