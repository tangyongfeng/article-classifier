---
title: 解密微博红包：架构、防刷、监控和资源调度
updated: 2016-03-19 05:07:14Z
created: 2016-03-19 05:07:14Z
source: http://www.infoq.com/cn/articles/2016-hongbao-weibo
latitude: 46.16528942
longitude: 14.35196417
altitude: 0.0000
---

中文

Choose language

中文

En

日本

Fr

Br

Search InfoQ

欢迎，
guest
!

我的阅读清单

偏好设置

注销

登录

E-mail:

密码:

忘记密码？

登陆为:

使用Microsoft账号登录

使用Google账号登录

使用Weibo账号登录

使用QQ账号登录

新的用户:

立即注册

InfoQ账号使用的E-mail:

Back to login

InfoQ contents

新闻

文章

演讲

访谈

迷你书

调查

领域

语言 & 开发

显示全部

Java

Clojure

Scala

.Net

移动

Android

iOS

HTML 5

JavaScript

函数式编程

Web API

架构 & 设计

显示全部

架构

企业架构

性能和可伸缩性

设计

案例分析

设计模式

安全

数据科学

显示全部

大数据

NoSQL

关系型数据库

文化 & 方法

显示全部

Agile

领导能力

团队协作

测试

用户体验

Scrum

精益

DevOps

显示全部

持续交付

自动化操作

云计算

首页

QCon Conferences

关于我们

关于您

投稿

Purpose Index

                解密微博红包：架构、防刷、监控和资源调度
               
                作者
               
柯立志

                发布于
                2016年3月1日
           
添加到
阅读列表

添加至阅
读列表

查看我的
阅读列表

We failed to create the bookmark.
If the behaviour persists please contact us.

编者按

与传统意义上的红包相比，近两年火起来的“红包”，似乎才是如今春节的一大重头戏。历经上千年时代传承与变迁，春节发红包早已成为历史沉淀的文化习俗，融入了民族的血脉。按照各家公布的数据，除夕全天
微信用户
红包总发送量达到10.1亿次，摇一摇互动量达到110亿次，红包峰值发送量为8.1亿次/分钟。而
支付宝的红包
收发总量达到2.4亿次，参与人数达到6.83亿人次，红包总金额40亿元，峰值为8.83亿次/分钟。春晚直播期间讨论春晚的微博达到5191万条，网友互动量达到1.15亿，网友抢微博红包的总次数超过8亿次。

为此，InfoQ策划了“春节红包”系列文章，以期为读者剖析各大平台的红包活动背后的技术细节。本文为微博篇。

随着互联网的发展，打破了以往传统的发红包，带给了红包全新的玩法。微博红包已经成为用户给粉丝拜年的一种途径，土豪版成为土豪刷存在感的方式。每年的红包大战都是用户的现金盛宴，对于整个系统却是残酷的考验。

微博有8亿注册用户，单日活跃用户数1.34亿的社交平台。红包在微博平台上运行，针对所有的微博用户开放，微博所有用户都可参与红包活动。微博红包有如下特点：

红包价值高、种类多、覆盖用户广，亿级别用户参与。

半点准时开抢，高并发访问、瞬间峰值高，每分钟带来上亿次的抢红包峰值。

请求快速响应，更新亿级用户中奖状态及红包状态。

单个红包数额大。

春晚当天红包总价值超过10亿，有1.34亿用户参与，产生了8亿多次的抢红包行为，其中并发量为平时峰值的10倍左右。在服务器数量一定的情况下，如何构建高并发操作、瞬间峰值高的稳定服务？对于团队和架构师都是一个极大的挑战。这时候系统的架构尤为重要！

红包架构

微博红包支持每秒几十万次的操作，应对突发性的热点事件，快速响应，高内聚低耦合的服务成了架构首先要考虑的因素。

(点击放大图像)

微博是社交型应用，红包在用户数据、关系、抢红包等结构上存在着各种各样复杂的依赖，这些依赖相比其它应用来说，调用频率更高，性能要求也更高。

如上图所示，有多个应用模块接入红包的服务层，服务层由多个节点组成，每个节点对应相应的功能并且相对独立。代码模块的使用和组织上相对独立，保证主功能的快速和稳定，将附属的新功能分离在独立模块中。其中红色虚线框内为核心的功能模块，是重点需要保护的功能。

微博红包提供获取红包属性（红包金额、红包设置、红包状态、获取抽取结果列表、拆包，抽奖等）接口。服务层调用红包SDK相应的API，会根据应用层逻辑需求提供数据和定制化得数据，完成前端完成交互，达到应用层需要展现的效果。

防刷策略

微博红包有别于微信用户发出的红包，微信用户发出的红包是针对自己所认识的朋友或者已存在于微信群的用户；微博红包是针对于微博所有用户的红包，通过分析参与红包的用户数据每年都会产生一些囤积大量账号准备在春晚大发横财的公司和个人。如何防止微博红包被自动注册或者通过转卖账号来领取红包？这成为面对我们需要解决的一大问题。

(点击放大图像)

微博通过基于用户在微博上的行为分析，通过登录，发微博，身份验证等方面来进行分析。主要有：

用户注册：通过用户行为分析来识别机器注册的用户，则注册环节进行拦截。

用户登录：分析用户登录的行为，通过验证码，身份验证以及手机号验证等措施来提高机器自动登录的门槛。

账号质量：通过实名认证，微博的动态等方面来计算出用户的质量。

参与红包：红包战场一贯是刷奖账号的获利主战场， 通过用户平时在微博的行为、属性以及实时的登录状态和常用设备来进行分析，判断是否是正常账号来确定是否可以中奖。

完善的监控

红包系统是一个大而规则复杂的系统，系统越大，依赖的资源越多，也就越容易出现各种各样的问题。为了给提供稳定运行的服务，必须要能时刻知晓各个资源当前的运行状态。并且在系统出现异常之前或者出现异常的时候，对问题进行排查和定位。

(点击放大图像)

如上图所示，完善的监控系统，为微博红包顺利度过春晚提供了很好的保障。主要涉及的监控如下：

1、应用层接口响应时间监控

通过实时的分析access log日志，以HTTP code和响应时间维度实时统计出接口的状态和性能，根据占比来查看接口的健康程度。

2、服务层各模块性能监控

在模块中记录开始时间和结束时间，每次处理完计算出模块的耗时，通过这种方式很好的发现各个模块是否正常。    

3、网络层监控

微博红包的出口网络是一个单独的app池，出口带宽使用到80%的时候网络稳定性就可能受到影响。通过计算后端服务器输出计算出带宽，以便能够做到及时响应扩容。

4、资源层的监控

对各种资源的监控，比如Redis、MySQL、MC等资源的连接时间、状态和操作的实时统计分析，快速定位是否存在资源瓶颈。

5、服务器的性能监控

通过运维监控系统，对服务器的CPU、内存使用情况，做到了能够观察每台服务器具体的运行情况。

6、系统错误日志的监控

系统错误监控包括服务器负载，服务进程状态，资源连接，网络连接出现的问题，实时通过手机，邮件和私信知道。为快速响应创造了条件。

弹性资源管理和调度

1、故障的秒级切换

微博红包服务部署在了三个机房（包括云服务），任何一个机房如果出现网络或者其它不可预测的问题可以在几秒钟之内将服务切换到其它机房。

2、资源的相互独立

资源的相互独立，让资源的可扩展性变得容易。而且使得各个服务之间交叉影响达到了最小。

3、引入阿里云做为第三机房，使用Docker快速部署服务

红包的核心服务主要分布在 2 个机房，两者互相做为灾难备份用途，为应对超预期的峰值，引入阿里云做为第三机房。使用定制化的红包Docker快速部署服务来实现弹性调度架构。通过Docker自动化操作大规模集群，进行弹性调度资源的任务，实现快速部署服务来应付超预期的峰值。

系统的挑战和性能优化

为了保证用户体验，微博红包需要解决以下几个问题：

系统性能的可靠性

关键节点的可用性

如何应对突发热点

业务频繁迭代的处理

1、系统架构的升级

模块的独立化，避免出现模块间的相互影响。

nginx+lua的使用，使得服务器的QPS有了数量级的提升，同时服务器集群做到了秒级重启。

2、修枝剪页

减少对于系统外部的依赖，梳理完整的调用关系图。非核心功能使用异步调用，合并相关的调用，去掉重复的调用。保证核心调用逻辑，避免非核心业务影响核心业务。

3、多级缓存

服务端本地缓存，使用nginx本身缓存和服务器的L0缓存，来提升模块的响应速度，做到了90%以上核心接口的响应时间在50ms以内，减少了进程等待时间，提升了服务器的处理速度。

一年一度的各大平台抢红包还会延续下去，这是一个斗智斗勇的过程，在服务器有限的情况下每一次与峰值的对抗都是对技术一次极大的挑战，每次挑战都是带来技术上的成长和收获。

感谢
郭蕾
对本文的策划和审校。

给InfoQ中文站投稿或者参与内容翻译工作，请邮件至
editors@cn.infoq.com
。也欢迎大家通过新浪微博（

，

），微信（微信号：
InfoQChina
）关注我们。

领域

架构 & 设计

语言 & 开发

专栏

微博

高并发

云服务

运维

春节红包

相关赞助商

QCon北京2016大会，4月21-23日，北京·国际会议中心，
精彩内容
邀您参与！

相关内容

新浪微博高可用服务保障体系演进

新浪微博应对峰值压力的混合云架构实践

李庆丰：新浪微博服务高可用新技术、新架构的尝试

微博推荐架构的演进

微博背后的那些算法

讨论!

告诉我们您的想法

主题:

信息:

允许的HTML标签: a,b,br,blockquote,i,li,pre,u,ul,p

当有人回复此评论时请E-mail通知我

0 社区评论

                            邮件订阅这个讨论
                       
您好，朋友！

您需要
注册一个InfoQ账号
 才能进行评论。在您完成注册后还需要进行一些设置。

获得来自InfoQ的更多体验。

InfoQ每周精要

通过个性化定制的新闻邮件、RSS Feeds和InfoQ业界邮件通知，保持您对感兴趣的社区内容的时刻关注。

属于您的个性化RSS

InfoQ中文站官方微博

关于我们

合作伙伴

投稿

提供反馈

feedback@cn.infoq.com

错误报告

bugs@cn.infoq.com

商务合作

sales@cn.infoq.com

内容合作

editors@cn.infoq.com

桌面版

        InfoQ.com及所有内容，版权所有 © 2006-2016 C4Media Inc. InfoQ.com 服务器由
Contegix
提供, 我们最信赖的ISP伙伴。

隐私政策

更新个人资料

您的个人介绍是最新的么？请确认并更新。

E-mail
*

注意：如果要修改您的邮箱，我们将会发送确认邮件到您原来的邮箱。

公司名称

 仍使用 

修改公司名称为：
*

您的职位

 仍使用

修改公司性质为:
*

公司规模

仍使用

修改公司规模为：

国家/地区

 仍使用

更新国家:

--- 选择您的国家 ---

 仍使用

更新省份:

 订阅InfoQ每周精要

 订阅InfoQ行业用户邮件通知