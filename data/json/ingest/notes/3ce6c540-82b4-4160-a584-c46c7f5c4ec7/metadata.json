{
  "ingest_source": {
    "id": "c0fb2541-274e-47ff-ad83-f441abe74577",
    "source_type": "evernote_html",
    "source_path": "backups/2023年6月/IT技术/Linux系统无线网络抓包程序(分析手机WIFI MAC地址)-echojb.com.html",
    "collected_at": "2025-11-10T15:43:30.873784Z",
    "external_id": null,
    "title_hint": null,
    "language_hint": "en",
    "captured_at": null,
    "checksum": "86fdb3b54777ac8abc157659cc1696558ed28f3f70d45de218850e06f0691f3c",
    "status": "pending",
    "notes": {
      "batch_id": "phase2-backfill-202306"
    }
  },
  "note": {
    "id": "3ce6c540-82b4-4160-a584-c46c7f5c4ec7",
    "ingest_source_id": "c0fb2541-274e-47ff-ad83-f441abe74577",
    "canonical_title": "Linux系统无线网络抓包程序(分析手机WIFI MAC地址)-echojb.com",
    "language": "en",
    "ingested_at": "2025-11-10T15:43:30.873788Z",
    "created_at": null,
    "status": "active",
    "importance": 0,
    "attributes": {
      "source_filename": "Linux系统无线网络抓包程序(分析手机WIFI MAC地址)-echojb.com.html"
    }
  },
  "variants": [
    {
      "id": "ac38880f-69a1-42fa-b52b-42c69e626fc3",
      "note_id": "3ce6c540-82b4-4160-a584-c46c7f5c4ec7",
      "variant_type": "raw_html",
      "version": 1,
      "created_by": "evernote_ingest:v0",
      "created_at": "2025-11-10T15:43:30.873791Z",
      "content": "---\ntitle: Linux系统无线网络抓包程序(分析手机WIFI MAC地址)-echojb.com\nupdated: 2018-11-09 08:42:57Z\ncreated: 2018-11-09 08:42:57Z\nsource: http://www.echojb.com/wireless/2017/01/17/304182.html\n---\n\n\n<en-note>\n  <div>\n<div STYLE=\"font-size: 16px; display: inline-block;  min-width: 100%;position: relative;\"><div STYLE=\"font-family:inherit;font-size:62.5%;font-style:inherit;outline:0px;vertical-align:baseline;box-sizing:border-box;text-size-adjust:100%;\"><div STYLE=\"font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;box-sizing:inherit;font:14px/180% &quot;Microsoft YaHei&quot;, Helvetica, Arial, &quot;Lucida Grande&quot;, Tahoma, sans-serif;color:rgb(68, 68, 68);background:rgb(241, 241, 241);\"><div STYLE=\"font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;box-sizing:inherit;\"><div STYLE=\"font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;box-sizing:inherit;\"><div STYLE=\"font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;box-sizing:inherit;transition-duration:0.5s;\"><span STYLE=\"box-sizing:inherit;\"><div STYLE=\"font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;box-sizing:inherit;animation-duration:1s;animation-fill-mode:both;animation-delay:0.3s;\"><div STYLE=\"font-family:inherit;font-size:100%;font-style:inherit;outline:0px;vertical-align:baseline;box-sizing:inherit;background:rgb(255, 255, 255);box-shadow:rgba(0, 0, 0, 0.04) 0px 1px 1px;border-radius:2px;\">\n&Tab;&Tab;<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;display:block;\">\n&Tab;&Tab;<h1 STYLE=\"border:0px;font-family:inherit;font-size:18px;font-style:inherit;margin:35px -20px 20px;outline:0px;padding:5px 20px;vertical-align:baseline;box-sizing:inherit;position:relative;line-height:30px;text-align:center;border-left:5px solid rgb(47, 136, 154);border-right:5px solid rgb(47, 136, 154);\">Linux系统无线网络抓包程序(分析手机WIFI MAC地址)</h1>\n&Tab;&Tab;</div>\n&Tab;<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;\">\n&Tab;&Tab;<div STYLE=\"border:0px;font-family:inherit;font-size:15px;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;line-height:1.8;overflow-wrap:break-word;\">\n&Tab;&Tab;&Tab;<div STYLE=\"border:none;font-family:inherit;font-size:100%;font-style:inherit;margin:0px -11px 10px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;background:transparent;padding-top:6px;box-shadow:none;border-radius:0px;overflow:hidden;text-align:center;\">\n\n<ins STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;display:block;\"></ins>\n</div>\n&Tab;&Tab;&Tab;&Tab;<p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">首先要介绍ieee802.11的帧格式，只有知道帧格式才能正确解析对应字段，拿到我们感兴趣的信息。其次介绍Linux raw socket编程抓包。最后解析ieee802.11数据包，从而获取到MAC地址。实际上，从数据包中可以得到很多信息，这些信息就是后续需要继续进行的事了。</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">一、ieee802.11帧格式</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">ieee802.11帧格式如下图所示：</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"><img src=\"../_resources/91b852bbbc0355f5771cd40a2e5447db.png\"  type=\"image/png\" hash=\"91b852bbbc0355f5771cd40a2e5447db\" width=\"718\" height=\"156\" style=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:middle;box-sizing:inherit;max-width:100%;height:auto;display:block;\" alt=\"\" /></en-media><br STYLE=\"box-sizing:inherit;\"/>\n</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">二、C实现socket抓包</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">&nbsp;Linux系统抓包使用SOCK_RAW方式，类型为ETH_P_ALL(表示抓取所有类型的帧，不管是IP帧还是ARP帧)。下面给出代码重要函数代码片段。为减小文章篇幅，保留主要代码函数，至于完整代码，请参阅文章后面的附录。</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">1、设置混杂模式</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">抓包工具都会开启混杂模式(promisc)，下面是代码：</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><pre STYLE=\"border:0px;font-family:inherit;font-size:10.5pt;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;background:rgb(240, 240, 240);line-height:20px;width:100%;overflow:auto hidden;\">// 混杂模式\nbool set_promisc_mode(const char* eth, bool promisc)\n{\n    int org_errno = 0;\n    int fd;\n    struct ifreq ifreq;\n\n    if ((fd = socket(AF_INET, SOCK_DGRAM, 0)) == -1)\n        return false;\n\n    memset(&amp;ifreq, 0, sizeof(ifreq));\n    strncpy(ifreq.ifr_name, eth, IF_NAMESIZE - 1);\n\n    ioctl(fd, SIOCGIFFLAGS, &amp;ifreq);\n\n    // check if eth is up\n    if (!(ifreq.ifr_flags &amp; IFF_UP))\n    {\n        printf(&quot;%s is not up yet.n&quot;, eth);\n        return false;\n    }\n\n    if (promisc)\n        ifreq.ifr_flags |= IFF_PROMISC;\n    else\n        ifreq.ifr_flags &amp;= ~IFF_PROMISC;\n\n    ioctl(fd, SIOCSIFFLAGS, &amp;ifreq);\n\n    if (close(fd))\n        return false;\n\n    return true;\n}</pre><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">2、初始化socket</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">初始化socket包括创建RAW socket，绑定指定网卡。</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><pre STYLE=\"border:0px;font-family:inherit;font-size:10.5pt;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;background:rgb(240, 240, 240);line-height:20px;width:100%;overflow:auto hidden;\">int init_socket(const char* eth)\n{\n    int ret = 0;\n    int fd = -1;\n\n    // 混杂模式\n    if (!set_promisc_mode(eth, true))\n    {\n        //printf(&quot;set %s to promisc mode failed.n&quot;, eth);\n        return -1;\n    }\n\n    // 注意与下面绑定时协议一致\n    fd = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_ALL));\n\n    // 绑定网卡\n    struct ifreq req;\n    strcpy(req.ifr_name, eth);\n    ioctl(fd, SIOCGIFINDEX, &amp;req);\n\n    struct sockaddr_ll addr;\n    addr.sll_family = PF_PACKET;\n    addr.sll_ifindex = req.ifr_ifindex;\n    addr.sll_protocol = htons(ETH_P_ALL);\n    ret = bind(fd, (struct sockaddr *)&amp;addr, sizeof(struct sockaddr_ll));\n    \n    return fd;\n}</pre><br STYLE=\"box-sizing:inherit;\"/>\n3、获取网卡信息\n<p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><pre STYLE=\"border:0px;font-family:inherit;font-size:10.5pt;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;background:rgb(240, 240, 240);line-height:20px;width:100%;overflow:auto hidden;\">int get_hwinfo(int fd, char* eth, unsigned char* mac)\n{\n    struct ifreq ifr;\n\n    memset(&amp;ifr, 0, sizeof(ifr));\n    strncpy(ifr.ifr_name, eth, IFNAMSIZ - 1);\n    ifr.ifr_name[IFNAMSIZ - 1] = &apos;&apos;;\n\n    if (ioctl(fd, SIOCGIFHWADDR, &amp;ifr) &lt; 0)\n    {\n        printf(&quot;Could not get arptypen&quot;);\n        return -1;\n    }\n    printf(&quot;ARPTYPE %dn&quot;, ifr.ifr_hwaddr.sa_family);\n    memcpy(mac, ifr.ifr_hwaddr.sa_data, 6);\n    return ifr.ifr_hwaddr.sa_family;\n}</pre><br STYLE=\"box-sizing:inherit;\"/>\n注意，函数返回的sa_family十分重要，它是判断抓取的帧类型的依据。跟踪SIOCGIFHWADDR调用过程，发现内核驱动将dev-&gt;dev_addr赋值给ifr-&gt;ifr_hwaddr.sa_data，而dev-&gt;type赋值给ifr-&gt;ifr_hwaddr.sa_family。<br STYLE=\"box-sizing:inherit;\"/><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">4、接收数据</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">一般网络接收数据都会使用select模型，使用recv即可收到内核传递的数据。</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><pre STYLE=\"border:0px;font-family:inherit;font-size:10.5pt;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;background:rgb(240, 240, 240);line-height:20px;width:100%;overflow:auto hidden;\">int receive_packet(int socket)\n{\n    int ret = 0;\n\n    struct timeval tv;\n\n    static fd_set read_fds;\n\n    tv.tv_sec = 0;\n    tv.tv_usec = 100;\n\n    FD_ZERO(&amp;read_fds);\n    FD_SET(socket, &amp;read_fds);\n\n    ret = select(socket+1, &amp;read_fds, NULL, NULL, &amp;tv);\n\n    if (ret == -1 &amp;&amp; errno == EINTR) /* interrupted */\n        return -1;\n    if (ret == 0)\n        return -1;\n    else if (ret &lt; 0)\n        return -1;\n\n    if (FD_ISSET(socket, &amp;read_fds))\n    {\n        memset(buffer, &apos;&apos;, BUFFER_SIZE);\n        ret = recv(socket, buffer, BUFFER_SIZE, MSG_DONTWAIT);\n        if (ret &lt;= 0)\n            return -1;\n        //printf(&quot;--recv len: %dn&quot;, ret);\n        if (debug_level)\n        {\n            dump(buffer, ret);\n            printf(&quot;====================n&quot;);\n        }\n        if (arphrd == 1)\n            parse_packet(buffer, ret); // ieee802.3包\n        else if (arphrd == 802 || arphrd == 803) // ieee802.11包\n            parse_packet_wlan(buffer, ret);\n    }\n\n    return 0;\n}</pre><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">三、解析</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">下图是笔者手机发的probe request帧截图(使用tcpdump抓包，再用wireshark查看)。</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"><img src=\"../_resources/783ba06ada8f889b7d4cd5742d302666.png\"  type=\"image/png\" hash=\"783ba06ada8f889b7d4cd5742d302666\" width=\"569\" height=\"214\" style=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:middle;box-sizing:inherit;max-width:100%;height:auto;display:block;\" alt=\"\" /></en-media><br STYLE=\"box-sizing:inherit;\"/>\n</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">1、radiotap头部</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">radiotap包含大量有用信息，比如SSI信号强度。但我们暂时不需要，直接跳过。它的结构体定义如下：</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><pre STYLE=\"border:0px;font-family:inherit;font-size:10.5pt;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;background:rgb(240, 240, 240);line-height:20px;width:100%;overflow:auto hidden;\">// radiotap头部\n// radiotap官网：http://www.radiotap.org/\nstruct ieee80211_radiotap_header {\n        uint8_t        it_version;     /* set to 0 */\n        uint8_t        it_pad;\n        uint16_t       it_len;         /* entire length */\n        uint32_t       it_present;     /* fields present */\n} __attribute__((__packed__));\n</pre>其中的it_len成员表示整个radiotap头部的大小。因此在代码中直接使用it_len作偏移量计算出ieee802.11头部地址。\n<p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">2、ieee802.11头部</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">ieee802.11头部结构体如下：</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><pre STYLE=\"border:0px;font-family:inherit;font-size:10.5pt;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;background:rgb(240, 240, 240);line-height:20px;width:100%;overflow:auto hidden;\">// 802.11帧头\nstruct wlan_frame {\n&Tab;uint16_t&Tab;fc;\n&Tab;uint16_t&Tab;duration;\n&Tab;uint8_t&Tab;&Tab;addr1[6];\n&Tab;uint8_t&Tab;&Tab;addr2[6];\n&Tab;uint8_t&Tab;&Tab;addr3[6];\n&Tab;uint16_t&Tab;seq;\n&Tab;union {\n&Tab;&Tab;uint16_t&Tab;&Tab;qos;\n&Tab;&Tab;uint8_t&Tab;&Tab;&Tab;addr4[6];\n&Tab;&Tab;struct {\n&Tab;&Tab;&Tab;uint16_t&Tab;qos;\n&Tab;&Tab;&Tab;uint32_t&Tab;ht;\n&Tab;&Tab;} __attribute__ ((packed)) ht;\n&Tab;&Tab;struct {\n&Tab;&Tab;&Tab;uint8_t&Tab;&Tab;addr4[6];\n&Tab;&Tab;&Tab;uint16_t&Tab;qos;\n&Tab;&Tab;&Tab;uint32_t&Tab;ht;\n&Tab;&Tab;} __attribute__ ((packed)) addr4_qos_ht;\n&Tab;} u;\n} __attribute__ ((packed));</pre>从前面的图示知道，addr1为接收方(Receiver)MAC地址，addr2为发送者(Transmitter)MAC地址，addr3为BSSID。不同类型的帧，Receiver和Transmitter不同，对于probe request类型帧来说，Transmitter地址即为所需要的MAC号&mdash;&mdash;因为probe都是广播，目标地址都是ff。<br STYLE=\"box-sizing:inherit;\"/>\n下面是解析ieee802.11的函数代码：\n<p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><pre STYLE=\"border:0px;font-family:inherit;font-size:10.5pt;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;background:rgb(240, 240, 240);line-height:20px;width:100%;overflow:auto hidden;\">int parse_packet_wlan(const char* buffer, int len)\n{\n    int hdrlen = 0;\n    uint16_t fc = 0;\n&Tab;uint8_t* ra = NULL;\n&Tab;uint8_t* ta = NULL;\n&Tab;uint8_t* bssid = NULL;\n    \n    struct ieee80211_radiotap_header* radiotap_header = NULL;\n    struct wlan_frame* wh = NULL;\n    \n    if (buffer == NULL)\n    {\n        return -1;\n    }\n\n    radiotap_header = (struct ieee80211_radiotap_header*)buffer;\n    // it_len表示整个radiotap信息，包括头部，因此直接跳过到ieee80211头部\n    int radiotap_len = radiotap_header-&gt;it_len;\n    wh = (struct wlan_frame*)(buffer+radiotap_len);\n    \n    fc = le16toh(wh-&gt;fc); // 传输格式为little endian，要转换成host格式\n    int wlan_type = (fc &amp; 0xfc);\n    int type = (fc &amp; 0xc)&gt;&gt;2;\n    int stype = (fc &amp; 0xf0)&gt;&gt;4;\n&Tab;//printf(&quot;fc:0x%x wlan_type 0x%x - type 0x%x - stype 0x%x n&quot;, fc, wlan_type, type, stype);\n    \n    // 数据帧\n    if (type == 0x02)\n    {\n        \n    }\n    // 控制帧\n    else if (type == 0x01)\n    {\n        \n    }\n    // 管理帧\n    else if (type == 0x0)\n    {\n        if (stype == 0x04) // probe帧\n        {\n            ra = wh-&gt;addr1;\n            ta = wh-&gt;addr2;\n            bssid = wh-&gt;addr3;\n            if (ta)\n                printf(&quot;SRC MAC: [&quot; MACFMT &quot;] --&gt; &quot;, MAC2ADDR(ta));\n            if (ra)\n                printf(&quot;DST MAC: [&quot; MACFMT &quot;]&quot;, MAC2ADDR(ra));\n            if (bssid)\n                printf(&quot; BSSID MAC: [&quot; MACFMT &quot;]&quot;, MAC2ADDR(bssid));\n            printf(&quot;n&quot;);    \n        }\n    }\n    else\n    {\n        printf(&quot;unknown frame.n&quot;);\n        return -1;\n    }\n\n    return 0;\n}</pre>看上去十分简单，因为我们只需要其中一种帧的MAC地址信息，其它一概忽视。&nbsp;\n<p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"></p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">下图是扫描probe得到的MAC地址，并且根据OUI查出MAC所属组织名称(代码需修改)：</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">&nbsp;<img src=\"../_resources/c297621b7cee2964a351bffdeb2767b3.png\"  type=\"image/png\" hash=\"c297621b7cee2964a351bffdeb2767b3\" width=\"628\" height=\"395\" style=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:middle;box-sizing:inherit;max-width:100%;height:auto;display:block;\" alt=\"\" /></en-media></p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">修改后的版本演示结果如下(代码需修改)：</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"><img src=\"../_resources/89ef29188c6b39dd551031f2cf340161.png\"  type=\"image/png\" hash=\"89ef29188c6b39dd551031f2cf340161\" width=\"718\" height=\"119\" style=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:middle;box-sizing:inherit;max-width:100%;height:auto;display:block;\" alt=\"\" /></en-media><br STYLE=\"box-sizing:inherit;\"/>\n</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"><br STYLE=\"box-sizing:inherit;\"/>\n</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">&nbsp;</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\">附代码：</p><p STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px 0px 5px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;overflow-wrap:break-word;word-break:break-all;text-indent:2em;\"><br STYLE=\"box-sizing:inherit;\"/>\n</p>&Tab;&Tab;</div>\n<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;clear:both;\"></div>\n\n<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:15px auto 80px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;position:relative;\">\n&Tab;<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px auto;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;position:relative;width:243px;\">\n&Tab;&Tab;&Tab;<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;clear:both;\"></div>\n&Tab;</div>\n</div>&Tab;&Tab;\n\n&Tab;&Tab;&Tab;<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;display:block;\">\n&Tab;&Tab;&Tab;&Tab;<ul STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;list-style:none;position:absolute;top:15px;right:15px;\">\n&Tab;&Tab;&Tab;&Tab;<li STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;float:left;\"><a HREF=\"#\" TITLE=\"Sidebar \" STYLE=\"border:1px solid rgb(221, 221, 221);font-family:inherit;font-size:100%;font-style:inherit;margin:0px 5px 0px 0px;outline:0px;padding:0px 8px;vertical-align:baseline;box-sizing:inherit;color:rgb(153, 153, 153);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);line-height:26px;display:block;border-radius:2px;\"><i STYLE=\"border:0px;font-family:FontAwesome;font-size:inherit;font-style:normal;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;display:inline-block;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;text-rendering:auto;-webkit-font-smoothing:antialiased;\"><span STYLE=\"font-family:FontAwesome;font-size:inherit;font-style:normal;font-variant:normal;font-weight:normal;line-height:1;\"></span></i> <i STYLE=\"border:0px;font-family:FontAwesome;font-size:inherit;font-style:normal;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;display:inline-block;font-variant:normal;font-weight:normal;font-stretch:normal;line-height:1;text-rendering:auto;-webkit-font-smoothing:antialiased;\"><span STYLE=\"font-family:FontAwesome;font-size:inherit;font-style:normal;font-variant:normal;font-weight:normal;line-height:1;\"></span></i></a></li>\n&Tab;&Tab;&Tab;&Tab;</ul>\n&Tab;\n<ul STYLE=\"border:1px solid rgb(221, 221, 221);font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px 0px 1px;vertical-align:baseline;box-sizing:inherit;list-style:none;position:absolute;top:15px;left:20px;line-height:24px;width:40px;text-align:center;cursor:pointer;border-radius:2px;\">A+</ul>\n<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;clear:both;\"></div>\n&Tab;&Tab;&Tab;&Tab;<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:10px 0px;vertical-align:baseline;box-sizing:inherit;position:absolute;background:rgb(248, 248, 248);bottom:-1px;left:0px;width:100%;border-bottom:1px solid rgb(221, 221, 221);border-radius:0px 0px 2px 2px;\">\n                                        <div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px 20px;vertical-align:baseline;box-sizing:inherit;\"><div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;zoom:1;\"><a HREF=\"http://www.echojb.com/wireless/2017/01/17/304182.html#\" STYLE=\"border:0px;font-family:inherit;font-size:12px;font-style:inherit;margin:6px 6px 6px 0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(51, 51, 51);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);background-position:0px 0px;float:left;padding-left:17px;line-height:16px;height:16px;background-image:url(http://bdimg.share.baidu.com/static/api/css/../img/share/icons_0_16.png?v=91362611.png);background-repeat:no-repeat;cursor:pointer;\">分享到：</a><a TITLE=\"分享到百度云收藏\" HREF=\"http://www.echojb.com/wireless/2017/01/17/304182.html#\" STYLE=\"border:0px;font-family:inherit;font-size:12px;font-style:inherit;margin:6px 6px 6px 0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);background-position:0px -3068px;float:left;padding-left:17px;line-height:16px;height:16px;background-image:url(http://bdimg.share.baidu.com/static/api/css/../img/share/icons_0_16.png?v=91362611.png);background-repeat:no-repeat;cursor:pointer;\">百度云收藏</a><a TITLE=\"分享到QQ空间\" HREF=\"http://www.echojb.com/wireless/2017/01/17/304182.html#\" STYLE=\"border:0px;font-family:inherit;font-size:12px;font-style:inherit;margin:6px 6px 6px 0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);background-position:0px -52px;float:left;padding-left:17px;line-height:16px;height:16px;background-image:url(http://bdimg.share.baidu.com/static/api/css/../img/share/icons_0_16.png?v=91362611.png);background-repeat:no-repeat;cursor:pointer;\">QQ空间</a><a TITLE=\"分享到百度首页\" HREF=\"http://www.echojb.com/wireless/2017/01/17/304182.html#\" STYLE=\"border:0px;font-family:inherit;font-size:12px;font-style:inherit;margin:6px 6px 6px 0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);background-position:0px -156px;float:left;padding-left:17px;line-height:16px;height:16px;background-image:url(http://bdimg.share.baidu.com/static/api/css/../img/share/icons_0_16.png?v=91362611.png);background-repeat:no-repeat;cursor:pointer;\">百度</a><a TITLE=\"分享到百度贴吧\" HREF=\"http://www.echojb.com/wireless/2017/01/17/304182.html#\" STYLE=\"border:0px;font-family:inherit;font-size:12px;font-style:inherit;margin:6px 6px 6px 0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);background-position:0px -728px;float:left;padding-left:17px;line-height:16px;height:16px;background-image:url(http://bdimg.share.baidu.com/static/api/css/../img/share/icons_0_16.png?v=91362611.png);background-repeat:no-repeat;cursor:pointer;\">贴吧</a><a TITLE=\"分享到新浪微博\" HREF=\"http://www.echojb.com/wireless/2017/01/17/304182.html#\" STYLE=\"border:0px;font-family:inherit;font-size:12px;font-style:inherit;margin:6px 6px 6px 0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);background-position:0px -104px;float:left;padding-left:17px;line-height:16px;height:16px;background-image:url(http://bdimg.share.baidu.com/static/api/css/../img/share/icons_0_16.png?v=91362611.png);background-repeat:no-repeat;cursor:pointer;\">新浪</a><a TITLE=\"分享到微信\" HREF=\"http://www.echojb.com/wireless/2017/01/17/304182.html#\" STYLE=\"border:0px;font-family:inherit;font-size:12px;font-style:inherit;margin:6px 6px 6px 0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);background-position:0px -1612px;float:left;padding-left:17px;line-height:16px;height:16px;background-image:url(http://bdimg.share.baidu.com/static/api/css/../img/share/icons_0_16.png?v=91362611.png);background-repeat:no-repeat;cursor:pointer;\">微信</a><a TITLE=\"分享到天涯社区\" HREF=\"http://www.echojb.com/wireless/2017/01/17/304182.html#\" STYLE=\"border:0px;font-family:inherit;font-size:12px;font-style:inherit;margin:6px 6px 6px 0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);background-position:0px -1196px;float:left;padding-left:17px;line-height:16px;height:16px;background-image:url(http://bdimg.share.baidu.com/static/api/css/../img/share/icons_0_16.png?v=91362611.png);background-repeat:no-repeat;cursor:pointer;\">天涯</a><a TITLE=\"分享到邮件分享\" HREF=\"http://www.echojb.com/wireless/2017/01/17/304182.html#\" STYLE=\"border:0px;font-family:inherit;font-size:12px;font-style:inherit;margin:6px 6px 6px 0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);background-position:0px -2340px;float:left;padding-left:17px;line-height:16px;height:16px;background-image:url(http://bdimg.share.baidu.com/static/api/css/../img/share/icons_0_16.png?v=91362611.png);background-repeat:no-repeat;cursor:pointer;\">邮件分享</a><a TITLE=\"分享到复制网址\" HREF=\"http://www.echojb.com/wireless/2017/01/17/304182.html#\" STYLE=\"border:0px;font-family:inherit;font-size:12px;font-style:inherit;margin:6px 6px 6px 0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);background-position:0px -2288px;float:left;padding-left:17px;line-height:16px;height:16px;background-image:url(http://bdimg.share.baidu.com/static/api/css/../img/share/icons_0_16.png?v=91362611.png);background-repeat:no-repeat;cursor:pointer;\">复制网址</a><span STYLE=\"font-family:inherit;font-size:100%;font-style:inherit;visibility:hidden;display:block;height:0px;clear:both;\">.</span></div></div> \n&Tab;&Tab;&Tab;&Tab;&Tab;<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px 20px;vertical-align:baseline;box-sizing:inherit;\">Date：2017-01-17</div>\n&Tab;&Tab;&Tab;&Tab;&Tab;<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px 20px;vertical-align:baseline;box-sizing:inherit;\">Tag：<a HREF=\"http://www.echojb.com/search/search.php?q=%E7%A8%8B%E5%BA%8F\" TARGET=\"_blank\" STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px 10px 0px 0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);overflow-wrap:break-word;word-break:break-all;\"><span STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;\">程序</span></a>　<a HREF=\"http://www.echojb.com/search/search.php?q=%E6%89%8B%E6%9C%BA\" TARGET=\"_blank\" STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px 10px 0px 0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);overflow-wrap:break-word;word-break:break-all;\"><span STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;\">手机</span></a>　<a HREF=\"http://www.echojb.com/search/search.php?q=WIFI\" TARGET=\"_blank\" STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px 10px 0px 0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);overflow-wrap:break-word;word-break:break-all;\"><span STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;\">WIFI</span></a>　<a HREF=\"http://www.echojb.com/search/search.php?q=%E5%88%86%E6%9E%90\" TARGET=\"_blank\" STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px 10px 0px 0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);overflow-wrap:break-word;word-break:break-all;\"><span STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;\">分析</span></a>　<a HREF=\"http://www.echojb.com/search/search.php?q=MAC\" TARGET=\"_blank\" STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px 10px 0px 0px;vertical-align:baseline;box-sizing:inherit;color:rgb(68, 68, 68);text-decoration:none;-webkit-tap-highlight-color:rgba(255, 0, 0, 0);overflow-wrap:break-word;word-break:break-all;\"><span STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;\">MAC</span></a>　</div>\n&Tab;&Tab;&Tab;&Tab;</div>\n&Tab;&Tab;&Tab;</div>\n\n&Tab;&Tab;&Tab;&Tab;<div STYLE=\"border:0px;font-family:inherit;font-size:100%;font-style:inherit;margin:0px;outline:0px;padding:0px;vertical-align:baseline;box-sizing:inherit;clear:both;\"></div>\n&Tab;</div>\n\n&Tab;</div></div></span></div></div></div></div></div></div>\n</div>\n</en-note>      ",
      "content_path": null,
      "diff_base_variant_id": null,
      "metadata": {
        "checksum": "86fdb3b54777ac8abc157659cc1696558ed28f3f70d45de218850e06f0691f3c",
        "path": "backups/2023年6月/IT技术/Linux系统无线网络抓包程序(分析手机WIFI MAC地址)-echojb.com.html"
      }
    },
    {
      "id": "b005c446-07a6-402c-9e99-ee7d115423d6",
      "note_id": "3ce6c540-82b4-4160-a584-c46c7f5c4ec7",
      "variant_type": "clean_text",
      "version": 1,
      "created_by": "evernote_ingest:v0",
      "created_at": "2025-11-10T15:43:30.873794Z",
      "content": "---\ntitle: Linux系统无线网络抓包程序(分析手机WIFI MAC地址)-echojb.com\nupdated: 2018-11-09 08:42:57Z\ncreated: 2018-11-09 08:42:57Z\nsource: http://www.echojb.com/wireless/2017/01/17/304182.html\n---\n\nLinux系统无线网络抓包程序(分析手机WIFI MAC地址)\n\n首先要介绍ieee802.11的帧格式，只有知道帧格式才能正确解析对应字段，拿到我们感兴趣的信息。其次介绍Linux raw socket编程抓包。最后解析ieee802.11数据包，从而获取到MAC地址。实际上，从数据包中可以得到很多信息，这些信息就是后续需要继续进行的事了。\n一、ieee802.11帧格式\nieee802.11帧格式如下图所示：\n\n二、C实现socket抓包\n Linux系统抓包使用SOCK_RAW方式，类型为ETH_P_ALL(表示抓取所有类型的帧，不管是IP帧还是ARP帧)。下面给出代码重要函数代码片段。为减小文章篇幅，保留主要代码函数，至于完整代码，请参阅文章后面的附录。\n1、设置混杂模式\n抓包工具都会开启混杂模式(promisc)，下面是代码：\n// 混杂模式\nbool set_promisc_mode(const char* eth, bool promisc)\n{\n    int org_errno = 0;\n    int fd;\n    struct ifreq ifreq;\n\n    if ((fd = socket(AF_INET, SOCK_DGRAM, 0)) == -1)\n        return false;\n\n    memset(&ifreq, 0, sizeof(ifreq));\n    strncpy(ifreq.ifr_name, eth, IF_NAMESIZE - 1);\n\n    ioctl(fd, SIOCGIFFLAGS, &ifreq);\n\n    // check if eth is up\n    if (!(ifreq.ifr_flags & IFF_UP))\n    {\n        printf(\"%s is not up yet.n\", eth);\n        return false;\n    }\n\n    if (promisc)\n        ifreq.ifr_flags |= IFF_PROMISC;\n    else\n        ifreq.ifr_flags &= ~IFF_PROMISC;\n\n    ioctl(fd, SIOCSIFFLAGS, &ifreq);\n\n    if (close(fd))\n        return false;\n\n    return true;\n}\n2、初始化socket\n初始化socket包括创建RAW socket，绑定指定网卡。\nint init_socket(const char* eth)\n{\n    int ret = 0;\n    int fd = -1;\n\n    // 混杂模式\n    if (!set_promisc_mode(eth, true))\n    {\n        //printf(\"set %s to promisc mode failed.n\", eth);\n        return -1;\n    }\n\n    // 注意与下面绑定时协议一致\n    fd = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_ALL));\n\n    // 绑定网卡\n    struct ifreq req;\n    strcpy(req.ifr_name, eth);\n    ioctl(fd, SIOCGIFINDEX, &req);\n\n    struct sockaddr_ll addr;\n    addr.sll_family = PF_PACKET;\n    addr.sll_ifindex = req.ifr_ifindex;\n    addr.sll_protocol = htons(ETH_P_ALL);\n    ret = bind(fd, (struct sockaddr *)&addr, sizeof(struct sockaddr_ll));\n   \n    return fd;\n}\n\n3、获取网卡信息\n\nint get_hwinfo(int fd, char* eth, unsigned char* mac)\n{\n    struct ifreq ifr;\n\n    memset(&ifr, 0, sizeof(ifr));\n    strncpy(ifr.ifr_name, eth, IFNAMSIZ - 1);\n    ifr.ifr_name[IFNAMSIZ - 1] = '';\n\n    if (ioctl(fd, SIOCGIFHWADDR, &ifr) < 0)\n    {\n        printf(\"Could not get arptypen\");\n        return -1;\n    }\n    printf(\"ARPTYPE %dn\", ifr.ifr_hwaddr.sa_family);\n    memcpy(mac, ifr.ifr_hwaddr.sa_data, 6);\n    return ifr.ifr_hwaddr.sa_family;\n}\n\n注意，函数返回的sa_family十分重要，它是判断抓取的帧类型的依据。跟踪SIOCGIFHWADDR调用过程，发现内核驱动将dev->dev_addr赋值给ifr->ifr_hwaddr.sa_data，而dev->type赋值给ifr->ifr_hwaddr.sa_family。\n4、接收数据\n一般网络接收数据都会使用select模型，使用recv即可收到内核传递的数据。\nint receive_packet(int socket)\n{\n    int ret = 0;\n\n    struct timeval tv;\n\n    static fd_set read_fds;\n\n    tv.tv_sec = 0;\n    tv.tv_usec = 100;\n\n    FD_ZERO(&read_fds);\n    FD_SET(socket, &read_fds);\n\n    ret = select(socket+1, &read_fds, NULL, NULL, &tv);\n\n    if (ret == -1 && errno == EINTR) /* interrupted */\n        return -1;\n    if (ret == 0)\n        return -1;\n    else if (ret < 0)\n        return -1;\n\n    if (FD_ISSET(socket, &read_fds))\n    {\n        memset(buffer, '', BUFFER_SIZE);\n        ret = recv(socket, buffer, BUFFER_SIZE, MSG_DONTWAIT);\n        if (ret <= 0)\n            return -1;\n        //printf(\"--recv len: %dn\", ret);\n        if (debug_level)\n        {\n            dump(buffer, ret);\n            printf(\"====================n\");\n        }\n        if (arphrd == 1)\n            parse_packet(buffer, ret); // ieee802.3包\n        else if (arphrd == 802 || arphrd == 803) // ieee802.11包\n            parse_packet_wlan(buffer, ret);\n    }\n\n    return 0;\n}\n三、解析\n下图是笔者手机发的probe request帧截图(使用tcpdump抓包，再用wireshark查看)。\n\n1、radiotap头部\nradiotap包含大量有用信息，比如SSI信号强度。但我们暂时不需要，直接跳过。它的结构体定义如下：\n// radiotap头部\n// radiotap官网：http://www.radiotap.org/\nstruct ieee80211_radiotap_header {\n        uint8_t        it_version;     /* set to 0 */\n        uint8_t        it_pad;\n        uint16_t       it_len;         /* entire length */\n        uint32_t       it_present;     /* fields present */\n} __attribute__((__packed__));\n\n其中的it_len成员表示整个radiotap头部的大小。因此在代码中直接使用it_len作偏移量计算出ieee802.11头部地址。\n\n2、ieee802.11头部\nieee802.11头部结构体如下：\n// 802.11帧头\nstruct wlan_frame {\n uint16_t fc;\n uint16_t duration;\n uint8_t addr1[6];\n uint8_t addr2[6];\n uint8_t addr3[6];\n uint16_t seq;\n union {\n uint16_t qos;\n uint8_t addr4[6];\n struct {\n uint16_t qos;\n uint32_t ht;\n } __attribute__ ((packed)) ht;\n struct {\n uint8_t addr4[6];\n uint16_t qos;\n uint32_t ht;\n } __attribute__ ((packed)) addr4_qos_ht;\n } u;\n} __attribute__ ((packed));\n从前面的图示知道，addr1为接收方(Receiver)MAC地址，addr2为发送者(Transmitter)MAC地址，addr3为BSSID。不同类型的帧，Receiver和Transmitter不同，对于probe request类型帧来说，Transmitter地址即为所需要的MAC号——因为probe都是广播，目标地址都是ff。\n\n下面是解析ieee802.11的函数代码：\n\nint parse_packet_wlan(const char* buffer, int len)\n{\n    int hdrlen = 0;\n    uint16_t fc = 0;\n uint8_t* ra = NULL;\n uint8_t* ta = NULL;\n uint8_t* bssid = NULL;\n   \n    struct ieee80211_radiotap_header* radiotap_header = NULL;\n    struct wlan_frame* wh = NULL;\n   \n    if (buffer == NULL)\n    {\n        return -1;\n    }\n\n    radiotap_header = (struct ieee80211_radiotap_header*)buffer;\n    // it_len表示整个radiotap信息，包括头部，因此直接跳过到ieee80211头部\n    int radiotap_len = radiotap_header->it_len;\n    wh = (struct wlan_frame*)(buffer+radiotap_len);\n   \n    fc = le16toh(wh->fc); // 传输格式为little endian，要转换成host格式\n    int wlan_type = (fc & 0xfc);\n    int type = (fc & 0xc)>>2;\n    int stype = (fc & 0xf0)>>4;\n //printf(\"fc:0x%x wlan_type 0x%x - type 0x%x - stype 0x%x n\", fc, wlan_type, type, stype);\n   \n    // 数据帧\n    if (type == 0x02)\n    {\n       \n    }\n    // 控制帧\n    else if (type == 0x01)\n    {\n       \n    }\n    // 管理帧\n    else if (type == 0x0)\n    {\n        if (stype == 0x04) // probe帧\n        {\n            ra = wh->addr1;\n            ta = wh->addr2;\n            bssid = wh->addr3;\n            if (ta)\n                printf(\"SRC MAC: [\" MACFMT \"] --> \", MAC2ADDR(ta));\n            if (ra)\n                printf(\"DST MAC: [\" MACFMT \"]\", MAC2ADDR(ra));\n            if (bssid)\n                printf(\" BSSID MAC: [\" MACFMT \"]\", MAC2ADDR(bssid));\n            printf(\"n\");   \n        }\n    else\n    {\n        printf(\"unknown frame.n\");\n        return -1;\n    }\n\n    return 0;\n}\n看上去十分简单，因为我们只需要其中一种帧的MAC地址信息，其它一概忽视。 \n\n下图是扫描probe得到的MAC地址，并且根据OUI查出MAC所属组织名称(代码需修改)：\n \n修改后的版本演示结果如下(代码需修改)：\n\n附代码：\n\n\n\n\n\nA+\n\n分享到：\n百度云收藏\nQQ空间\n百度\n贴吧\n新浪\n微信\n天涯\n邮件分享\n复制网址\n.\n\nDate：2017-01-17\n\nTag：\n程序\n　\n手机\n　\nWIFI\n　\n分析\n　\nMAC",
      "content_path": null,
      "diff_base_variant_id": null,
      "metadata": {
        "language": "en",
        "length": 6351,
        "rule_count": 2,
        "applied_rules": [
          {
            "rule_id": "dedupe_lines",
            "description": "Collapse adjacent duplicate lines",
            "note": "collapsed duplicate adjacent lines"
          },
          {
            "rule_id": "whitespace",
            "description": "Normalize whitespace",
            "note": "collapsed whitespace"
          }
        ]
      }
    }
  ],
  "extractions": [
    {
      "id": "276e47c2-472a-4681-a792-6d1d4d01457f",
      "note_id": "3ce6c540-82b4-4160-a584-c46c7f5c4ec7",
      "extractor": "llm_enhance:v0#qwen3:30b",
      "payload": {
        "summary": "Linux系统下使用C语言通过raw socket抓取无线网络数据包，解析IEEE 802.11帧格式获取手机WIFI MAC地址的技术实现。",
        "keywords": [
          "Linux",
          "无线网络",
          "抓包",
          "MAC地址",
          "IEEE 802.11"
        ],
        "action_items": [
          "无"
        ],
        "source": "qwen3:30b",
        "category_path": [
          "商务",
          "技术创新"
        ],
        "new_category_suggestion": null
      },
      "version": 1,
      "created_at": "2025-11-11T18:20:41.839452Z",
      "created_by": "llm_enhance:v0",
      "quality_score": 0.312
    }
  ],
  "journal": {
    "id": "da7448e1-35c9-48d5-84b5-b0ed042d7b5c",
    "note_id": "3ce6c540-82b4-4160-a584-c46c7f5c4ec7",
    "stage": "ingest",
    "agent_id": "evernote_ingest:v0",
    "started_at": "2025-11-10T15:43:30.873798Z",
    "finished_at": "2025-11-10T15:43:30.873799Z",
    "status": "success",
    "input_ref": {
      "task_id": "529da12d-e00b-45ad-9c7b-1ba38d522686",
      "source_path": "backups/2023年6月/IT技术/Linux系统无线网络抓包程序(分析手机WIFI MAC地址)-echojb.com.html",
      "checksum": "86fdb3b54777ac8abc157659cc1696558ed28f3f70d45de218850e06f0691f3c"
    },
    "output_ref": {
      "ingest_source": "c0fb2541-274e-47ff-ad83-f441abe74577",
      "note": "3ce6c540-82b4-4160-a584-c46c7f5c4ec7",
      "variants": [
        "ac38880f-69a1-42fa-b52b-42c69e626fc3",
        "b005c446-07a6-402c-9e99-ee7d115423d6"
      ]
    },
    "error_detail": null
  },
  "llm": {
    "status": "success",
    "model": "qwen3:30b",
    "updated_at": "2025-11-11T18:20:41.839223Z",
    "latency_seconds": 18.890038833022118,
    "attempts": 1,
    "summary": {
      "summary": "Linux系统下使用C语言通过raw socket抓取无线网络数据包，解析IEEE 802.11帧格式获取手机WIFI MAC地址的技术实现。",
      "keywords": [
        "Linux",
        "无线网络",
        "抓包",
        "MAC地址",
        "IEEE 802.11"
      ],
      "action_items": [
        "无"
      ],
      "source": "qwen3:30b",
      "category_path": [
        "商务",
        "技术创新"
      ],
      "new_category_suggestion": null
    },
    "quality": {
      "score": 0.312,
      "metrics": {
        "input_chars": 6351.0,
        "input_lines": 236.0,
        "summary_chars": 71.0,
        "summary_coverage_ratio": 0.011,
        "keyword_hit_rate": 0.8,
        "action_item_count": 1.0,
        "unique_summary_sentences": 2.0,
        "estimated_read_seconds": 381.1
      }
    }
  }
}