{
  "ingest_source": {
    "id": "6600634d-4a20-4961-aabf-258fb9a29ed9",
    "source_type": "evernote_html",
    "source_path": "/Users/tang/workbench/article-classifier/backups/2023年6月/IT技术/开发OpenWrt路由器上LuCI的模块-lwchsz-ChinaUnix博客.html",
    "collected_at": "2025-11-09T20:05:14.910137Z",
    "external_id": null,
    "title_hint": null,
    "language_hint": "no",
    "captured_at": null,
    "checksum": "de7ff76228f109d8770515344d836451f9f34863ff8d38a4380618cd488ed76e",
    "status": "pending",
    "notes": {
      "batch_id": null
    }
  },
  "note": {
    "id": "2187097d-78c0-41a7-a77a-56903c55a765",
    "ingest_source_id": "6600634d-4a20-4961-aabf-258fb9a29ed9",
    "canonical_title": "开发OpenWrt路由器上LuCI的模块-lwchsz-ChinaUnix博客",
    "language": "no",
    "ingested_at": "2025-11-09T20:05:14.910142Z",
    "created_at": null,
    "status": "active",
    "importance": 0,
    "attributes": {
      "source_filename": "开发OpenWrt路由器上LuCI的模块-lwchsz-ChinaUnix博客.html"
    }
  },
  "variants": [
    {
      "id": "7471ae7c-87e0-4de7-a53c-43a53f2fc0ec",
      "note_id": "2187097d-78c0-41a7-a77a-56903c55a765",
      "variant_type": "raw_html",
      "version": 1,
      "created_by": "evernote_ingest:v0",
      "created_at": "2025-11-09T20:05:14.910145Z",
      "content": "---\ntitle: 开发OpenWrt路由器上LuCI的模块-lwchsz-ChinaUnix博客\nupdated: 2015-12-16 00:24:26Z\ncreated: 2015-12-16 00:24:26Z\nsource: >-\n  http://m.blog.chinaunix.net/uid-26675482-id-4634156.html#0-tsina-1-85203-397232819ff9a47a7b7e80a40613cfe1\n---\n\n\n\n<en-note>\n<div STYLE=\"padding: 0px; font-size: 16px; line-height: 1.25em; min-width: 320px; font-family: 'microsoft yahei', Verdana, Arial, Helvetica, sans-serif; color: rgb(0, 0, 0); -webkit-text-size-adjust: none;\">\n<div STYLE=\"background-color: rgb(215, 229, 240); height: 40px; overflow: hidden; width: 100%; position: relative;\">\n&Tab;<a STYLE=\"color: rgb(0, 0, 0); text-decoration: none;\" HREF=\"http://m.blog.chinaunix.net/\"><img src=\"../_resources/1e05fc686279d14635cbe24880f120e9.png\"  style=\"border: 0px;\" alt=\"\" height=\"40\" hash=\"1e05fc686279d14635cbe24880f120e9\" type=\"image/png\" /></en-media> </a>\n&Tab;<a STYLE=\"color: rgb(0, 0, 0); text-decoration: none; display: block; position: absolute; right: 0px; top: 0px; background-image: url(http://m.blog.chinaunix.net/themes/default/images/fenlei.png); width: 45px; height: 40px; background-size: 45px 40px; background-repeat: no-repeat no-repeat;\"> </a>\n</div>\n\n\n<div STYLE=\"padding: 15px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204);\">\n  <h1 STYLE=\"margin: 0px; padding: 0px 0px 5px; font-size: 20px; display: block;\">开发OpenWrt路由器上LuCI的模块</h1>\n  <p STYLE=\"margin: 0px; padding: 0px; font-size: 12px; line-height: 18px; color: rgb(102, 102, 102);\"><span STYLE=\"float: right;\">2160阅读　0评论</span>2014-11-19　<a STYLE=\"color: rgb(54, 126, 185); text-decoration: none;\" HREF=\"http://m.blog.chinaunix.net/uid/26675482.html\">lwchsz</a><br STYLE=\"\"/>\n    分类：<a STYLE=\"color: rgb(54, 126, 185); text-decoration: none;\" HREF=\"http://m.blog.chinaunix.net/embed.html\">嵌入式</a></p>\n</div>\n<div STYLE=\"border-top-width: 1px; border-top-style: solid; border-top-color: rgb(255, 255, 255); padding: 5px 15px 15px; word-wrap: break-word; word-break: break-all;\">\n 原文地址：http://www.tuicool.com/articles/zaUNfy\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;<strong STYLE=\"\">【文章索引】</strong>\n</p>\n<ol STYLE=\"margin: 0px 0px 0.75em 25px; padding: 0px; list-style: none; line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;<li STYLE=\"margin: 0px; padding: 0px; line-height: 1.8;\">\n&Tab;&Tab;<a STYLE=\"color: rgb(148, 148, 148); text-decoration: none; -webkit-transition: 0.25s; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;\" REL=\"nofollow\" HREF=\"http://www.cnblogs.com/mayswind/p/#para1\">LuCI配置界面开发的框架</a>\n&Tab;</li>\n&Tab;<li STYLE=\"margin: 0px; padding: 0px; line-height: 1.8;\">\n&Tab;&Tab;<a STYLE=\"color: rgb(148, 148, 148); text-decoration: none; -webkit-transition: 0.25s; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;\" REL=\"nofollow\" HREF=\"http://www.cnblogs.com/mayswind/p/#para2\">用Lua和UCI接口开发LuCI配置模块</a>\n&Tab;</li>\n&Tab;<li STYLE=\"margin: 0px; padding: 0px; line-height: 1.8;\">\n&Tab;&Tab;<a STYLE=\"color: rgb(148, 148, 148); text-decoration: none; -webkit-transition: 0.25s; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;\" REL=\"nofollow\" HREF=\"http://www.cnblogs.com/mayswind/p/#para3\">在Bash文件中调用UCI接口&nbsp;<br STYLE=\"\"/>\n</a>\n&Tab;</li>\n&Tab;<li STYLE=\"margin: 0px; padding: 0px; line-height: 1.8;\">\n&Tab;&Tab;<a STYLE=\"color: rgb(148, 148, 148); text-decoration: none; -webkit-transition: 0.25s; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;\" REL=\"nofollow\" HREF=\"http://www.cnblogs.com/mayswind/p/#para4\">编译开发的程序</a>\n&Tab;</li>\n</ol>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;<strong STYLE=\"\">【一、LuCI配置界面开发的框架】</strong>\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;LuCI是OpenWrt上的Web管理界面，LuCI采用了MVC三层架构，同时其使用Lua脚本开发，所以开发LuCI的配置界面不需要编辑任何的Html代码，除非想自己单独去创建网页（View层），否则我们基本上只需要修改Model层就可以了。官方也有一个如何去创建模块的说明文档，虽然写的比较晦涩：<a STYLE=\"color: rgb(148, 148, 148); text-decoration: none; -webkit-transition: 0.25s; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;\" REL=\"nofollow\" TARGET=\"_blank\" HREF=\"http://luci.subsignal.org/trac/wiki/Documentation/ModulesHowTo\">http://luci.subsignal.org/trac/wiki/Documentation/ModulesHowTo</a>\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;要为LuCI增加一个新模块，首先需要创建两个文件，一个位于Controller（/usr/lib/lua/luci/controller/）下，定义模块的入口；另一个位于Model（/usr/lib/lua/luci/model/cbi/）下，为配置模块实际的代码。\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;首先我们定义模块的入口，在/usr/lib/lua/luci/controller/下创建一个lua文件，类似如下：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\"><span STYLE=\"color: rgb(255, 0, 255);\">module</span>(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">luci.controller.控制器名</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, <span STYLE=\"color: rgb(255, 0, 255);\">package.seeall</span><span STYLE=\"color: rgb(0, 0, 0);\">) </span><span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">function</span></span></span><span STYLE=\"\"><span STYLE=\"color: rgb(0, 0, 0);\"> <span STYLE=\"color: rgb(153, 0, 0);\">index</span><span STYLE=\"\">()</span> <span STYLE=\"color: rgb(153, 0, 0);\">entry</span><span STYLE=\"\">(路径</span></span><span STYLE=\"\">, 调用目标, _<span STYLE=\"\">(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;显示名称</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">)</span></span><span STYLE=\"color: rgb(0, 0, 0);\">, 显示顺序)</span></span><span STYLE=\"color: rgb(0, 0, 0);\"> </span><span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(153, 0, 0);\">end</span></span></span><span STYLE=\"color: rgb(0, 0, 255);\"></span></pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;第一行说明了程序和模块的名称，比如在controller/目录创建一个mymodule.lua，那么就可以写成&ldquo;luci.controller.mymodule&rdquo;，如果你的程序比较多，可能分为好几个模块，那么可以在controller下再常见一个子目录，比如controller/myapp/，那么就可以写成&ldquo;luci.controller.myapp.mymodule&rdquo;。\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;接下来的entry表示添加一个新的模块入口，官方给出了entry的定义，其中后两项都是可以为空的：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\">entry(path, target, title=<span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">nil</span></span>, order=<span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">nil</span></span>)</pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;第一项是访问的路径，不过路径是按字符串数组给定的，比如路径按如下方式写&ldquo;{&quot;click&quot;, &quot;here&quot;, &quot;now&quot;}&rdquo;，那么就可以在浏览器里访问&ldquo;http://192.168.1.1/cgi-bin/luci/click/here/now&rdquo;来访问这个脚本。而通常我们希望为管理员菜单添加脚本，那么我们需要按如下方式编写&ldquo;{&quot;admin&quot;, &quot;一级菜单名&quot;, &quot;菜单项名&quot;}&rdquo;，系统会自动在对应的菜单中生成菜单项。比如想在&ldquo;网络&rdquo;菜单下创建一个菜单项，那么一级菜单名可以写为&ldquo;network&rdquo;。\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;第二项为调用目标，调用目标分为三种，分别是执行指定方法（Action）、访问指定页面（Views）以及调用CBI Module。\n</p>\n<ul STYLE=\"margin: 0px 0px 0.75em 25px; padding: 0px; list-style: none; line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;<li STYLE=\"margin: 0px; padding: 0px; line-height: 1.8; list-style-type: disc;\">\n&Tab;&Tab;第一种可以直接调用指定的函数，比如点击菜单项就直接重启路由器等等，比如写为&ldquo;call(&quot;function_name&quot;)&rdquo;，然后在lua文件下编写名为function_name的函数就可以调用了。\n&Tab;</li>\n&Tab;<li STYLE=\"margin: 0px; padding: 0px; line-height: 1.8; list-style-type: disc;\">\n&Tab;&Tab;第二种可以访问指定的页面，比如写为&ldquo;template(&quot;myapp/mymodule&quot;)&rdquo;就可以调用/usr/lib/lua/luci/view/myapp/mymodule.htm文件了。\n&Tab;</li>\n&Tab;<li STYLE=\"margin: 0px; padding: 0px; line-height: 1.8; list-style-type: disc;\">\n&Tab;&Tab;而如果要编写配置页面，那么使用第三种方法无非是最方便的，比如写为&ldquo;cbi(&quot;myapp/mymodule&quot;)&rdquo;就可以调用/usr/lib/lua/luci/model/cbi/myapp/mymodule.lua文件了。\n&Tab;</li>\n</ul>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;而title和order无非是针对管理员菜单来的，可以参考其他的lua文件来决定编写的内容。\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;这里我们创建/usr/lib/lua/luci/controller/njitclient.lua文件，定义我们的入口，代码如下：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\"><span STYLE=\"color: rgb(255, 0, 255);\">module</span>(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">luci.controller.njitclient</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, <span STYLE=\"color: rgb(255, 0, 255);\">package.seeall</span><span STYLE=\"color: rgb(0, 0, 0);\">) </span><span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">function</span></span></span><span STYLE=\"\"><span STYLE=\"color: rgb(0, 0, 0);\"> <span STYLE=\"color: rgb(153, 0, 0);\">index</span><span STYLE=\"\">()</span> <span STYLE=\"color: rgb(153, 0, 0);\">entry</span><span STYLE=\"\">({</span></span><span STYLE=\"\"><span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">admin</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">network</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">njitclient</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>}, cbi<span STYLE=\"\">(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">njitclient</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>)</span>, _<span STYLE=\"\">(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">NJIT Client</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>)</span>, <span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">100</span></span><span STYLE=\"color: rgb(0, 0, 0);\">)</span></span><span STYLE=\"color: rgb(0, 0, 0);\"> </span><span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(153, 0, 0);\">end</span></span></span><span STYLE=\"color: rgb(0, 0, 255);\"></span></pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;<strong STYLE=\"\">【二、&nbsp;<strong STYLE=\"\"><strong STYLE=\"\">用Lua和UCI接口开发LuCI配置模块</strong>&nbsp;</strong>】</strong>\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;我们要做的实际上就是希望能将用户名、密码等信息存储在路由器文件中，同时路由器开机时能根据设定的配置自动运行njit-client，同时我们还希望能动态的禁用和启用njit-client等等。所以最方便的方式就是使用CBI Module，上一节我们也添加了这个调用，那么接下来我们就要根据上边写的路径来创建/usr/lib/lua/luci/model/cbi/njitclient.lua文件。\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;开发LuCI的配置模块有很多种方式，比较基本的可以用SimpleForm，就跟开发普通的Web应用类似，当然最方便的还是使用UCI（Unified Configuration Interface，统一配置接口）的方式，因为使用UCI接口可以使得在LuCI中可以无需考虑配置文件如何存储和读取（这种方式也会自动创建&ldquo;保存&amp;应用&rdquo;、&ldquo;保存&rdquo;以及&ldquo;复位&rdquo;三个按钮），同时在Bash文件中也可以非常方便的存储和读取。\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;对于使用UCI的方式，我们首先需要创建对应的配置文件（如果配置文件不存在的话，访问配置页面将会报错），格式即为linux配置文件的格式，文件需要存储在/etc/config，比如文件路径为&ldquo;/etc/config/njitclient&rdquo;，内容如下：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\"><span STYLE=\"color: rgb(0, 0, 0);\">config login\n    option username </span><span STYLE=\"color: rgb(128, 0, 0);\">&apos;&apos;</span><span STYLE=\"color: rgb(0, 0, 0);\"> option password </span><span STYLE=\"color: rgb(128, 0, 0);\">&apos;&apos;</span><span STYLE=\"color: rgb(0, 0, 0);\"> option ifname </span><span STYLE=\"color: rgb(128, 0, 0);\">&apos;</span><span STYLE=\"color: rgb(128, 0, 0);\">eth0</span><span STYLE=\"color: rgb(128, 0, 0);\">&apos;</span><span STYLE=\"color: rgb(0, 0, 0);\"> option domain </span><span STYLE=\"color: rgb(128, 0, 0);\">&apos;&apos;</span></pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;然后我们要在CBI Module的lua文件中首先需要映射与存储文件的关系，比如：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\"><span STYLE=\"\">m = <span STYLE=\"\">Map(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;配置文件文件名</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;配置页面标题</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;配置页面说明</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>)</span></span></pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;第一个参数即为配置文件存储的文件名，不包含路径，比如按上述创建的话，应该写为&ldquo;njitclient&rdquo;，而第二与第三个参数则是用在来页面上显示的，比如如下所示的图：\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;<img src=\"../_resources/c02b3cc57d0cf112b596c99e8d300089.png\"  style=\"border: 0px none; display: block; width: 100%; max-width: 550px; height: auto; vertical-align: middle; text-align: center; margin: 0px auto;\" alt=\"\" hash=\"c02b3cc57d0cf112b596c99e8d300089\" type=\"image/png\" /></en-media>\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;接下来需要创建与配置文件中对应的Section，Section分为两种，NamedSection和TypedSection，前者根据配置文件中的Section名，而后者根据配置文件中的Section类型，这里我们使用后者，代码如下。同时我们设定不允许增加或删除Section（&ldquo;.addremove = false&rdquo;），以及不显示Section的名称（&ldquo;.anonymous = true&rdquo;）。\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\">s = m:section(TypedSection, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">login</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;&quot;</span></span><span STYLE=\"color: rgb(0, 0, 0);\">)\ns.addremove </span>= <span STYLE=\"color: rgb(0, 0, 255);\">false</span><span STYLE=\"color: rgb(0, 0, 0);\"> s.anonymous </span>= <span STYLE=\"color: rgb(0, 0, 255);\">true</span></pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;接下来我们需要创建Section中不同内容的交互（创建Option），常见的比如有Value（文本框）、ListValue（下拉框）、Flag（选择框）等等，详细的可以参考官方的文档：&nbsp;<a STYLE=\"color: rgb(148, 148, 148); text-decoration: none; -webkit-transition: 0.25s; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;\" REL=\"nofollow\" TARGET=\"_blank\" HREF=\"http://luci.subsignal.org/trac/wiki/Documentation/CBI\">http://luci.subsignal.org/trac/wiki/Documentation/CBI</a>\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;创建Option的过程非常简单，而且创建后系统会无需考虑读取以及写入配置文件的问题，系统都会自动处理。但是根据上述的要求，我们在应用配置以后可能希望启用、禁用或重新启动njit-client，所以我们还需要在页面最后判断用户是否点击了&ldquo;应用&rdquo;按钮，这里与编写asp网页等都是相同的，我们可以通过如下的代码判断是否点击了&ldquo;应用&rdquo;按钮：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\"><span STYLE=\"color: rgb(0, 0, 255);\">local</span> apply = luci.http.formvalue(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">cbi.apply</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">) </span><span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">if</span></span> apply <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">then</span></span> <span STYLE=\"color: rgb(0, 128, 0);\">--[[</span><span STYLE=\"color: rgb(0, 128, 0);\"> 需要处理的代码 </span><span STYLE=\"color: rgb(0, 128, 0);\">]]-- </span><span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">end</span></span></pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;由于剩余的代码都非常简单，所以所以这部分的全部代码见下：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\"><span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">1</span></span> <span STYLE=\"color: rgb(255, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">require</span></span>(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">luci.sys</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">) </span><span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">2</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">3</span></span> m = <span STYLE=\"\">Map</span>(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">njitclient</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, translate(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">NJIT Client</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>), translate(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">Configure NJIT 802.11x client.</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">)) </span><span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">4</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">5</span></span> s = <span STYLE=\"color: rgb(153, 0, 115);\">m:</span>section(<span STYLE=\"\">TypedSection</span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">login</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;&quot;</span></span><span STYLE=\"color: rgb(0, 0, 0);\">) </span><span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">6</span></span> s.addremove = <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">false</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">7</span></span> s.anonymous = <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">true</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">8</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">9</span></span> enable = <span STYLE=\"color: rgb(153, 0, 115);\">s:</span>option(<span STYLE=\"\">Flag</span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">enable</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, translate(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">Enable</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">)) </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">10</span></span> name = <span STYLE=\"color: rgb(153, 0, 115);\">s:</span>option(<span STYLE=\"\">Value</span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">username</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, translate(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">Username</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">)) </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">11</span></span> pass = <span STYLE=\"color: rgb(153, 0, 115);\">s:</span>option(<span STYLE=\"\">Value</span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">password</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, translate(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">Password</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">)) </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">12</span></span> pass.password = <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">true</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">13</span></span> domain = <span STYLE=\"color: rgb(153, 0, 115);\">s:</span>option(<span STYLE=\"\">Value</span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">domain</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, translate(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">Domain</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">)) </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">14</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">15</span></span> ifname = <span STYLE=\"color: rgb(153, 0, 115);\">s:</span>option(<span STYLE=\"\">ListValue</span>, <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">ifname</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span>, translate(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">Interfaces</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">)) </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">16</span></span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">for</span></span> k, v <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">in</span></span> <span STYLE=\"color: rgb(255, 0, 255);\">ipairs</span>(luci.sys.net.devices()) <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">do</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">17</span></span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">if</span></span> v ~= <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">lo</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">then</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">18</span></span> <span STYLE=\"color: rgb(0, 0, 0);\"> <span STYLE=\"color: rgb(153, 0, 115);\">ifname:</span>value(v) </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">19</span></span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">end</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">20</span></span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">end</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">21</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">22</span></span> <span STYLE=\"color: rgb(0, 0, 255);\">local</span> apply = luci.http.formvalue(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">cbi.apply</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">) </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">23</span></span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">if</span></span> apply <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">then</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">24</span></span> <span STYLE=\"color: rgb(255, 0, 255);\">io.popen</span>(<span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">/etc/init.d/njitclient restart</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span><span STYLE=\"color: rgb(0, 0, 0);\">) </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">25</span></span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">end</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">26</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">27</span></span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">return</span></span> m</pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;其中Luci全部类库的函数定义和使用说明可以参考如下地址：<a STYLE=\"color: rgb(148, 148, 148); text-decoration: none; -webkit-transition: 0.25s; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;\" REL=\"nofollow\" TARGET=\"_blank\" HREF=\"http://luci.subsignal.org/api/luci/index.html\">http://luci.subsignal.org/api/luci/index.html</a>\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;<strong STYLE=\"\">【三、在Bash文件中调用UCI接口】</strong>\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;上边我们已经完成了LuCI配置界面的开发，在配置界面中我们已经能读取并保存配置文件了。接下来我们要编写/etc/init.d/njitclient脚本，使程序最终能运行起来。关于UCI接口在脚本文件中的官方说明可以参考：<a STYLE=\"color: rgb(148, 148, 148); text-decoration: none; -webkit-transition: 0.25s; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;\" REL=\"nofollow\" TARGET=\"_blank\" HREF=\"http://wiki.openwrt.org/doc/devel/config-.ing\">http://wiki.openwrt.org/doc/devel/config-scripting</a>\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;要使用UCI调用脚本，首先第一步需要读取配置文件，命令为&ldquo;config_load 配置文件名&rdquo;，比如我们可以这样读入刚才的配置文件：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\">config_<span STYLE=\"\"><span STYLE=\"font-weight: bold;\">load</span> njitclient</span></pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;接下来要遍历配置文件中的Section，可以使用&ldquo;config_foreach 遍历函数名&nbsp;Section类型&rdquo;，例如我们可以这样：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\">config_foreach run_njit <span STYLE=\"color: rgb(0, 0, 255);\">login</span></pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;然后我们去编写名为&ldquo;run_njit&rdquo;的函数，在这个函数中，我们可以使用&ldquo;config_get 变量名 Section名 Section参数名&rdquo;获取变量的值，或者使用&ldquo;config_get_bool 变量名 Section名 Section参数名&rdquo;获取布尔型的值。所以全部的代码见下：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\"><span STYLE=\"color: rgb(0, 128, 128);\"> 1</span> <span STYLE=\"color: rgb(153, 153, 153); font-weight: bold;\">#!/bin/<span STYLE=\"color: rgb(0, 0, 255);\">sh</span></span><span STYLE=\"color: rgb(0, 0, 255);\"></span> /etc/<span STYLE=\"color: rgb(0, 0, 0);\">rc.common </span><span STYLE=\"color: rgb(0, 128, 128);\"> 2</span> START=<span STYLE=\"color: rgb(128, 0, 128);\">50</span> <span STYLE=\"color: rgb(0, 128, 128);\"> 3</span> <span STYLE=\"color: rgb(0, 128, 128);\"> 4</span> <span STYLE=\"color: rgb(0, 0, 0);\">run_njit() </span><span STYLE=\"color: rgb(0, 128, 128);\"> 5</span> <span STYLE=\"color: rgb(0, 0, 0);\">{ </span><span STYLE=\"color: rgb(0, 128, 128);\"> 6</span> <span STYLE=\"color: rgb(0, 0, 0);\"> local enable </span><span STYLE=\"color: rgb(0, 128, 128);\"> 7</span> config_get_bool enable <span STYLE=\"color: rgb(0, 128, 128);\">$<span STYLE=\"color: rgb(128, 0, 128);\">1</span></span><span STYLE=\"color: rgb(128, 0, 128);\"></span><span STYLE=\"color: rgb(0, 0, 0);\"> enable </span><span STYLE=\"color: rgb(0, 128, 128);\"> 8</span> <span STYLE=\"color: rgb(0, 128, 128);\"> 9</span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">if</span></span> <span STYLE=\"\">[ <span STYLE=\"color: rgb(0, 128, 128);\">$enable</span> ]</span>; <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">then</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">10</span> <span STYLE=\"color: rgb(0, 0, 0);\"> local username </span><span STYLE=\"color: rgb(0, 128, 128);\">11</span> <span STYLE=\"color: rgb(0, 0, 0);\"> local password </span><span STYLE=\"color: rgb(0, 128, 128);\">12</span> <span STYLE=\"color: rgb(0, 0, 0);\"> local domain </span><span STYLE=\"color: rgb(0, 128, 128);\">13</span> <span STYLE=\"color: rgb(0, 0, 0);\"> local ifname </span><span STYLE=\"color: rgb(0, 128, 128);\">14</span> <span STYLE=\"color: rgb(0, 128, 128);\">15</span> config_get username <span STYLE=\"color: rgb(0, 128, 128);\">$<span STYLE=\"color: rgb(128, 0, 128);\">1</span></span><span STYLE=\"color: rgb(128, 0, 128);\"></span><span STYLE=\"color: rgb(0, 0, 0);\"> username </span><span STYLE=\"color: rgb(0, 128, 128);\">16</span> config_get password <span STYLE=\"color: rgb(0, 128, 128);\">$<span STYLE=\"color: rgb(128, 0, 128);\">1</span></span><span STYLE=\"color: rgb(128, 0, 128);\"></span><span STYLE=\"color: rgb(0, 0, 0);\"> password </span><span STYLE=\"color: rgb(0, 128, 128);\">17</span> config_get domain <span STYLE=\"color: rgb(0, 128, 128);\">$<span STYLE=\"color: rgb(128, 0, 128);\">1</span></span><span STYLE=\"color: rgb(128, 0, 128);\"></span><span STYLE=\"color: rgb(0, 0, 0);\"> domain </span><span STYLE=\"color: rgb(0, 128, 128);\">18</span> config_get ifname <span STYLE=\"color: rgb(0, 128, 128);\">$<span STYLE=\"color: rgb(128, 0, 128);\">1</span></span><span STYLE=\"color: rgb(128, 0, 128);\"></span><span STYLE=\"color: rgb(0, 0, 0);\"> ifname </span><span STYLE=\"color: rgb(0, 128, 128);\">19</span> <span STYLE=\"color: rgb(0, 128, 128);\">20</span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">if</span></span> <span STYLE=\"\">[ <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(0, 128, 128);\">$domain</span></span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span> != <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;&quot;</span></span> ]</span>; <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">then</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">21</span> njit-client <span STYLE=\"color: rgb(0, 128, 128);\">$username</span>@<span STYLE=\"color: rgb(0, 128, 128);\">$domain</span> <span STYLE=\"color: rgb(0, 128, 128);\">$password</span> <span STYLE=\"color: rgb(0, 128, 128);\">$ifname</span> &amp; <span STYLE=\"color: rgb(0, 128, 128);\">22</span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">else</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">23</span> njit-client <span STYLE=\"color: rgb(0, 128, 128);\">$username</span> <span STYLE=\"color: rgb(0, 128, 128);\">$password</span> <span STYLE=\"color: rgb(0, 128, 128);\">$ifname</span> &amp; <span STYLE=\"color: rgb(0, 128, 128);\">24</span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">fi</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">25</span> <span STYLE=\"color: rgb(0, 128, 128);\">26</span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">echo</span></span> <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">NJIT Client has started.</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span> <span STYLE=\"color: rgb(0, 128, 128);\">27</span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">fi</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">28</span> <span STYLE=\"color: rgb(0, 0, 0);\">} </span><span STYLE=\"color: rgb(0, 128, 128);\">29</span> <span STYLE=\"color: rgb(0, 128, 128);\">30</span> <span STYLE=\"color: rgb(0, 0, 0);\">start() </span><span STYLE=\"color: rgb(0, 128, 128);\">31</span> <span STYLE=\"color: rgb(0, 0, 0);\">{ </span><span STYLE=\"color: rgb(0, 128, 128);\">32</span> <span STYLE=\"color: rgb(0, 0, 0);\"> config_load njitclient </span><span STYLE=\"color: rgb(0, 128, 128);\">33</span> config_foreach run_njit <span STYLE=\"color: rgb(0, 0, 255);\">login</span> <span STYLE=\"color: rgb(0, 128, 128);\">34</span> <span STYLE=\"color: rgb(0, 0, 0);\">} </span><span STYLE=\"color: rgb(0, 128, 128);\">35</span> <span STYLE=\"color: rgb(0, 128, 128);\">36</span> <span STYLE=\"color: rgb(0, 0, 0);\">stop() </span><span STYLE=\"color: rgb(0, 128, 128);\">37</span> <span STYLE=\"color: rgb(0, 0, 0);\">{ </span><span STYLE=\"color: rgb(0, 128, 128);\">38</span> <span STYLE=\"color: rgb(0, 0, 255);\">killall</span> njit-<span STYLE=\"color: rgb(0, 0, 0);\">client </span><span STYLE=\"color: rgb(0, 128, 128);\">39</span> <span STYLE=\"color: rgb(0, 0, 255);\">killall</span><span STYLE=\"color: rgb(0, 0, 0);\"> udhcpc </span><span STYLE=\"color: rgb(0, 128, 128);\">40</span> <span STYLE=\"color: rgb(0, 128, 128);\">41</span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">echo</span></span> <span STYLE=\"color: rgb(128, 0, 0);\"><span STYLE=\"color: rgb(221, 17, 68);\">&quot;</span></span><span STYLE=\"color: rgb(221, 17, 68);\"><span STYLE=\"color: rgb(128, 0, 0);\">NJIT Client has stoped.</span><span STYLE=\"color: rgb(128, 0, 0);\">&quot;</span></span><span STYLE=\"color: rgb(128, 0, 0);\"></span> <span STYLE=\"color: rgb(0, 128, 128);\">42</span> }</pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;<strong STYLE=\"\">【四、&nbsp;<strong STYLE=\"\">编译开发的程序</strong>&nbsp;】</strong>\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;如果按上述内容创建好上述4个文件，那么配置页面和程序就能在OpenWrt上运行起来了。但是如果要想把自己写的程序打包，还需要创建OpenWrt的Makefile来使用OpenWrt的SDK进行编译。\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;关于LuCI上配置Makefile的官方说明可以见这个地址：<a STYLE=\"color: rgb(148, 148, 148); text-decoration: none; -webkit-transition: 0.25s; transition: 0.25s; border-bottom-width: 1px; border-bottom-style: dashed; border-bottom-color: rgb(148, 148, 148); font-style: italic; font-weight: bold;\" REL=\"nofollow\" TARGET=\"_blank\" HREF=\"http://luci.subsignal.org/trac/wiki/Documentation/Modules\">http://luci.subsignal.org/trac/wiki/Documentation/Modules</a>\n</p>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;无非就是定义包的名称（PKG_NAME）、版本和生成次数（PKG_VERSION、PKG_RELEASE）、在menuconfig中的分类说明等（define Package/luci-app-njitclient）以及安装时进行的操作（define Package/luci-app-njitclient/install）等等。其中安装的文件分为三种，分别是配置文件、可执行文件以及其他数据文件，其中配置可执行文件时，会自动加入执行权限的，所以不需要额外进行处理。Makefile全部的代码见下：\n</p>\n<div STYLE=\"line-height: 28.799999237060547px; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n<pre STYLE=\"padding: 0.5em; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; margin-top: 0px; margin-bottom: 1.5em; font-size: 1em; line-height: 1.5em; word-break: break-all; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); overflow-y: auto; background-color: rgb(248, 248, 255);\"><span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">1</span></span> <span STYLE=\"font-weight: bold;\">include</span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">TOPDIR</span>)/<span STYLE=\"color: rgb(0, 0, 0);\">rules.mk </span><span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">2</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">3</span></span> <span STYLE=\"\">PKG_NAME</span><span STYLE=\"color: rgb(153, 0, 115);\">:</span>=luci-app-<span STYLE=\"color: rgb(0, 0, 0);\">njitclient </span><span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">4</span></span> <span STYLE=\"\">PKG_VERSION</span>=<span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">1.0</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">5</span></span> <span STYLE=\"\">PKG_RELEASE</span><span STYLE=\"color: rgb(153, 0, 115);\">:</span>=<span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">1</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">6</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">7</span></span> <span STYLE=\"\">PKG_BUILD_DIR</span><span STYLE=\"color: rgb(153, 0, 115);\">:</span>=<span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">BUILD_DIR</span>)/<span STYLE=\"color: rgb(0, 0, 0);\"><span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">PKG_NAME</span>) </span><span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">8</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"> <span STYLE=\"color: rgb(0, 153, 153);\">9</span></span> <span STYLE=\"font-weight: bold;\">include</span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">INCLUDE_DIR</span>)/<span STYLE=\"color: rgb(0, 0, 0);\">package.mk </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">10</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">11</span></span> define <span STYLE=\"\">Package</span>/luci-app-<span STYLE=\"color: rgb(0, 0, 0);\">njitclient </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">12</span></span> <span STYLE=\"\">SECTION</span><span STYLE=\"color: rgb(153, 0, 115);\">:</span>=<span STYLE=\"color: rgb(0, 0, 0);\">luci </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">13</span></span> <span STYLE=\"\">CATEGORY</span><span STYLE=\"color: rgb(153, 0, 115);\">:</span>=<span STYLE=\"color: rgb(0, 0, 0);\"><span STYLE=\"\">LuCI</span> </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">14</span></span> <span STYLE=\"\">SUBMENU</span><span STYLE=\"color: rgb(153, 0, 115);\">:</span>=<span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">3</span></span><span STYLE=\"color: rgb(0, 0, 0);\">. <span STYLE=\"\">Applications</span> </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">15</span></span> <span STYLE=\"\">TITLE</span><span STYLE=\"color: rgb(153, 0, 115);\">:</span>=<span STYLE=\"\">NJIT</span> <span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">802</span></span><span STYLE=\"color: rgb(0, 153, 153);\">.1</span>X <span STYLE=\"\">Client</span> <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">for</span></span><span STYLE=\"color: rgb(0, 0, 0);\"> <span STYLE=\"\">LuCI</span> </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">16</span></span> <span STYLE=\"\">PKGARCH</span><span STYLE=\"color: rgb(153, 0, 115);\">:</span>=<span STYLE=\"color: rgb(0, 0, 0);\">all </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">17</span></span> <span STYLE=\"color: rgb(0, 0, 0);\">endef </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">18</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">19</span></span> define <span STYLE=\"\">Package</span>/luci-app-njitclient/<span STYLE=\"color: rgb(0, 0, 0);\">description </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">20</span></span> <span STYLE=\"\">This</span> package contains <span STYLE=\"\">LuCI</span> configuration pages <span STYLE=\"color: rgb(0, 0, 255);\"><span STYLE=\"color: rgb(51, 51, 51); font-weight: bold;\">for</span></span><span STYLE=\"color: rgb(0, 0, 0);\"> njit8021xclient. </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">21</span></span> <span STYLE=\"color: rgb(0, 0, 0);\">endef </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">22</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">23</span></span> define <span STYLE=\"\">Build</span>/<span STYLE=\"color: rgb(0, 0, 0);\"><span STYLE=\"\">Prepare</span> </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">24</span></span> <span STYLE=\"color: rgb(0, 0, 0);\">endef </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">25</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">26</span></span> define <span STYLE=\"\">Build</span>/<span STYLE=\"color: rgb(0, 0, 0);\"><span STYLE=\"\">Configure</span> </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">27</span></span> <span STYLE=\"color: rgb(0, 0, 0);\">endef </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">28</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">29</span></span> define <span STYLE=\"\">Build</span>/<span STYLE=\"color: rgb(0, 0, 0);\"><span STYLE=\"\">Compile</span> </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">30</span></span> <span STYLE=\"color: rgb(0, 0, 0);\">endef </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">31</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">32</span></span> define <span STYLE=\"\">Package</span>/luci-app-njitclient/<span STYLE=\"color: rgb(0, 0, 255);\">install</span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">33</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">INSTALL_DIR</span>) <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">1</span></span>)/etc/<span STYLE=\"color: rgb(0, 0, 0);\">config </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">34</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">INSTALL_DIR</span>) <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">1</span></span>)/etc/<span STYLE=\"color: rgb(0, 0, 0);\">init.d </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">35</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">INSTALL_DIR</span>) <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">1</span></span>)/usr/lib/lua/luci/model/<span STYLE=\"color: rgb(0, 0, 0);\">cbi </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">36</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">INSTALL_DIR</span>) <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">1</span></span>)/usr/lib/lua/luci/<span STYLE=\"color: rgb(0, 0, 0);\">controller </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">37</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">38</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">INSTALL_CONF</span>) .<span STYLE=\"color: rgb(0, 153, 38);\">/files/root</span><span STYLE=\"color: rgb(0, 153, 38);\">/etc/config</span><span STYLE=\"color: rgb(0, 153, 38);\">/njitclient $(<span STYLE=\"color: rgb(128, 0, 128);\">1</span>)/etc</span><span STYLE=\"color: rgb(0, 153, 38);\">/config/<span STYLE=\"color: rgb(0, 0, 0);\">njitclient</span></span><span STYLE=\"color: rgb(0, 0, 0);\"> </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">39</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">INSTALL_BIN</span>) .<span STYLE=\"color: rgb(0, 153, 38);\">/files/root</span><span STYLE=\"color: rgb(0, 153, 38);\">/etc/init</span>.d/njitclient <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">1</span></span>)/etc/init.d/<span STYLE=\"color: rgb(0, 0, 0);\">njitclient </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">40</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">INSTALL_DATA</span>) .<span STYLE=\"color: rgb(0, 153, 38);\">/files/root</span><span STYLE=\"color: rgb(0, 153, 38);\">/usr/lib</span><span STYLE=\"color: rgb(0, 153, 38);\">/lua/luci</span><span STYLE=\"color: rgb(0, 153, 38);\">/model/cbi</span><span STYLE=\"color: rgb(0, 153, 38);\">/njitclient.lua $(<span STYLE=\"color: rgb(128, 0, 128);\">1</span>)/usr</span><span STYLE=\"color: rgb(0, 153, 38);\">/lib/lua</span><span STYLE=\"color: rgb(0, 153, 38);\">/luci/model</span><span STYLE=\"color: rgb(0, 153, 38);\">/cbi/<span STYLE=\"color: rgb(0, 0, 0);\">njitclient</span></span><span STYLE=\"color: rgb(0, 0, 0);\">.lua </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">41</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"\">INSTALL_DATA</span>) .<span STYLE=\"color: rgb(0, 153, 38);\">/files/root</span><span STYLE=\"color: rgb(0, 153, 38);\">/usr/lib</span><span STYLE=\"color: rgb(0, 153, 38);\">/lua/luci</span><span STYLE=\"color: rgb(0, 153, 38);\">/controller/njitclient</span>.lua <span STYLE=\"color: rgb(0, 128, 128);\">$(</span><span STYLE=\"color: rgb(128, 0, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">1</span></span>)/usr/lib/lua/luci/controller/<span STYLE=\"color: rgb(0, 0, 0);\">njitclient.lua </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">42</span></span> <span STYLE=\"color: rgb(0, 0, 0);\">endef </span><span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">43</span></span> <span STYLE=\"color: rgb(0, 128, 128);\"><span STYLE=\"color: rgb(0, 153, 153);\">44</span></span> <span STYLE=\"color: rgb(0, 128, 128);\">$(</span>eval <span STYLE=\"color: rgb(0, 128, 128);\">$(</span>call <span STYLE=\"\">BuildPackage</span>,luci-app-njitclient))</pre>\n</div>\n<p STYLE=\"margin: 0px 0px 0.75em; padding: 10px 0px 0px; line-height: 28.799999237060547px; font-size: 16px; word-wrap: break-word; word-break: break-all; text-indent: 1em; color: rgb(51, 51, 51); font-family: 'Helvetica Neue', Helvetica, Tahoma, Arial, STXihei, 'Microsoft YaHei', 微软雅黑, sans-serif; white-space: normal; background-color: rgb(255, 255, 255);\">\n&Tab;接下来在编译目录下的package目录下创建一个文件夹，如njitclient，然后将所有的文件按目录复制到该目录下即可。之后配置好OpenWrt的交叉编译环境后就可以使用OpenWrt SDK进行编译了，由于这类文章较多，故不再赘述，可以参考相关链接3及之后的文章。\n</p>\n<br STYLE=\"\"/>\n<br STYLE=\"\"/>\n<br STYLE=\"\"/>\n</div>\n<div STYLE=\"padding: 12px 15px; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); border-top-width: 1px; border-top-style: solid; border-top-color: rgb(204, 204, 204); line-height: 1.5; font-size: 14px;\">上一篇：<a STYLE=\"color: rgb(54, 126, 185); text-decoration: none;\" HREF=\"http://m.blog.chinaunix.net/uid-26675482-id-4633889.html\">UCI API的使用--OpenWRT </a><br STYLE=\"\"/>\n  下一篇：<a STYLE=\"color: rgb(54, 126, 185); text-decoration: none;\" HREF=\"http://m.blog.chinaunix.net/uid-26675482-id-4634216.html\">openwrt - 入門( opkg, uci, luci )</a></div>\n<div STYLE=\"background-color: rgb(55, 55, 55); width: 100%; padding: 10px 0px; line-height: 1.4; text-align: center; color: rgb(102, 102, 102); font-size: 12px;\">\n<a STYLE=\"color: rgb(102, 102, 102); text-decoration: none;\" HREF=\"http://blog.itpub.net/\">ITPUB博客</a> | <a STYLE=\"color: rgb(102, 102, 102); text-decoration: none;\" HREF=\"http://www.itpub.net/\">ITPUB论坛</a> | <a STYLE=\"color: rgb(102, 102, 102); text-decoration: none;\" HREF=\"http://bbs.chinaunix.net/\">chinaunix论坛</a><br STYLE=\"\"/>\n\n 北京皓辰网域网络信息技术有限公司. 版权所有\n</div>\n&Tab;&Tab;\n\n\n\n</div>\n</en-note>      ",
      "content_path": null,
      "diff_base_variant_id": null,
      "metadata": {
        "checksum": "de7ff76228f109d8770515344d836451f9f34863ff8d38a4380618cd488ed76e",
        "path": "/Users/tang/workbench/article-classifier/backups/2023年6月/IT技术/开发OpenWrt路由器上LuCI的模块-lwchsz-ChinaUnix博客.html"
      }
    },
    {
      "id": "82eb585f-836d-4bae-b0ad-1c6b65c64014",
      "note_id": "2187097d-78c0-41a7-a77a-56903c55a765",
      "variant_type": "clean_text",
      "version": 1,
      "created_by": "evernote_ingest:v0",
      "created_at": "2025-11-09T20:05:14.910148Z",
      "content": "---\ntitle: 开发OpenWrt路由器上LuCI的模块-lwchsz-ChinaUnix博客\nupdated: 2015-12-16 00:24:26Z\ncreated: 2015-12-16 00:24:26Z\nsource: >-\n  http://m.blog.chinaunix.net/uid-26675482-id-4634156.html#0-tsina-1-85203-397232819ff9a47a7b7e80a40613cfe1\n---\n\n开发OpenWrt路由器上LuCI的模块\n\n2160阅读　0评论\n2014-11-19　\nlwchsz\n\n    分类：\n嵌入式\n\n 原文地址：http://www.tuicool.com/articles/zaUNfy\n\n【文章索引】\n\nLuCI配置界面开发的框架\n\n用Lua和UCI接口开发LuCI配置模块\n\n在Bash文件中调用UCI接口 \n\n编译开发的程序\n\n【一、LuCI配置界面开发的框架】\n\n LuCI是OpenWrt上的Web管理界面，LuCI采用了MVC三层架构，同时其使用Lua脚本开发，所以开发LuCI的配置界面不需要编辑任何的Html代码，除非想自己单独去创建网页（View层），否则我们基本上只需要修改Model层就可以了。官方也有一个如何去创建模块的说明文档，虽然写的比较晦涩：\nhttp://luci.subsignal.org/trac/wiki/Documentation/ModulesHowTo\n\n 要为LuCI增加一个新模块，首先需要创建两个文件，一个位于Controller（/usr/lib/lua/luci/controller/）下，定义模块的入口；另一个位于Model（/usr/lib/lua/luci/model/cbi/）下，为配置模块实际的代码。\n\n 首先我们定义模块的入口，在/usr/lib/lua/luci/controller/下创建一个lua文件，类似如下：\n\nmodule\n(\n\"\nluci.controller.控制器名\n\"\n,\npackage.seeall\n)\nfunction\n\nindex\n()\n\nentry\n(路径\n, 调用目标, _\n(\n\"显示名称\n\"\n)\n, 显示顺序)\n\nend\n\n 第一行说明了程序和模块的名称，比如在controller/目录创建一个mymodule.lua，那么就可以写成“luci.controller.mymodule”，如果你的程序比较多，可能分为好几个模块，那么可以在controller下再常见一个子目录，比如controller/myapp/，那么就可以写成“luci.controller.myapp.mymodule”。\n\n 接下来的entry表示添加一个新的模块入口，官方给出了entry的定义，其中后两项都是可以为空的：\n\nentry(path, target, title=\nnil\n, order=\nnil\n)\n\n 第一项是访问的路径，不过路径是按字符串数组给定的，比如路径按如下方式写“{\"click\", \"here\", \"now\"}”，那么就可以在浏览器里访问“http://192.168.1.1/cgi-bin/luci/click/here/now”来访问这个脚本。而通常我们希望为管理员菜单添加脚本，那么我们需要按如下方式编写“{\"admin\", \"一级菜单名\", \"菜单项名\"}”，系统会自动在对应的菜单中生成菜单项。比如想在“网络”菜单下创建一个菜单项，那么一级菜单名可以写为“network”。\n\n 第二项为调用目标，调用目标分为三种，分别是执行指定方法（Action）、访问指定页面（Views）以及调用CBI Module。\n\n 第一种可以直接调用指定的函数，比如点击菜单项就直接重启路由器等等，比如写为“call(\"function_name\")”，然后在lua文件下编写名为function_name的函数就可以调用了。\n\n 第二种可以访问指定的页面，比如写为“template(\"myapp/mymodule\")”就可以调用/usr/lib/lua/luci/view/myapp/mymodule.htm文件了。\n\n 而如果要编写配置页面，那么使用第三种方法无非是最方便的，比如写为“cbi(\"myapp/mymodule\")”就可以调用/usr/lib/lua/luci/model/cbi/myapp/mymodule.lua文件了。\n\n 而title和order无非是针对管理员菜单来的，可以参考其他的lua文件来决定编写的内容。\n\n 这里我们创建/usr/lib/lua/luci/controller/njitclient.lua文件，定义我们的入口，代码如下：\n\nmodule\n(\n\"\nluci.controller.njitclient\n\"\n,\npackage.seeall\n)\nfunction\n\nindex\n()\n\nentry\n({\n\"\nadmin\n\"\n,\n\"\nnetwork\n\"\n,\n\"\nnjitclient\n\"\n}, cbi\n(\n\"\nnjitclient\n\"\n)\n, _\n(\n\"\nNJIT Client\n\"\n)\n,\n100\n)\n\nend\n\n【二、 \n用Lua和UCI接口开发LuCI配置模块\n \n】\n\n 我们要做的实际上就是希望能将用户名、密码等信息存储在路由器文件中，同时路由器开机时能根据设定的配置自动运行njit-client，同时我们还希望能动态的禁用和启用njit-client等等。所以最方便的方式就是使用CBI Module，上一节我们也添加了这个调用，那么接下来我们就要根据上边写的路径来创建/usr/lib/lua/luci/model/cbi/njitclient.lua文件。\n\n 开发LuCI的配置模块有很多种方式，比较基本的可以用SimpleForm，就跟开发普通的Web应用类似，当然最方便的还是使用UCI（Unified Configuration Interface，统一配置接口）的方式，因为使用UCI接口可以使得在LuCI中可以无需考虑配置文件如何存储和读取（这种方式也会自动创建“保存&应用”、“保存”以及“复位”三个按钮），同时在Bash文件中也可以非常方便的存储和读取。\n\n 对于使用UCI的方式，我们首先需要创建对应的配置文件（如果配置文件不存在的话，访问配置页面将会报错），格式即为linux配置文件的格式，文件需要存储在/etc/config，比如文件路径为“/etc/config/njitclient”，内容如下：\n\nconfig login\n    option username\n''\n option password\n''\n option ifname\n'\neth0\n'\n option domain\n''\n\n 然后我们要在CBI Module的lua文件中首先需要映射与存储文件的关系，比如：\n\nm =\nMap(\n\"配置文件文件名\n\"\n,\n\"配置页面标题\n\"\n,\n\"配置页面说明\n\"\n)\n\n 第一个参数即为配置文件存储的文件名，不包含路径，比如按上述创建的话，应该写为“njitclient”，而第二与第三个参数则是用在来页面上显示的，比如如下所示的图：\n\n 接下来需要创建与配置文件中对应的Section，Section分为两种，NamedSection和TypedSection，前者根据配置文件中的Section名，而后者根据配置文件中的Section类型，这里我们使用后者，代码如下。同时我们设定不允许增加或删除Section（“.addremove = false”），以及不显示Section的名称（“.anonymous = true”）。\n\ns = m:section(TypedSection,\n\"\nlogin\n\"\n,\n\"\"\n)\ns.addremove\n=\nfalse\n s.anonymous\n=\ntrue\n\n 接下来我们需要创建Section中不同内容的交互（创建Option），常见的比如有Value（文本框）、ListValue（下拉框）、Flag（选择框）等等，详细的可以参考官方的文档： \nhttp://luci.subsignal.org/trac/wiki/Documentation/CBI\n\n 创建Option的过程非常简单，而且创建后系统会无需考虑读取以及写入配置文件的问题，系统都会自动处理。但是根据上述的要求，我们在应用配置以后可能希望启用、禁用或重新启动njit-client，所以我们还需要在页面最后判断用户是否点击了“应用”按钮，这里与编写asp网页等都是相同的，我们可以通过如下的代码判断是否点击了“应用”按钮：\n\nlocal\n apply = luci.http.formvalue(\n\"\ncbi.apply\n\"\n)\nif\n apply\nthen\n\n--[[\n 需要处理的代码\n]]--\nend\n\n 由于剩余的代码都非常简单，所以所以这部分的全部代码见下：\n\n1\n\nrequire\n(\n\"\nluci.sys\n\"\n)\n\n2\n\n3\n m =\nMap\n(\n\"\nnjitclient\n\"\n, translate(\n\"\nNJIT Client\n\"\n), translate(\n\"\nConfigure NJIT 802.11x client.\n\"\n))\n\n4\n\n5\n s =\nm:\nsection(\nTypedSection\n,\n\"\nlogin\n\"\n,\n\"\"\n)\n\n6\n s.addremove =\nfalse\n\n7\n s.anonymous =\ntrue\n\n8\n\n9\n enable =\ns:\noption(\nFlag\n,\n\"\nenable\n\"\n, translate(\n\"\nEnable\n\"\n))\n10\n name =\ns:\noption(\nValue\n,\n\"\nusername\n\"\n, translate(\n\"\nUsername\n\"\n))\n11\n pass =\ns:\noption(\nValue\n,\n\"\npassword\n\"\n, translate(\n\"\nPassword\n\"\n))\n12\n pass.password =\ntrue\n\n13\n domain =\ns:\noption(\nValue\n,\n\"\ndomain\n\"\n, translate(\n\"\nDomain\n\"\n))\n14\n\n15\n ifname =\ns:\noption(\nListValue\n,\n\"\nifname\n\"\n, translate(\n\"\nInterfaces\n\"\n))\n16\n\nfor\n k, v\nin\n\nipairs\n(luci.sys.net.devices())\ndo\n\n17\n\nif\n v ~=\n\"\nlo\n\"\n\nthen\n\n18\n\nifname:\nvalue(v)\n19\n\nend\n\n20\n\nend\n\n21\n\n22\n\nlocal\n apply = luci.http.formvalue(\n\"\ncbi.apply\n\"\n)\n23\n\nif\n apply\nthen\n\n24\n\nio.popen\n(\n\"\n/etc/init.d/njitclient restart\n\"\n)\n25\n\nend\n\n26\n\n27\n\nreturn\n m\n\n 其中Luci全部类库的函数定义和使用说明可以参考如下地址：\nhttp://luci.subsignal.org/api/luci/index.html\n\n【三、在Bash文件中调用UCI接口】\n\n 上边我们已经完成了LuCI配置界面的开发，在配置界面中我们已经能读取并保存配置文件了。接下来我们要编写/etc/init.d/njitclient脚本，使程序最终能运行起来。关于UCI接口在脚本文件中的官方说明可以参考：\nhttp://wiki.openwrt.org/doc/devel/config-scripting\n\n 要使用UCI调用脚本，首先第一步需要读取配置文件，命令为“config_load 配置文件名”，比如我们可以这样读入刚才的配置文件：\n\nconfig_\nload\n njitclient\n\n 接下来要遍历配置文件中的Section，可以使用“config_foreach 遍历函数名 Section类型”，例如我们可以这样：\n\nconfig_foreach run_njit\nlogin\n\n 然后我们去编写名为“run_njit”的函数，在这个函数中，我们可以使用“config_get 变量名 Section名 Section参数名”获取变量的值，或者使用“config_get_bool 变量名 Section名 Section参数名”获取布尔型的值。所以全部的代码见下：\n\n 1\n\n#!/bin/\nsh\n /etc/\nrc.common\n 2\n START=\n50\n\n 3\n\n 4\n\nrun_njit()\n 5\n\n{\n 6\n\n local enable\n 7\n config_get_bool enable\n$\n1\n enable\n 8\n\n 9\n\nif\n\n[\n$enable\n ]\n;\nthen\n\n10\n\n local username\n11\n\n local password\n12\n\n local domain\n13\n\n local ifname\n14\n\n15\n config_get username\n$\n1\n username\n16\n config_get password\n$\n1\n password\n17\n config_get domain\n$\n1\n domain\n18\n config_get ifname\n$\n1\n ifname\n19\n\n20\n\nif\n\n[\n\"\n$domain\n\"\n !=\n\"\"\n ]\n;\nthen\n\n21\n njit-client\n$username\n@\n$domain\n\n$password\n\n$ifname\n &\n22\n\nelse\n\n23\n njit-client\n$username\n\n$password\n\n$ifname\n &\n24\n\nfi\n\n25\n\n26\n\necho\n\n\"\nNJIT Client has started.\n\"\n\n27\n\nfi\n\n28\n\n}\n29\n\n30\n\nstart()\n31\n\n{\n32\n\n config_load njitclient\n33\n config_foreach run_njit\nlogin\n\n34\n\n}\n35\n\n36\n\nstop()\n37\n\n{\n38\n\nkillall\n njit-\nclient\n39\n\nkillall\n udhcpc\n40\n\n41\n\necho\n\n\"\nNJIT Client has stoped.\n\"\n\n42\n }\n\n【四、 \n编译开发的程序\n 】\n\n 如果按上述内容创建好上述4个文件，那么配置页面和程序就能在OpenWrt上运行起来了。但是如果要想把自己写的程序打包，还需要创建OpenWrt的Makefile来使用OpenWrt的SDK进行编译。\n\n 关于LuCI上配置Makefile的官方说明可以见这个地址：\nhttp://luci.subsignal.org/trac/wiki/Documentation/Modules\n\n 无非就是定义包的名称（PKG_NAME）、版本和生成次数（PKG_VERSION、PKG_RELEASE）、在menuconfig中的分类说明等（define Package/luci-app-njitclient）以及安装时进行的操作（define Package/luci-app-njitclient/install）等等。其中安装的文件分为三种，分别是配置文件、可执行文件以及其他数据文件，其中配置可执行文件时，会自动加入执行权限的，所以不需要额外进行处理。Makefile全部的代码见下：\n\n1\n\ninclude\n\n$(\nTOPDIR\n)/\nrules.mk\n\n2\n\n3\n\nPKG_NAME\n:\n=luci-app-\nnjitclient\n\n4\n\nPKG_VERSION\n=\n1.0\n\n5\n\nPKG_RELEASE\n:\n=\n1\n\n6\n\n7\n\nPKG_BUILD_DIR\n:\n=\n$(\nBUILD_DIR\n)/\n$(\nPKG_NAME\n)\n\n8\n\n9\n\ninclude\n\n$(\nINCLUDE_DIR\n)/\npackage.mk\n10\n\n11\n define\nPackage\n/luci-app-\nnjitclient\n12\n\nSECTION\n:\n=\nluci\n13\n\nCATEGORY\n:\n=\nLuCI\n\n14\n\nSUBMENU\n:\n=\n3\n.\nApplications\n\n15\n\nTITLE\n:\n=\nNJIT\n\n802\n.1\nX\nClient\n\nfor\n\nLuCI\n\n16\n\nPKGARCH\n:\n=\nall\n17\n\nendef\n18\n\n19\n define\nPackage\n/luci-app-njitclient/\ndescription\n20\n\nThis\n package contains\nLuCI\n configuration pages\nfor\n njit8021xclient.\n21\n\nendef\n22\n\n23\n define\nBuild\n/\nPrepare\n\n24\n\nendef\n25\n\n26\n define\nBuild\n/\nConfigure\n\n27\n\nendef\n28\n\n29\n define\nBuild\n/\nCompile\n\n30\n\nendef\n31\n\n32\n define\nPackage\n/luci-app-njitclient/\ninstall\n\n33\n\n$(\nINSTALL_DIR\n)\n$(\n1\n)/etc/\nconfig\n34\n\n$(\nINSTALL_DIR\n)\n$(\n1\n)/etc/\ninit.d\n35\n\n$(\nINSTALL_DIR\n)\n$(\n1\n)/usr/lib/lua/luci/model/\ncbi\n36\n\n$(\nINSTALL_DIR\n)\n$(\n1\n)/usr/lib/lua/luci/\ncontroller\n37\n\n38\n\n$(\nINSTALL_CONF\n) .\n/files/root\n/etc/config\n/njitclient $(\n1\n)/etc\n/config/\nnjitclient\n\n39\n\n$(\nINSTALL_BIN\n) .\n/files/root\n/etc/init\n.d/njitclient\n$(\n1\n)/etc/init.d/\nnjitclient\n40\n\n$(\nINSTALL_DATA\n) .\n/files/root\n/usr/lib\n/lua/luci\n/model/cbi\n/njitclient.lua $(\n1\n)/usr\n/lib/lua\n/luci/model\n/cbi/\nnjitclient\n.lua\n41\n\n$(\nINSTALL_DATA\n) .\n/files/root\n/usr/lib\n/lua/luci\n/controller/njitclient\n.lua\n$(\n1\n)/usr/lib/lua/luci/controller/\nnjitclient.lua\n42\n\nendef\n43\n\n44\n\n$(\neval\n$(\ncall\nBuildPackage\n,luci-app-njitclient))\n\n 接下来在编译目录下的package目录下创建一个文件夹，如njitclient，然后将所有的文件按目录复制到该目录下即可。之后配置好OpenWrt的交叉编译环境后就可以使用OpenWrt SDK进行编译了，由于这类文章较多，故不再赘述，可以参考相关链接3及之后的文章。\n\n上一篇：\nUCI API的使用--OpenWRT\n\n  下一篇：\nopenwrt - 入門( opkg, uci, luci )\n\nITPUB博客\n |\nITPUB论坛\n |\nchinaunix论坛\n\n 北京皓辰网域网络信息技术有限公司. 版权所有",
      "content_path": null,
      "diff_base_variant_id": null,
      "metadata": {
        "language": "no",
        "length": 8291,
        "rule_count": 2,
        "applied_rules": [
          {
            "rule_id": "dedupe_lines",
            "description": "Collapse adjacent duplicate lines",
            "note": "collapsed duplicate adjacent lines"
          },
          {
            "rule_id": "whitespace",
            "description": "Normalize whitespace",
            "note": "collapsed whitespace"
          }
        ]
      }
    }
  ],
  "extractions": [],
  "journal": {
    "id": "dbff725b-59da-4174-a07c-e5aaeec87c41",
    "note_id": "2187097d-78c0-41a7-a77a-56903c55a765",
    "stage": "ingest",
    "agent_id": "evernote_ingest:v0",
    "started_at": "2025-11-09T20:05:14.910153Z",
    "finished_at": "2025-11-09T20:05:14.910154Z",
    "status": "success",
    "input_ref": {
      "task_id": "d69dbff4-5d9d-4f9a-81c7-6331ac5d5b48",
      "source_path": "/Users/tang/workbench/article-classifier/backups/2023年6月/IT技术/开发OpenWrt路由器上LuCI的模块-lwchsz-ChinaUnix博客.html",
      "checksum": "de7ff76228f109d8770515344d836451f9f34863ff8d38a4380618cd488ed76e"
    },
    "output_ref": {
      "ingest_source": "6600634d-4a20-4961-aabf-258fb9a29ed9",
      "note": "2187097d-78c0-41a7-a77a-56903c55a765",
      "variants": [
        "7471ae7c-87e0-4de7-a53c-43a53f2fc0ec",
        "82eb585f-836d-4bae-b0ad-1c6b65c64014"
      ]
    },
    "error_detail": null
  }
}