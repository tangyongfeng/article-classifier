{
  "ingest_source": {
    "id": "a1737720-844e-499a-ae15-152021481313",
    "source_type": "evernote_html",
    "source_path": "backups/2023年6月/IT技术/使用tar+lz4_pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- .html",
    "collected_at": "2025-11-10T15:43:32.202604Z",
    "external_id": null,
    "title_hint": null,
    "language_hint": "ca",
    "captured_at": null,
    "checksum": "5d5d6f529ea815ee13615b98648d132ec51025ed728543d9c44d0a92fdc3f7c8",
    "status": "pending",
    "notes": {
      "batch_id": "phase2-backfill-202306"
    }
  },
  "note": {
    "id": "c585725e-2167-43fe-97ce-df6183755c27",
    "ingest_source_id": "a1737720-844e-499a-ae15-152021481313",
    "canonical_title": "使用tar+lz4_pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- ",
    "language": "ca",
    "ingested_at": "2025-11-10T15:43:32.202608Z",
    "created_at": null,
    "status": "active",
    "importance": 0,
    "attributes": {
      "source_filename": "使用tar+lz4_pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- .html"
    }
  },
  "variants": [
    {
      "id": "51576693-d8e3-4092-969a-cdc390800678",
      "note_id": "c585725e-2167-43fe-97ce-df6183755c27",
      "variant_type": "raw_html",
      "version": 1,
      "created_by": "evernote_ingest:v0",
      "created_at": "2025-11-10T15:43:32.202611Z",
      "content": "---\ntitle: 使用tar+lz4/pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- 共学习 共进步！\nupdated: 2018-04-02 11:51:40Z\ncreated: 2018-04-01 00:05:53Z\nsource: http://blogread.cn/it/wap/article/7048?f=wb_blogread\n---\n\n\n<en-note STYLE=\"word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;\"><div STYLE=\"font-size: 16px\"><div><div STYLE=\"background:rgb(214, 234, 247);font-size:14px;text-align:center;font-family:&quot;Microsoft Yahei&quot;, &quot;Helvetica Neue&quot;, &quot;Luxi Sans&quot;, &quot;DejaVu Sans&quot;, Tahoma, &quot;Hiragino Sans GB&quot;, STHeiti;\"><div><div STYLE=\"text-align:left;overflow:hidden;\"><div><div STYLE=\"background:rgb(255, 255, 255);overflow:hidden;border-radius:5px;\">\n&Tab;&Tab;&Tab;&Tab;<div STYLE=\"padding:1px 0px;text-align:center;\"><h2>使用tar+lz4/pigz+ssh更快的数据传输</h2></div>\n&Tab;&Tab;&Tab;&Tab;<div STYLE=\"text-align:right;padding-right:5px;line-height:25px;font-size:12px;\">\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<div></div>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;浏览:1512次&nbsp;&nbsp;<a HREF=\"http://blogread.cn/it/article/7048?f=wb_blogread#original\" STYLE=\"text-decoration:none;\">出处信息</a>\n&Tab;&Tab;&Tab;&Tab;</div>\n\n&Tab;&Tab;&Tab;&Tab;<div STYLE=\"background:rgb(255, 255, 255);line-height:25px;padding:15px 5px;font-size:16px;\">\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<div STYLE=\"float:right;margin:4px;\">\n\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<ins STYLE=\"display:inline-block;width:336px;height:280px;\"><ins STYLE=\"display:inline-table;border:none;height:280px;margin:0;padding:0;position:relative;visibility:visible;width:336px;background-color:transparent;\"><ins STYLE=\"display:block;border:none;height:280px;margin:0;padding:0;position:relative;visibility:visible;width:336px;background-color:transparent;\"><div STYLE=\"left:0;position:absolute;top:0;width:336px;height:280px;\"></div></ins></ins></ins>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;</div>\n&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;<p> &nbsp; &nbsp;前面一篇介绍了如何<a HREF=\"http://blogread.cn/it/article/6776\" TARGET=\"_blank\" STYLE=\"text-decoration:none;\">最大限度的榨取SCP的传输速度</a>，有了这个基础，就可以进一步的使用压缩来加速传输速度了。只使用scp，传输速率最快约90MB，本文通过压缩将把最快传输速率提升到约250MB/s(包括解压的过程)。</p><h3>1. 结论</h3><p> &nbsp; &nbsp;使用tar+lz4+ssh的方式能够获得最大的传输性能：</p><pre><div>time tar -c sendlog/|pv|lz4 -B4|ssh -c arcfour128 &nbsp;\\-o&quot;MACs umac-64@openssh.com&quot; 10.xxx.xxx.36 &quot;lz4 -d |tar -xC /u01/backup_supu&quot;3.91GiB 0:00:16 [ 249MiB/s] real0m16.067suser0m15.553ssys0m16.821s</div></pre><p> &nbsp; &nbsp;<strong>249MB/s，妥妥的。是最原始scp(40MB/s)的6倍，原来400GB传输需要约3小时，现在只需要27分钟了。</strong></p><p> &nbsp; &nbsp;注1：lz4在解压方面的优异表现，使得他在本案例中非常重要。如果无需解压的传输，则可以考虑使用pigz/pbiz2</p><p> &nbsp; &nbsp;注2：使用pv观察，网络流量约80MB，所以使用nc替换ssh并不会有明显的性能提升</p><p> &nbsp; &nbsp;注3：lz4压缩使用-B4(64KB块大小)，解压使用-B7(4MB块大小)，是本案例的测试最优值</p><h3>2. 关于lz4</h3><p> &nbsp; &nbsp;lz4是一个让&quot;人见人爱、花见花开&quot;的压缩算法，能够在多核上很好的扩展，压缩速度和压缩比并没有太大优势(pigz)，但是他的解压速度非常惊人，本案例测试lz4的解压是gunzip的3倍(<a HREF=\"http://pokecraft.first-world.info/wiki/Quick_Benchmark:_Gzip_vs_Bzip2_vs_LZMA_vs_XZ_vs_LZ4_vs_LZO\" TARGET=\"_blank\" STYLE=\"text-decoration:none;\">更多的对比测试</a>)。因为压缩时高效的多核利用，再加上惊艳的解压，lz4已经在非常多重要场合使用了：<a HREF=\"http://www.phoronix.com/scan.php?page=news_item&px=MTQwODY\" TARGET=\"_blank\" STYLE=\"text-decoration:none;\">Linux3.11内核实现了LZ4，并可以使用其压缩和解压kernel image</a> <a HREF=\"https://issues.apache.org/jira/browse/HBASE-5838\" TARGET=\"_blank\" STYLE=\"text-decoration:none;\">HBase:Add an LZ4 compression option to HFile</a>等等(<a HREF=\"https://code.google.com/p/lz4/\" TARGET=\"_blank\" STYLE=\"text-decoration:none;\">参考</a>)。</p><p> &nbsp; &nbsp;对于需要<strong>频繁压缩、实时快速解压</strong>的场景来说，lz4非常适合。</p><h3>3. 性能环境说明</h3><p> &nbsp; &nbsp;这里使用同上一篇文章相同的两台主机环境：ping获得RTT是17ms；使用iperf测试带宽是115MB(参考附录)；</p><p> &nbsp; &nbsp;整个过程有几个阶段：磁盘读取--&gt;打包(tar)--&gt;压缩--&gt;传输--&gt;解压缩--&gt;拆包--&gt;落盘 &nbsp;对应了的速度测试：</p><h4>3.1 磁盘读取和落盘</h4><p> &nbsp; &nbsp;磁盘读取(有page cache)，能到3GB/s；磁盘写入约428MB：</p><pre><div># dd if=./sendlog.tar of=/dev/null bs=4096 count=10485761024002+1 records in1024002+1 records out4194314240 bytes (4.2 GB) copied, 1.33946 s, 3.1 GB/s# dd if=/dev/zero of=./x.zero.file bs=4096 count=10485761048576+0 records in1048576+0 records out4294967296 bytes (4.3 GB) copied, 10.0306 s, 428 MB/s</div></pre><h4>3.2 打包、拆包</h4><p> &nbsp; &nbsp;打包和拆包速度都大于350MB/s：</p><pre><div># time tar -cf sendlog.tar ./sendlog/real0m10.996s# time tar -xf sendlog.tarreal0m11.564s</div></pre><h4>3.3 压缩、解压缩</h4><p> &nbsp; &nbsp;关于各个压缩工具的性能(压缩、解压、压缩率)已经有很多人做了比较，本文不做详细讨论，这里选择gzip/pigz lz4 bzip做本测试的比较：</p><pre>           | input speed | output speed | rate   | speed of decoder\npigz -p 16 | 327.0MB/s   | 57.2MB/s     | 17.5%  | 95  MB/s\nlz4        | 288.0MB/s   | 79.2MB/s     | 27.5%  | 264 MB/s\nbzip2      |   4.9MB/s   | 0.65MB/s     | 13.1%  | 25.6MB /s</pre><p> &nbsp; &nbsp;压缩工具的比较测试参考：<a HREF=\"http://pokecraft.first-world.info/wiki/Quick_Benchmark:_Gzip_vs_Bzip2_vs_LZMA_vs_XZ_vs_LZ4_vs_LZO#Compression_time\" TARGET=\"_blank\" STYLE=\"text-decoration:none;\">Gzip vs Bzip2 vs LZMA vs XZ vs LZ4 vs LZO</a></p><p> &nbsp; &nbsp;可以看到，lz4在压缩率上略微逊色(对比pigz)，但是在解压速度上有这<strong>惊人</strong>的优势。</p><h4>3.4 传输</h4><p> &nbsp; &nbsp;<a HREF=\"http://www.orczhou.com/index.php/2013/11/make-scp-faster-with-cipher-and-compression/\" TARGET=\"_blank\" STYLE=\"text-decoration:none;\">前文介绍了scp</a>，约90MB最快的传输速度。</p><h4>3.5 整体流程</h4><pre>磁盘读取----&gt;打包----&gt;压缩------&gt;传输----&gt;解压缩--&gt;拆包----&gt;落盘\n             |-&gt;tar   |-&gt;gzip    |-&gt;ssh   |-&gt;gzip  |-&gt;tar\n                      |-&gt;bzip2   |-&gt;http  |-&gt;bzip\n                      |-&gt; ...    |-&gt;nc    |-&gt;...\n                      |-&gt;lz4              |-&gt;lz4\n&gt;400MB/s    &gt;350MB/s  79MB/s     90MB/s   72MB/s    &gt;350MB/s &gt;400MB/s</pre><p> &nbsp; &nbsp;<strong>这里可以看到，解压是最大的瓶颈，使用在解压方面最有优势的压缩工具，能让传输获得最大速度。</strong>而lz4正是在解压效率方面有着巨大的优势。</p><p> &nbsp; &nbsp;按照上面lz4的测试，传输速度理论值为264MB/s(此时传输速度为264*27.3%=72MB)，这也是本次测试的理论上限速度。</p><h3>4. 实验测试</h3><p> &nbsp; &nbsp;使用lz4压缩传输：</p><pre><div># time tar -c sendlog/|lz4|ssh -c arcfour128 \\ -o&quot;MACs umac-64@openssh.com&quot; 10.xxx.xx.36 &quot;lz4 -d |tar -xC /u01/backup_supu&quot;real0m25.646sreal0m25.911sreal0m29.019s</div></pre><p> &nbsp; &nbsp;测试三次，分别耗时26s、29s、25.6s，传输的平均速度为：152MB/s，网络带宽占用约41.9MB/s。</p><p> &nbsp; &nbsp;使用pigz的压缩传输：</p><pre><div># time tar -c sendlog/|pigz -p 16|ssh -c arcfour128 \\ -o&quot;MACs umac-64@openssh.com&quot; 10.xxx.xx.36 &quot;gzip -d|tar -xC /u01/backup_supu&quot;rreal0m37.030sreal0m25.911sreal0m29.019s</div></pre><p> &nbsp; &nbsp;测试三次，分别耗时37s、37.2s、35.6s，传输的平均速度为：110.7MB/s，网络带宽占用约19.4MB/s。</p><p> &nbsp; &nbsp;对比发现，在压缩方面pigz与lz4并没有太大区别，但是lz4解压速度非常快，所以在这种需要立刻解压的场景下，lz4轻松胜出(bzip2这种就不需要测试了)。</p><h4>4.1 分析</h4><p> &nbsp; &nbsp;按照第二节中的理论分析，传输速度应该能到260MB，但是上面只有152MB/s，这说明，还有调优的空间。本文作者尚未找到优化办法，下面是一些分析。</p><p> &nbsp; &nbsp;使用pv工具观察到，tar+lz4有约70MB/s的输出：</p><pre><div> time tar -c sendlog/|lz4|pv &gt; /dev/null1.02GiB 0:00:14 [70.8MiB/s] [ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]</div></pre><p> &nbsp; &nbsp;比直接lz4输出，要慢了10%左右(lz约79MB/s)。</p><p> &nbsp; &nbsp;再加上一次网络ssh：</p><pre><div>time tar -c sendlog/|lz4|pv|ssh -c arcfour128 -o &quot;MACs umac-64@openssh.com&quot; 10.xxx.xxx.36 &quot;cat - &gt;/dev/null&quot;1.02GiB 0:00:23 [43.9MiB/s] [ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ]</div></pre><p> &nbsp; &nbsp;比直接lz4输出，要慢了45%左右(lz约79MB/s)；远端再加上解压和拆包，压缩后的传输速度就是41.9MB/s。为什么会下降，还不明了，作者也还没有想到有什么方法能够直接加速这样的管道传输，如果看客有什么建议，不妨分享，看看还能不能优化，继续提升速度。</p><p> &nbsp; &nbsp;<strong>至此，传输速度就能够到150MB/s。比最原始scp(40MB/s)要快了约4倍，原来400GB需要约3小时，现在只需要45分钟了。</strong></p><h3>5. lz4参数测试</h3><p> &nbsp; &nbsp;前面试验发现，整个流程中lz4压缩比预期的要慢45%左右，而这里区别仅仅是一个使用管道(pipe)、一个直接读取。这里尝试通过修改lz4块大小对比，是否有性能提升：</p><p> &nbsp; &nbsp;<a HREF=\"http://www.flickr.com/photos/26825745@N06/10721245923/\" TITLE=\"lz4-with-different-block-size by orczhou, on Flickr\" STYLE=\"text-decoration:none;\"><img src=\"../_resources/7bfd368031e930f1a06c39fad9c3f1bf.jpg\"  type=\"image/jpeg\" hash=\"5e7bf9b6f5e1d20485360a8cf9df8ff8\" alt=\"7bfd368031e930f1a06c39fad9c3f1bf.jpg\" /></en-media></a></p><p> &nbsp; &nbsp;测试命令：</p><pre><div>for i in `seq 4 7`; do time tar -c ./sendlog/|lz4 -B$i |pv &gt; /dev/null ;done1.07GiB 0:00:11 [94.4MiB/s] [ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;]real0m11.640suser0m10.375ssys0m4.308s</div></pre><p> &nbsp; &nbsp;可以看到块大小为64KB的时候，lz的压缩速度有显著提升(31%)。于是，我们在lz4新增参数-B4，看看是否能够提升性能：</p><p> &nbsp; &nbsp;Bang!确实，传输性能提升到了约249MB/s:</p><pre><div>time tar -c sendlog/|pv|lz4 -B4|ssh -c arcfour128 &nbsp;\\-o&quot;MACs umac-64@openssh.com&quot; 10.xxx.xxx.36 &quot;lz4 -d |tar -xC /u01/backup_supu&quot;3.91GiB 0:00:16 [ 249MiB/s] real0m16.067suser0m15.553ssys0m16.821s</div></pre><h3>5. 为什么不用nc</h3><p> &nbsp; &nbsp;就不用它!!!</p><p> &nbsp; &nbsp;* nc不比ssh快；如果压缩后传输，nc比ssh没有优势</p><p> &nbsp; &nbsp;* nc在脚本中不好调用，需要在两端执行命令</p><p> &nbsp; &nbsp;* nc需要一个额外的网络端口</p><p> &nbsp; &nbsp;* nc不加密</p><h3>6. 还能不能更快</h3><p> &nbsp; &nbsp;本案例中，lz4解压缩的速度是264MB/s，这里能够达到249MB/s，应该还有一点点可以榨取，不过我已经没有招了。</p><h3>附录</h3><p> &nbsp; &nbsp;iperf的带宽测试：</p><pre><div>iperf -c 10.xxx.xx.18 -p 3999 -t 30------------------------------------------------------------Client connecting to 10.145.96.18, TCP port 3999TCP window size: 16.0 KByte (default)------------------------------------------------------------[ &nbsp;3] local 10.xx.xx.36 port 43838 connected with 10.xx.xx.18 port 3999[ ID] Interval &nbsp; &nbsp; &nbsp; Transfer &nbsp; &nbsp; Bandwidth[ &nbsp;3] &nbsp;0.0-30.0 sec &nbsp;3.15 GBytes &nbsp; 903 Mbits/seciperf -s -p 3999 -m------------------------------------------------------------Server listening on TCP port 3999TCP window size: 85.3 KByte (default)------------------------------------------------------------[ &nbsp;4] local 10.xx.xx.18 port 3999 connected with 10.xx.xx.36 port 43838[ ID] Interval &nbsp; &nbsp; &nbsp; Transfer &nbsp; &nbsp; Bandwidth[ &nbsp;4] &nbsp;0.0-30.0 sec &nbsp;3.15 GBytes &nbsp; 902 Mbits/sec[ &nbsp;4] MSS size 1448 bytes (MTU 1500 bytes, ethernet)</div></pre><h3>参考阅读</h3><p> &nbsp; &nbsp;* <a HREF=\"https://code.google.com/p/lz4/\" TARGET=\"_blank\" STYLE=\"text-decoration:none;\">lz4@Google code</a></p><p> &nbsp; &nbsp;* <a HREF=\"http://fastcompression.blogspot.hk/\" TARGET=\"_blank\" STYLE=\"text-decoration:none;\">lz4&apos;s details</a></p><p> &nbsp; &nbsp;* <a HREF=\"https://docs.google.com/document/d/1gZbUoLw5hRzJ5Q71oPRN6TO4cRMTZur60qip-TE7BhQ/edit#\" TARGET=\"_blank\" STYLE=\"text-decoration:none;\">LZ4 Streaming Format</a></p>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<div>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<ins STYLE=\"display:inline-block;width:728px;height:90px;\"><ins STYLE=\"display:inline-table;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent;\"><ins STYLE=\"display:block;border:none;height:90px;margin:0;padding:0;position:relative;visibility:visible;width:728px;background-color:transparent;\"><div STYLE=\"left:0;position:absolute;top:0;width:728px;height:90px;\"></div></ins></ins></ins>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;</div>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<div STYLE=\"margin:10px 0px;padding:10px;background:#F3F781;text-align:center;-moz-border-radius:5px;border-radius:5px;\">\n&Tab;&Tab;&Tab;&Tab;&Tab;觉得文章有用？立即：\n<div></div>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;和朋友一起 <strong>共学习 共进步！</strong>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;</div>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<h3>建议继续学习：</h3>\n&Tab;&Tab;&Tab;&Tab;&Tab;<ol>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<li><a HREF=\"http://blogread.cn/it/article/7420?f=sa\" STYLE=\"text-decoration:none;\">Linux shell脚本使用while循环执行ssh的注意事项 &nbsp;&nbsp; <span STYLE=\"font-size:14px;\">(阅读：5232)</span></a></li>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<li><a HREF=\"http://blogread.cn/it/article/4136?f=sa\" STYLE=\"text-decoration:none;\">tar：从压缩包中解压出指定文件 &nbsp;&nbsp; <span STYLE=\"font-size:14px;\">(阅读：4733)</span></a></li>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<li><a HREF=\"http://blogread.cn/it/article/1930?f=sa\" STYLE=\"text-decoration:none;\">在ssh服务里使用chroot &nbsp;&nbsp; <span STYLE=\"font-size:14px;\">(阅读：4160)</span></a></li>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<li><a HREF=\"http://blogread.cn/it/article/2130?f=sa\" STYLE=\"text-decoration:none;\">为什么要用公钥/私钥而不是密码去做SSH身份验证 &nbsp;&nbsp; <span STYLE=\"font-size:14px;\">(阅读：3970)</span></a></li>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<li><a HREF=\"http://blogread.cn/it/article/1148?f=sa\" STYLE=\"text-decoration:none;\">懒人连ssh不输密码若干大法 &nbsp;&nbsp; <span STYLE=\"font-size:14px;\">(阅读：3822)</span></a></li>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<li><a HREF=\"http://blogread.cn/it/article/2586?f=sa\" STYLE=\"text-decoration:none;\">ssh连接超时解决办法 &nbsp;&nbsp; <span STYLE=\"font-size:14px;\">(阅读：3787)</span></a></li>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<li><a HREF=\"http://blogread.cn/it/article/2878?f=sa\" STYLE=\"text-decoration:none;\">如何让ssh登录更加安全 &nbsp;&nbsp; <span STYLE=\"font-size:14px;\">(阅读：3752)</span></a></li>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<li><a HREF=\"http://blogread.cn/it/article/2884?f=sa\" STYLE=\"text-decoration:none;\">ssh命令 &nbsp;&nbsp; <span STYLE=\"font-size:14px;\">(阅读：3538)</span></a></li>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<li><a HREF=\"http://blogread.cn/it/article/3691?f=sa\" STYLE=\"text-decoration:none;\">SSH无密码登录 &nbsp;&nbsp; <span STYLE=\"font-size:14px;\">(阅读：3443)</span></a></li>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<li><a HREF=\"http://blogread.cn/it/article/2009?f=sa\" STYLE=\"text-decoration:none;\">共享会话的ssh连接配置 &nbsp;&nbsp; <span STYLE=\"font-size:14px;\">(阅读：2917)</span></a></li>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;</ol>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;\n&Tab;&Tab;&Tab;&Tab;&Tab;<div STYLE=\"margin:10px 0px;padding:10px;text-align:center;-moz-border-radius:5px;border-radius:5px;\">\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<b>QQ技术交流群：445447336，欢迎加入！</b><br/>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<b>扫一扫订阅我的微信号：IT技术博客大学习</b><br/>\n&Tab;&Tab;&Tab;&Tab;&Tab;&Tab;<div></div>\n&Tab;&Tab;&Tab;&Tab;&Tab;</div>\n&Tab;&Tab;&Tab;&Tab;&Tab;\n\n&Tab;&Tab;&Tab;&Tab;</div>\n\n&Tab;&Tab;&Tab;</div></div></div></div></div></div></div></en-note>      ",
      "content_path": null,
      "diff_base_variant_id": null,
      "metadata": {
        "checksum": "5d5d6f529ea815ee13615b98648d132ec51025ed728543d9c44d0a92fdc3f7c8",
        "path": "backups/2023年6月/IT技术/使用tar+lz4_pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- .html"
      }
    },
    {
      "id": "d9d9df8f-e4e0-4218-a924-36a19dadf107",
      "note_id": "c585725e-2167-43fe-97ce-df6183755c27",
      "variant_type": "clean_text",
      "version": 1,
      "created_by": "evernote_ingest:v0",
      "created_at": "2025-11-10T15:43:32.202614Z",
      "content": "---\ntitle: 使用tar+lz4/pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- 共学习 共进步！\nupdated: 2018-04-02 11:51:40Z\ncreated: 2018-04-01 00:05:53Z\nsource: http://blogread.cn/it/wap/article/7048?f=wb_blogread\n---\n\n使用tar+lz4/pigz+ssh更快的数据传输\n\n 浏览:1512次  \n出处信息\n\n    前面一篇介绍了如何\n最大限度的榨取SCP的传输速度\n，有了这个基础，就可以进一步的使用压缩来加速传输速度了。只使用scp，传输速率最快约90MB，本文通过压缩将把最快传输速率提升到约250MB/s(包括解压的过程)。\n1. 结论\n    使用tar+lz4+ssh的方式能够获得最大的传输性能：\ntime tar -c sendlog/|pv|lz4 -B4|ssh -c arcfour128  \\-o\"MACs umac-64@openssh.com\" 10.xxx.xxx.36 \"lz4 -d |tar -xC /u01/backup_supu\"3.91GiB 0:00:16 [ 249MiB/s] real0m16.067suser0m15.553ssys0m16.821s\n    \n249MB/s，妥妥的。是最原始scp(40MB/s)的6倍，原来400GB传输需要约3小时，现在只需要27分钟了。\n    注1：lz4在解压方面的优异表现，使得他在本案例中非常重要。如果无需解压的传输，则可以考虑使用pigz/pbiz2\n    注2：使用pv观察，网络流量约80MB，所以使用nc替换ssh并不会有明显的性能提升\n    注3：lz4压缩使用-B4(64KB块大小)，解压使用-B7(4MB块大小)，是本案例的测试最优值\n2. 关于lz4\n    lz4是一个让\"人见人爱、花见花开\"的压缩算法，能够在多核上很好的扩展，压缩速度和压缩比并没有太大优势(pigz)，但是他的解压速度非常惊人，本案例测试lz4的解压是gunzip的3倍(\n更多的对比测试\n)。因为压缩时高效的多核利用，再加上惊艳的解压，lz4已经在非常多重要场合使用了：\nLinux3.11内核实现了LZ4，并可以使用其压缩和解压kernel image\n\nHBase:Add an LZ4 compression option to HFile\n等等(\n参考\n)。\n    对于需要\n频繁压缩、实时快速解压\n的场景来说，lz4非常适合。\n3. 性能环境说明\n    这里使用同上一篇文章相同的两台主机环境：ping获得RTT是17ms；使用iperf测试带宽是115MB(参考附录)；\n    整个过程有几个阶段：磁盘读取-->打包(tar)-->压缩-->传输-->解压缩-->拆包-->落盘  对应了的速度测试：\n3.1 磁盘读取和落盘\n    磁盘读取(有page cache)，能到3GB/s；磁盘写入约428MB：\n# dd if=./sendlog.tar of=/dev/null bs=4096 count=10485761024002+1 records in1024002+1 records out4194314240 bytes (4.2 GB) copied, 1.33946 s, 3.1 GB/s# dd if=/dev/zero of=./x.zero.file bs=4096 count=10485761048576+0 records in1048576+0 records out4294967296 bytes (4.3 GB) copied, 10.0306 s, 428 MB/s\n3.2 打包、拆包\n    打包和拆包速度都大于350MB/s：\n# time tar -cf sendlog.tar ./sendlog/real0m10.996s# time tar -xf sendlog.tarreal0m11.564s\n3.3 压缩、解压缩\n    关于各个压缩工具的性能(压缩、解压、压缩率)已经有很多人做了比较，本文不做详细讨论，这里选择gzip/pigz lz4 bzip做本测试的比较：\n           | input speed | output speed | rate   | speed of decoder\npigz -p 16 | 327.0MB/s   | 57.2MB/s     | 17.5%  | 95  MB/s\nlz4        | 288.0MB/s   | 79.2MB/s     | 27.5%  | 264 MB/s\nbzip2      |   4.9MB/s   | 0.65MB/s     | 13.1%  | 25.6MB /s\n    压缩工具的比较测试参考：\nGzip vs Bzip2 vs LZMA vs XZ vs LZ4 vs LZO\n    可以看到，lz4在压缩率上略微逊色(对比pigz)，但是在解压速度上有这\n惊人\n的优势。\n3.4 传输\n    \n前文介绍了scp\n，约90MB最快的传输速度。\n3.5 整体流程\n磁盘读取---->打包---->压缩------>传输---->解压缩-->拆包---->落盘\n             |->tar   |->gzip    |->ssh   |->gzip  |->tar\n                      |->bzip2   |->http  |->bzip\n                      |-> ...    |->nc    |->...\n                      |->lz4              |->lz4\n>400MB/s    >350MB/s  79MB/s     90MB/s   72MB/s    >350MB/s >400MB/s\n    \n这里可以看到，解压是最大的瓶颈，使用在解压方面最有优势的压缩工具，能让传输获得最大速度。\n而lz4正是在解压效率方面有着巨大的优势。\n    按照上面lz4的测试，传输速度理论值为264MB/s(此时传输速度为264*27.3%=72MB)，这也是本次测试的理论上限速度。\n4. 实验测试\n    使用lz4压缩传输：\n# time tar -c sendlog/|lz4|ssh -c arcfour128 \\ -o\"MACs umac-64@openssh.com\" 10.xxx.xx.36 \"lz4 -d |tar -xC /u01/backup_supu\"real0m25.646sreal0m25.911sreal0m29.019s\n    测试三次，分别耗时26s、29s、25.6s，传输的平均速度为：152MB/s，网络带宽占用约41.9MB/s。\n    使用pigz的压缩传输：\n# time tar -c sendlog/|pigz -p 16|ssh -c arcfour128 \\ -o\"MACs umac-64@openssh.com\" 10.xxx.xx.36 \"gzip -d|tar -xC /u01/backup_supu\"rreal0m37.030sreal0m25.911sreal0m29.019s\n    测试三次，分别耗时37s、37.2s、35.6s，传输的平均速度为：110.7MB/s，网络带宽占用约19.4MB/s。\n    对比发现，在压缩方面pigz与lz4并没有太大区别，但是lz4解压速度非常快，所以在这种需要立刻解压的场景下，lz4轻松胜出(bzip2这种就不需要测试了)。\n4.1 分析\n    按照第二节中的理论分析，传输速度应该能到260MB，但是上面只有152MB/s，这说明，还有调优的空间。本文作者尚未找到优化办法，下面是一些分析。\n    使用pv工具观察到，tar+lz4有约70MB/s的输出：\n time tar -c sendlog/|lz4|pv > /dev/null1.02GiB 0:00:14 [70.8MiB/s] [                                 ]\n    比直接lz4输出，要慢了10%左右(lz约79MB/s)。\n    再加上一次网络ssh：\ntime tar -c sendlog/|lz4|pv|ssh -c arcfour128 -o \"MACs umac-64@openssh.com\" 10.xxx.xxx.36 \"cat - >/dev/null\"1.02GiB 0:00:23 [43.9MiB/s] [                                 ]\n    比直接lz4输出，要慢了45%左右(lz约79MB/s)；远端再加上解压和拆包，压缩后的传输速度就是41.9MB/s。为什么会下降，还不明了，作者也还没有想到有什么方法能够直接加速这样的管道传输，如果看客有什么建议，不妨分享，看看还能不能优化，继续提升速度。\n    \n至此，传输速度就能够到150MB/s。比最原始scp(40MB/s)要快了约4倍，原来400GB需要约3小时，现在只需要45分钟了。\n5. lz4参数测试\n    前面试验发现，整个流程中lz4压缩比预期的要慢45%左右，而这里区别仅仅是一个使用管道(pipe)、一个直接读取。这里尝试通过修改lz4块大小对比，是否有性能提升：\n    \n    测试命令：\nfor i in `seq 4 7`; do time tar -c ./sendlog/|lz4 -B$i |pv > /dev/null ;done1.07GiB 0:00:11 [94.4MiB/s] [                          ]real0m11.640suser0m10.375ssys0m4.308s\n    可以看到块大小为64KB的时候，lz的压缩速度有显著提升(31%)。于是，我们在lz4新增参数-B4，看看是否能够提升性能：\n    Bang!确实，传输性能提升到了约249MB/s:\ntime tar -c sendlog/|pv|lz4 -B4|ssh -c arcfour128  \\-o\"MACs umac-64@openssh.com\" 10.xxx.xxx.36 \"lz4 -d |tar -xC /u01/backup_supu\"3.91GiB 0:00:16 [ 249MiB/s] real0m16.067suser0m15.553ssys0m16.821s\n5. 为什么不用nc\n    就不用它!!!\n    * nc不比ssh快；如果压缩后传输，nc比ssh没有优势\n    * nc在脚本中不好调用，需要在两端执行命令\n    * nc需要一个额外的网络端口\n    * nc不加密\n6. 还能不能更快\n    本案例中，lz4解压缩的速度是264MB/s，这里能够达到249MB/s，应该还有一点点可以榨取，不过我已经没有招了。\n附录\n    iperf的带宽测试：\niperf -c 10.xxx.xx.18 -p 3999 -t 30------------------------------------------------------------Client connecting to 10.145.96.18, TCP port 3999TCP window size: 16.0 KByte (default)------------------------------------------------------------[  3] local 10.xx.xx.36 port 43838 connected with 10.xx.xx.18 port 3999[ ID] Interval       Transfer     Bandwidth[  3]  0.0-30.0 sec  3.15 GBytes   903 Mbits/seciperf -s -p 3999 -m------------------------------------------------------------Server listening on TCP port 3999TCP window size: 85.3 KByte (default)------------------------------------------------------------[  4] local 10.xx.xx.18 port 3999 connected with 10.xx.xx.36 port 43838[ ID] Interval       Transfer     Bandwidth[  4]  0.0-30.0 sec  3.15 GBytes   902 Mbits/sec[  4] MSS size 1448 bytes (MTU 1500 bytes, ethernet)\n参考阅读\n    *\nlz4@Google code\n    *\nlz4's details\n    *\nLZ4 Streaming Format\n\n 觉得文章有用？立即：\n\n 和朋友一起\n共学习 共进步！\n\n建议继续学习：\n\nLinux shell脚本使用while循环执行ssh的注意事项   \n(阅读：5232)\n\ntar：从压缩包中解压出指定文件   \n(阅读：4733)\n\n在ssh服务里使用chroot   \n(阅读：4160)\n\n为什么要用公钥/私钥而不是密码去做SSH身份验证   \n(阅读：3970)\n\n懒人连ssh不输密码若干大法   \n(阅读：3822)\n\nssh连接超时解决办法   \n(阅读：3787)\n\n如何让ssh登录更加安全   \n(阅读：3752)\n\nssh命令   \n(阅读：3538)\n\nSSH无密码登录   \n(阅读：3443)\n\n共享会话的ssh连接配置   \n(阅读：2917)\n\nQQ技术交流群：445447336，欢迎加入！\n\n扫一扫订阅我的微信号：IT技术博客大学习",
      "content_path": null,
      "diff_base_variant_id": null,
      "metadata": {
        "language": "ca",
        "length": 5985,
        "rule_count": 1,
        "applied_rules": [
          {
            "rule_id": "whitespace",
            "description": "Normalize whitespace",
            "note": "collapsed whitespace"
          }
        ]
      }
    }
  ],
  "extractions": [
    {
      "id": "8d86c4c2-1bf2-4919-96e9-0fc17f436b28",
      "note_id": "c585725e-2167-43fe-97ce-df6183755c27",
      "extractor": "llm_enhance:v0#fallback",
      "payload": {
        "summary": "--- title: 使用tar+lz4/pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- 共学习 共进步！ updated: 2",
        "keywords": [
          "---",
          "title: 使用tar+lz4/pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- 共学习 共进步！",
          "updated: 2018-04-02 11:51:40Z",
          "created: 2018-04-01 00:05:53Z",
          "source: http://blogread.cn/it/wap/article/7048?f=wb_blogread"
        ],
        "action_items": [
          "无"
        ],
        "source": "fallback",
        "category_path": [
          "Education"
        ],
        "new_category_suggestion": null
      },
      "version": 1,
      "created_at": "2025-11-12T06:21:56.974450Z",
      "created_by": "llm_enhance:v0",
      "quality_score": 0.149
    }
  ],
  "journal": {
    "id": "eec00bbc-7d52-434c-99cf-387c88ff34d0",
    "note_id": "c585725e-2167-43fe-97ce-df6183755c27",
    "stage": "ingest",
    "agent_id": "evernote_ingest:v0",
    "started_at": "2025-11-10T15:43:32.202618Z",
    "finished_at": "2025-11-10T15:43:32.202619Z",
    "status": "success",
    "input_ref": {
      "task_id": "513bc574-84fb-4c85-8bcf-ee0272701680",
      "source_path": "backups/2023年6月/IT技术/使用tar+lz4_pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- .html",
      "checksum": "5d5d6f529ea815ee13615b98648d132ec51025ed728543d9c44d0a92fdc3f7c8"
    },
    "output_ref": {
      "ingest_source": "a1737720-844e-499a-ae15-152021481313",
      "note": "c585725e-2167-43fe-97ce-df6183755c27",
      "variants": [
        "51576693-d8e3-4092-969a-cdc390800678",
        "d9d9df8f-e4e0-4218-a924-36a19dadf107"
      ]
    },
    "error_detail": null
  },
  "llm": {
    "status": "fallback",
    "model": "fallback",
    "updated_at": "2025-11-12T06:21:56.974145Z",
    "latency_seconds": 34.19643820798956,
    "attempts": 3,
    "summary": {
      "summary": "--- title: 使用tar+lz4/pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- 共学习 共进步！ updated: 2",
      "keywords": [
        "---",
        "title: 使用tar+lz4/pigz+ssh更快的数据传输 -- 系统运维 -- IT技术博客大学习 -- 共学习 共进步！",
        "updated: 2018-04-02 11:51:40Z",
        "created: 2018-04-01 00:05:53Z",
        "source: http://blogread.cn/it/wap/article/7048?f=wb_blogread"
      ],
      "action_items": [
        "无"
      ],
      "source": "fallback",
      "category_path": [
        "Education"
      ],
      "new_category_suggestion": null
    },
    "quality": {
      "score": 0.149,
      "metrics": {
        "input_chars": 5985.0,
        "input_lines": 132.0,
        "summary_chars": 80.0,
        "summary_coverage_ratio": 0.013,
        "keyword_hit_rate": 1.0,
        "action_item_count": 1.0,
        "unique_summary_sentences": 1.0,
        "estimated_read_seconds": 359.1
      }
    }
  }
}