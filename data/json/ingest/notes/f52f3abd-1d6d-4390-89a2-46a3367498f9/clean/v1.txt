---
title: 在Android里完美实现基站和WIFI定位 - 混魔MJM的博客 - CSDN博客
updated: 2018-11-05 02:39:37Z
created: 2018-11-05 02:39:37Z
source: https://blog.csdn.net/MJM_49/article/details/77654195
---

转

在Android里完美实现基站和WIFI定位

2017年08月28日 20:32:33

混魔MJM

阅读数：2785

不过其实只要明白了基站/WIFI定位的原理，自己实现基站/WIFI定位其实不难。基站定位一般有几种，第一种是利用手机附近的三个基站进行三角定位，由于每个基站的位置是固定的，利用电磁波在这三个基站间中转所需要时间来算出手机所在的坐标；第二种则是利用获取最近的基站的信息，其中包括基站id，location area code、mobile country code、mobile network
 code和信号强度，将这些数据发送到google的定位web服务里，就能拿到当前所在的位置信息，误差一般在几十米到几百米之内。其中信号强度这个数据很重要，网上很多所谓的手动通过基站和WIFI信息定位的方法误差大都是因为没使用信号强度而导致误差过大。高德也自己做了一个基站库，具体可以google搜索一下。

现在在一些大中型城市里，WIFI已经普及，有私人或企业的WIFI，亦有中国电信的WIFI，通过WIFI信息进行定位，并不需要真正连接上指定的WIFI路由器，只需要探测到有WIFI存在即可，因此当手机使用的不是GSM制式（因为google的基站库里并没在保存太多的CDMA基站）的时候，也可以使用WIFI进行定位，原理也和基站定位一样，必须要拿到WIFI路由器的SSID和信号强度。

由于有些用户默认是将WIFI关闭的，通过API开启WIFI硬件并进行搜索附近的WIFI路由器需要一段时间，怎样才能将手机基站定位和WIFI定位完美结合起来呢，Android提供了一种很好的机制，就是Handler和Looper，Handler和Looper一般用于跨线程传递数据，但当在单线程里使用时，就变成了一个先进先出的消息泵。利用这个消息泵进行调度，就可以将基站定位和WIFI定位完美结合。以下是相关的代码：

CellInfoManager.java

1
import
 java.lang.reflect.Method;
2
import
 java.util.Iterator;
3
import
 java.util.List;
4
import
 org.json.JSONArray;
5
import
 org.json.JSONException;
6
import
 org.json.JSONObject;
7
import
 android.content.Context;
8
import
 android.telephony.CellLocation;
9
import
 android.telephony.NeighboringCellInfo;
10
import
 android.telephony.PhoneStateListener;
11
import
 android.telephony.TelephonyManager;
12
import
 android.telephony.gsm.GsmCellLocation;
13
import
 android.util.Log;
14
public

class

CellInfoManager

{
15
   
private

int
 asu;
16
   
private

int
 bid;
17
   
private

int
 cid;
18
   
private

boolean
 isCdma;
19
   
private

boolean
 isGsm;
20
   
private

int
 lac;
21
   
private

int
 lat;
22
   
private

final
 PhoneStateListener listener;
23
   
private

int
 lng;
24
   
private

int
 mcc;
25
   
private

int
 mnc;
26
   
private

int
 nid;
27
   
private

int
 sid;
28
   
private
 TelephonyManager tel;
29
   
private

boolean
 valid;
30
   
private
 Context context;
31
   
public

CellInfoManager
(Context paramContext)

{
32
      
this
.listener =
new
 CellInfoListener(
this
);
33
       tel = (TelephonyManager) paramContext.getSystemService(Context.TELEPHONY_SERVICE);
34
      
this
.tel.listen(
this
.listener, PhoneStateListener.LISTEN_CELL_LOCATION | PhoneStateListener.LISTEN_SIGNAL_STRENGTH);
35
       context = paramContext;
36
    }
37
   
public

static

int

dBm
(
int
 i)

{
38
      
int
 j;
39
      
if
 (i >=
0
 && i <=
31
)
40
           j = i *
2
 + -
113
;
41
      
else
42
           j =
0
;
43
      
return
 j;
44
    }
45
   
public

int

asu
()

{
46
      
return

this
.asu;
47
    }
48
   
public

int

bid
()

{
49
      
if
 (!
this
.valid)
50
           update();
51
      
return

this
.bid;
52
    }
53
   
public
 JSONObject
cdmaInfo
()

{
54
      
if
 (!isCdma()) {
55
          
return

null
;
56
       }
57
       JSONObject jsonObject =
new
 JSONObject();
58
      
try
 {
59
           jsonObject.put(
"bid"
, bid());
60
           jsonObject.put(
"sid"
, sid());
61
           jsonObject.put(
"nid"
, nid());
62
           jsonObject.put(
"lat"
, lat());
63
           jsonObject.put(
"lng"
, lng());
64
       }
catch
 (JSONException ex) {
65
           jsonObject =
null
;
66
           Log.e(
"CellInfoManager"
, ex.getMessage());
67
       }
68
      
return
 jsonObject;
69
    }
70
   
public
 JSONArray
cellTowers
()

{
71
       JSONArray jsonarray =
new
 JSONArray();
72
      
int
 lat;
73
      
int
 mcc;
74
      
int
 mnc;
75
      
int
 aryCell[] = dumpCells();
76
       lat = lac();
77
       mcc = mcc();
78
       mnc = mnc();
79
      
if
 (aryCell ==
null
 || aryCell.length <
2
) {
80
           aryCell =
new

int
[
2
];
81
           aryCell[
0
] = cid;
82
           aryCell[
1
] = -
60
;
83
       }
84
      
for
 (
int
 i =
0
; i < aryCell.length; i +=
2
) {
85
          
try
 {
86
             
int
 j2 = dBm(i +
1
);
87
              JSONObject jsonobject =
new
 JSONObject();
88
              jsonobject.put(
"cell_id"
, aryCell[i]);
89
              jsonobject.put(
"location_area_code"
, lat);
90
              jsonobject.put(
"mobile_country_code"
, mcc);
91
              jsonobject.put(
"mobile_network_code"
, mnc);
92
              jsonobject.put(
"signal_strength"
, j2);
93
              jsonobject.put(
"age"
,
0
);
94
              jsonarray.put(jsonobject);
95
           }
catch
 (Exception ex) {
96
              ex.printStackTrace();
97
              Log.e(
"CellInfoManager"
, ex.getMessage());
98
           }
99
       }
100
      
if
 (isCdma())
101
           jsonarray =
new
 JSONArray();
102
      
return
 jsonarray;
103
    }
104
   
public

int

cid
()

{
105
      
if
 (!
this
.valid)
106
           update();
107
      
return

this
.cid;
108
    }
109
   
public

int
[] dumpCells() {
110
      
int
[] aryCells;
111
      
if
 (cid() ==
0
) {
112
           aryCells =
new

int
[
0
];
113
          
return
 aryCells;
114
       }
115
       List<NeighboringCellInfo> lsCellInfo =
this
.tel.getNeighboringCellInfo();
116
      
if
 (lsCellInfo ==
null
 || lsCellInfo.size() ==
0
) {
117
           aryCells =
new

int
[
1
];
118
          
int
 i = cid();
119
           aryCells[
0
] = i;
120
          
return
 aryCells;
121
       }
122
      
int
[] arrayOfInt1 =
new

int
[lsCellInfo.size() *
2
 +
2
];
123
      
int
 j =
0
 +
1
;
124
      
int
 k = cid();
125
       arrayOfInt1[
0
] = k;
126
      
int
 m = j +
1
;
127
      
int
 n = asu();
128
       arrayOfInt1[j] = n;
129
       Iterator<NeighboringCellInfo> iter = lsCellInfo.iterator();
130
      
while
 (
true
) {
131
          
if
 (!iter.hasNext()) {
132
             
break
;
133
           }
134
           NeighboringCellInfo localNeighboringCellInfo = (NeighboringCellInfo) iter.next();
135
          
int
 i2 = localNeighboringCellInfo.getCid();
136
          
if
 ((i2 <=
0
) || (i2 ==
65535
))
137
             
continue
;
138
          
int
 i3 = m +
1
;
139
           arrayOfInt1[m] = i2;
140
           m = i3 +
1
;
141
          
int
 i4 = localNeighboringCellInfo.getRssi();
142
           arrayOfInt1[i3] = i4;
143
       }
144
      
int
[] arrayOfInt2 =
new

int
[m];
145
       System.arraycopy(arrayOfInt1,
0
, arrayOfInt2,
0
, m);
146
       aryCells = arrayOfInt2;
147
      
return
 aryCells;
148
    }
149
   
public
 JSONObject
gsmInfo
()

{
150
      
if
 (!isGsm()) {
151
          
return

null
;
152
       }
153
       JSONObject localObject =
null
;
154
      
while
 (
true
) {
155
          
try
 {
156
              JSONObject localJSONObject1 =
new
 JSONObject();
157
              String str1 =
this
.tel.getNetworkOperatorName();
158
              localJSONObject1.put(
"operator"
, str1);
159
              String str2 =
this
.tel.getNetworkOperator();
160
             
if
 ((str2.length() ==
5
) || (str2.length() ==
6
)) {
161
                  String str3 = str2.substring(
0
,
3
);
162
                  String str4 = str2.substring(
3
, str2.length());
163
                  localJSONObject1.put(
"mcc"
, str3);
164
                  localJSONObject1.put(
"mnc"
, str4);
165
              }
166
              localJSONObject1.put(
"lac"
, lac());
167
             
int
[] arrayOfInt = dumpCells();
168
              JSONArray localJSONArray1 =
new
 JSONArray();
169
             
int
 k =
0
;
170
             
int
 m = arrayOfInt.length /
2
;
171
             
while
 (
true
) {
172
                 
if
 (k >= m) {
173
                     localJSONObject1.put(
"cells"
, localJSONArray1);
174
                     localObject = localJSONObject1;
175
                    
break
;
176
                  }
177
                 
int
 n = k *
2
;
178
                 
int
 i1 = arrayOfInt[n];
179
                 
int
 i2 = k *
2
 +
1
;
180
                 
int
 i3 = arrayOfInt[i2];
181
                  JSONObject localJSONObject7 =
new
 JSONObject();
182
                  localJSONObject7.put(
"cid"
, i1);
183
                  localJSONObject7.put(
"asu"
, i3);
184
                  localJSONArray1.put(localJSONObject7);
185
                  k +=
1
;
186
              }
187
           }
catch
 (JSONException localJSONException) {
188
              localObject =
null
;
189
           }
190
       }
191
    }
192
   
public

boolean

isCdma
()

{
193
      
if
 (!
this
.valid)
194
           update();
195
      
return

this
.isCdma;
196
    }
197
   
public

boolean

isGsm
()

{
198
      
if
 (!
this
.valid)
199
           update();
200
      
return

this
.isGsm;
201
    }
202
   
public

int

lac
()

{
203
      
if
 (!
this
.valid)
204
           update();
205
      
return

this
.lac;
206
    }
207
   
public

int

lat
()

{
208
      
if
 (!
this
.valid)
209
           update();
210
      
return

this
.lat;
211
    }
212
   
public

int

lng
()

{
213
      
if
 (!
this
.valid)
214
           update();
215
      
return

this
.lng;
216
    }
217
   
public

int

mcc
()

{
218
      
if
 (!
this
.valid)
219
           update();
220
      
return

this
.mcc;
221
    }
222
   
public

int

mnc
()

{
223
      
if
 (!
this
.valid)
224
           update();
225
      
return

this
.mnc;
226
    }
227
   
public

int

nid
()

{
228
      
if
 (!
this
.valid)
229
           update();
230
      
return

this
.nid;
231
    }
232
   
public

float

score
()

{
233
      
float
 f1 =
0f
;
234
      
int
[] aryCells =
null
;
235
      
int
 i =
0
;
236
      
float
 f2 =
0f
;
237
      
if
 (isCdma()) {
238
           f2 =
1065353216
;
239
          
return
 f2;
240
       }
241
      
if
 (isGsm()) {
242
           f1 =
0.0F
;
243
           aryCells = dumpCells();
244
          
int
 j = aryCells.length;
245
          
if
 (i >= j)
246
              f2 = f1;
247
       }
248
      
if
(i <=
0
 ) {
249
          
return

1065353216
;
250
       }
251
      
int
 m = aryCells[i];
252
      
for
 (i =
0
; i < m; i++) {
253
          
if
 ((m <
0
) || (m >
31
))
254
              f1 +=
0.5F
;
255
          
else
256
              f1 +=
1.0F
;
257
       }
258
       f2 = f1;
259
      
return
 f2;
260
    }
261
   
public

int

sid
()

{
262
      
if
 (!
this
.valid)
263
           update();
264
      
return

this
.sid;
265
    }
266
   
public

void

update
()

{
267
      
this
.isGsm =
false
;
268
      
this
.isCdma =
false
;
269
      
this
.cid =
0
;
270
      
this
.lac =
0
;
271
      
this
.mcc =
0
;
272
      
this
.mnc =
0
;
273
       CellLocation cellLocation =
this
.tel.getCellLocation();
274
      
int
 nPhoneType =
this
.tel.getPhoneType();
275
      
if
 (nPhoneType ==
1
 && cellLocation
instanceof
 GsmCellLocation) {
276
          
this
.isGsm =
true
;
277
           GsmCellLocation gsmCellLocation = (GsmCellLocation) cellLocation;
278
          
int
 nGSMCID = gsmCellLocation.getCid();
279
          
if
 (nGSMCID >
0
) {
280
             
if
 (nGSMCID !=
65535
) {
281
                 
this
.cid = nGSMCID;
282
                 
this
.lac = gsmCellLocation.getLac();
283
              }
284
           }
285
       }
286
      
try
 {
287
           String strNetworkOperator =
this
.tel.getNetworkOperator();
288
          
int
 nNetworkOperatorLength = strNetworkOperator.length();
289
          
if
 (nNetworkOperatorLength !=
5
) {
290
             
if
 (nNetworkOperatorLength !=
6
)
291
                  ;
292
           }
else
 {
293
             
this
.mcc = Integer.parseInt(strNetworkOperator.substring(
0
,
3
));
294
             
this
.mnc = Integer.parseInt(strNetworkOperator.substring(
3
, nNetworkOperatorLength));
295
           }
296
          
if
 (
this
.tel.getPhoneType() ==
2
) {
297
             
this
.valid =
true
;
298
              Class<?> clsCellLocation = cellLocation.getClass();
299
              Class<?>[] aryClass =
new
 Class[
0
];
300
              Method localMethod1 = clsCellLocation.getMethod(
"getBaseStationId"
, aryClass);
301
              Method localMethod2 = clsCellLocation.getMethod(
"getSystemId"
, aryClass);
302
              Method localMethod3 = clsCellLocation.getMethod(
"getNetworkId"
, aryClass);
303
              Object[] aryDummy =
new
 Object[
0
];
304
             
this
.bid = ((Integer) localMethod1.invoke(cellLocation, aryDummy)).intValue();
305
             
this
.sid = ((Integer) localMethod2.invoke(cellLocation, aryDummy)).intValue();
306
             
this
.nid = ((Integer) localMethod3.invoke(cellLocation, aryDummy)).intValue();
307
              Method localMethod7 = clsCellLocation.getMethod(
"getBaseStationLatitude"
, aryClass);
308
              Method localMethod8 = clsCellLocation.getMethod(
"getBaseStationLongitude"
, aryClass);
309
             
this
.lat = ((Integer) localMethod7.invoke(cellLocation, aryDummy)).intValue();
310
             
this
.lng = ((Integer) localMethod8.invoke(cellLocation, aryDummy)).intValue();
311
             
this
.isCdma =
true
;
312
           }
313
       }
catch
 (Exception ex) {
314
           Log.e(
"CellInfoManager"
, ex.getMessage());
315
       }
316
    }
317
   
class

CellInfoListener

extends

PhoneStateListener

{
318
       CellInfoListener(CellInfoManager manager) {
319
       }
320
      
public

void

onCellLocationChanged
(CellLocation paramCellLocation)

{
321
           CellInfoManager.
this
.valid =
false
;
322
       }
323
      
public

void

onSignalStrengthChanged
(
int
 paramInt)

{
324
           CellInfoManager.
this
.asu = paramInt;
325
       }
326
    }
327
}

WifiInfoManager.java

1
import
 java.util.ArrayList;
2
import
 java.util.Iterator;
3
import
 java.util.List;
4
import
 org.json.JSONArray;
5
import
 org.json.JSONObject;
6
import
 android.content.Context;
7
import
 android.net.wifi.ScanResult;
8
import
 android.net.wifi.WifiManager;
9
import
 android.util.Log;
10
public

class

WifiInfoManager

{
11
   
private
 WifiManager wifiManager;
12
   
public

WifiInfoManager
(Context paramContext)

{
13
      
this
.wifiManager = (WifiManager) paramContext.getSystemService(Context.WIFI_SERVICE);
14
    }
15
   
public
 List<WifiInfo>
dump
()

{
16
      
if
 (!
this
.wifiManager.isWifiEnabled()) {
17
          
return

new
 ArrayList<WifiInfo>();
18
       }
19
       android.net.wifi.WifiInfo wifiConnection =
this
.wifiManager.getConnectionInfo();
20
       WifiInfo currentWIFI =
null
;
21
      
if
 (wifiConnection !=
null
) {
22
           String s = wifiConnection.getBSSID();
23
          
int
 i = wifiConnection.getRssi();
24
           String s1 = wifiConnection.getSSID();
25
           currentWIFI =
new
 WifiInfo(s, i, s1);
26
       }
27
       ArrayList<WifiInfo> lsAllWIFI =
new
 ArrayList<WifiInfo>();
28
      
if
 (currentWIFI !=
null
) {
29
           lsAllWIFI.add(currentWIFI);
30
       }
31
       List<ScanResult> lsScanResult =
this
.wifiManager.getScanResults();
32
      
for
 (ScanResult result : lsScanResult) {
33
           WifiInfo scanWIFI =
new
 WifiInfo(result);
34
          
if
 (!scanWIFI.equals(currentWIFI))
35
              lsAllWIFI.add(scanWIFI);
36
       }
37
      
return
 lsAllWIFI;
38
    }
39
   
public

boolean

isWifiEnabled
()

{
40
      
return

this
.wifiManager.isWifiEnabled();
41
    }
42
   
public
 JSONArray
wifiInfo
()

{
43
       JSONArray jsonArray =
new
 JSONArray();
44
      
for
 (WifiInfo wifi : dump()) {
45
           JSONObject localJSONObject = wifi.info();
46
           jsonArray.put(localJSONObject);
47
       }
48
      
return
 jsonArray;
49
    }
50
   
public
 WifiManager
wifiManager
()

{
51
      
return

this
.wifiManager;
52
    }
53
   
public
 JSONArray
wifiTowers
()

{
54
       JSONArray jsonArray =
new
 JSONArray();
55
      
try
 {
56
           Iterator<WifiInfo> localObject = dump().iterator();
57
          
while
 (
true
) {
58
             
if
 (!(localObject).hasNext()) {
59
                 
return
 jsonArray;
60
              }
61
              jsonArray.put(localObject.next().wifi_tower());
62
           }
63
       }
catch
 (Exception localException) {
64
           Log.e(
"location"
, localException.getMessage());
65
       }
66
      
return
 jsonArray;
67
    }
68
   
public

class

WifiInfo

implements

Comparable
<
WifiInfo
>
{
69
      
public

int

compareTo
(WifiInfo wifiinfo)

{
70
          
int
 i = wifiinfo.dBm;
71
          
int
 j = dBm;
72
          
return
 i - j;
73
       }
74
      
public

boolean

equals
(Object obj)

{
75
          
boolean
 flag =
false
;
76
          
if
 (obj ==
this
) {
77
              flag =
true
;
78
             
return
 flag;
79
           }
else
 {
80
             
if
 (obj
instanceof
 WifiInfo) {
81
                  WifiInfo wifiinfo = (WifiInfo) obj;
82
                 
int
 i = wifiinfo.dBm;
83
                 
int
 j = dBm;
84
                 
if
 (i == j) {
85
                     String s = wifiinfo.bssid;
86
                     String s1 = bssid;
87
                    
if
 (s.equals(s1)) {
88
                         flag =
true
;
89
                        
return
 flag;
90
                     }
91
                  }
92
                  flag =
false
;
93
              }
else
 {
94
                  flag =
false
;
95
              }
96
           }
97
          
return
 flag;
98
       }
99
      
public

int

hashCode
()

{
100
          
int
 i = dBm;
101
          
int
 j = bssid.hashCode();
102
          
return
 i ^ j;
103
       }
104
      
public
 JSONObject
info
()

{
105
           JSONObject jsonobject =
new
 JSONObject();
106
          
try
 {
107
              String s = bssid;
108
              jsonobject.put(
"mac"
, s);
109
              String s1 = ssid;
110
              jsonobject.put(
"ssid"
, s1);
111
             
int
 i = dBm;
112
              jsonobject.put(
"dbm"
, i);
113
           }
catch
 (Exception ex) {
114
           }
115
          
return
 jsonobject;
116
       }
117
      
public
 JSONObject
wifi_tower
()

{
118
           JSONObject jsonobject =
new
 JSONObject();
119
          
try
 {
120
              String s = bssid;
121
              jsonobject.put(
"mac_address"
, s);
122
             
int
 i = dBm;
123
              jsonobject.put(
"signal_strength"
, i);
124
              String s1 = ssid;
125
              jsonobject.put(
"ssid"
, s1);
126
              jsonobject.put(
"age"
,
0
);
127
           }
catch
 (Exception ex) {
128
           }
129
          
return
 jsonobject;
130
       }
131
      
public

final
 String bssid;
132
      
public

final

int
 dBm;
133
      
public

final
 String ssid;
134
      
public

WifiInfo
(ScanResult scanresult)

{
135
           String s = scanresult.BSSID;
136
           bssid = s;
137
          
int
 i = scanresult.level;
138
           dBm = i;
139
           String s1 = scanresult.SSID;
140
           ssid = s1;
141
       }
142
      
public

WifiInfo
(String s,
int
 i, String s1)

{
143
           bssid = s;
144
           dBm = i;
145
           ssid = s1;
146
       }
147
    }
148
}
CellLocationManager.java

1
import
 java.util.ArrayList;
2
import
 java.util.Iterator;
3
import
 java.util.List;
4
import
 org.apache.http.HttpEntity;
5
import
 org.apache.http.HttpResponse;
6
import
 org.apache.http.client.methods.HttpPost;
7
import
 org.apache.http.entity.StringEntity;
8
import
 org.apache.http.impl.client.DefaultHttpClient;
9
import
 org.apache.http.util.EntityUtils;
10
import
 org.json.JSONArray;
11
import
 org.json.JSONObject;
12
import
 android.content.BroadcastReceiver;
13
import
 android.content.Context;
14
import
 android.content.Intent;
15
import
 android.content.IntentFilter;
16
import
 android.net.ConnectivityManager;
17
import
 android.net.NetworkInfo;
18
import
 android.net.wifi.WifiManager;
19
import
 android.os.Handler;
20
import
 android.os.Message;
21
import
 android.telephony.CellLocation;
22
import
 android.util.Log;
23
import
 android.widget.Toast;
24
import
 com.google.android.photostream.UserTask;
25
public

abstract

class

CellLocationManager

{
26
   
public

static

int
 CHECK_INTERVAL =
15000
;
27
   
public

static

boolean
 ENABLE_WIFI =
true
;
28
   
private

static

boolean
 IS_DEBUG =
false
;
29
   
private

static

final

int
 STATE_COLLECTING =
2
;
30
   
private

static

final

int
 STATE_IDLE =
0
;
31
   
private

static

final

int
 STATE_READY =
1
;
32
   
private

static

final

int
 STATE_SENDING =
3
;
33
   
private

static

final

int
 MESSAGE_INITIALIZE =
1
;
34
   
private

static

final

int
 MESSAGE_COLLECTING_CELL =
2
;
35
   
private

static

final

int
 MESSAGE_COLLECTING_WIFI =
5
;
36
   
private

static

final

int
 MESSAGE_BEFORE_FINISH =
10
;
37
   
private

int
 accuracy;
38
   
private

int
 bid;
39
   
private
 CellInfoManager cellInfoManager;
40
   
private
 Context context;
41
   
private

boolean
 disableWifiAfterScan;
42
   
private

int
[] aryGsmCells;
43
   
private

double
 latitude;
44
   
private

double
 longitude;
45
   
private
 MyLooper looper;
46
   
private

boolean
 paused;
47
   
private

final
 BroadcastReceiver receiver;
48
   
private

long
 startScanTimestamp;
49
   
private

int
 state;
50
   
private
 Task task;
51
   
private

long
 timestamp;
52
   
private

boolean
 waiting4WifiEnable;
53
   
private
 WifiInfoManager wifiManager;
54
   
public

CellLocationManager
(Context context, CellInfoManager cellinfomanager, WifiInfoManager wifiinfomanager)

{
55
       receiver =
new
 CellLocationManagerBroadcastReceiver();
56
      
this
.context = context.getApplicationContext();
57
       cellInfoManager = cellinfomanager;
58
       wifiManager = wifiinfomanager;
59
    }
60
   
private

void

debug
(Object paramObject)

{
61
      
if
 (IS_DEBUG) {
62
           System.out.println(paramObject);
63
           String str = String.valueOf(paramObject);
64
           Toast.makeText(
this
.context, str, Toast.LENGTH_SHORT).show();
65
       }
66
    }
67
   
public

int

accuracy
()

{
68
      
return

this
.accuracy;
69
    }
70
   
public

double

latitude
()

{
71
      
return

this
.latitude;
72
    }
73
   
public

double

longitude
()

{
74
      
return

this
.longitude;
75
    }
76
   
public

abstract

void

onLocationChanged
()
;
77
   
public

void

pause
()

{
78
      
if
 (state >
0
 && !paused) {
79
           looper.removeMessages(MESSAGE_BEFORE_FINISH);
80
           paused =
true
;
81
       }
82
    }
83
   
public

void

requestUpdate
()

{
84
      
if
 (state != STATE_READY) {
85
          
return
;
86
       }
87
      
boolean
 bStartScanSuccessful =
false
;
88
       CellLocation.requestLocationUpdate();
89
       state = STATE_COLLECTING;
90
       looper.sendEmptyMessage(MESSAGE_INITIALIZE);
91
      
if
 (wifiManager.wifiManager().isWifiEnabled()) {
92
           bStartScanSuccessful = wifiManager.wifiManager().startScan();
93
           waiting4WifiEnable =
false
;
94
       }
else
 {
95
           startScanTimestamp = System.currentTimeMillis();
96
          
if
 (!ENABLE_WIFI || !wifiManager.wifiManager().setWifiEnabled(
true
)) {
97
             
int
 nDelay =
0
;
98
             
if
 (!bStartScanSuccessful)
99
                  nDelay =
8000
;
100
              looper.sendEmptyMessageDelayed(MESSAGE_COLLECTING_WIFI, nDelay);
101
              debug(
"CELL UPDATE"
);
102
           }
else
 {
103
              waiting4WifiEnable =
true
;
104
           }
105
       }
106
    }
107
   
public

void

resume
()

{
108
      
if
 (state >
0
 && paused) {
109
           paused =
false
;
110
           looper.removeMessages(MESSAGE_BEFORE_FINISH);
111
           looper.sendEmptyMessage(MESSAGE_BEFORE_FINISH);
112
       }
113
    }
114
   
public

void

start
()

{
115
      
if
 (state <= STATE_IDLE) {
116
           Log.i(
"CellLocationManager"
,
"Starting..."
);
117
           context.registerReceiver(receiver,
new
 IntentFilter(WifiManager.SCAN_RESULTS_AVAILABLE_ACTION));
118
           context.registerReceiver(receiver,
new
 IntentFilter(WifiManager.WIFI_STATE_CHANGED_ACTION));
119
           looper =
new
 MyLooper();
120
           state = STATE_READY;
121
           paused =
false
;
122
           waiting4WifiEnable =
false
;
123
           disableWifiAfterScan =
false
;
124
           debug(
"CELL LOCATION START"
);
125
           requestUpdate();
126
       }
127
    }
128
   
public

void

stop
()

{
129
      
if
 (state > STATE_IDLE) {
130
           context.unregisterReceiver(receiver);
131
           debug(
"CELL LOCATION STOP"
);
132
           looper =
null
;
133
           state = STATE_IDLE;
134
          
if
 (disableWifiAfterScan) {
135
              disableWifiAfterScan =
false
;
136
              wifiManager.wifiManager().setWifiEnabled(
false
);
137
           }
138
       }
139
    }
140
   
public

long

timestamp
()

{
141
      
return

this
.timestamp;
142
    }
143
   
protected

boolean

isConnectedWithInternet
()

{
144
       ConnectivityManager conManager = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);
145
       NetworkInfo networkInfo = conManager.getActiveNetworkInfo();
146
      
if
 (networkInfo !=
null
) {
147
          
return
 networkInfo.isAvailable();
148
       }
149
      
return

false
;
150
    }
151
   
private

class

MyLooper

extends

Handler

{
152
      
private

float
 fCellScore;
153
      
private
 JSONArray objCellTowersJson;
154
      
public

void

handleMessage
(Message paramMessage)

{
155
          
if
(CellLocationManager.
this
.looper !=
this
)
156
             
return
;
157
          
boolean
 flag =
true
;
158
          
switch
 (paramMessage.what) {
159
          
default
:
160
             
break
;
161
          
case
 MESSAGE_INITIALIZE:
162
             
this
.objCellTowersJson =
null
;
163
             
this
.fCellScore =
1.401298E-045F
;
164
          
case
 MESSAGE_COLLECTING_CELL:
165
             
if
 (CellLocationManager.
this
.state != CellLocationManager.STATE_COLLECTING)
166
                 
break
;
167
              JSONArray objCellTowers = CellLocationManager.
this
.cellInfoManager.cellTowers();
168
             
float
 fCellScore = CellLocationManager.
this
.cellInfoManager.score();
169
             
if
 (objCellTowers !=
null
) {
170
                 
float
 fCurrentCellScore =
this
.fCellScore;
171
                 
if
 (fCellScore > fCurrentCellScore) {
172
                    
this
.objCellTowersJson = objCellTowers;
173
                    
this
.fCellScore = fCellScore;
174
                  }
175
              }
176
             
this
.sendEmptyMessageDelayed(MESSAGE_COLLECTING_CELL,
600L
);
177
             
break
;
178
          
case
 MESSAGE_COLLECTING_WIFI:
179
             
if
 (CellLocationManager.
this
.state != CellLocationManager.STATE_COLLECTING)
180
                 
break
;
181
             
this
.removeMessages(MESSAGE_COLLECTING_CELL);
182
             
this
.removeMessages(MESSAGE_BEFORE_FINISH);
183
//             if (CellLocationManager.this.disableWifiAfterScan && CellLocationManager.this.wifiManager.wifiManager().setWifiEnabled(true))
184
//                 CellLocationManager.this.disableWifiAfterScan = false;
185
              CellLocationManager.
this
.state = CellLocationManager.STATE_SENDING;
186
             
if
 (CellLocationManager.
this
.task !=
null
)
187
                  CellLocationManager.
this
.task.cancel(
true
);
188
             
int
[] aryCell =
null
;
189
             
if
 (CellLocationManager.
this
.cellInfoManager.isGsm())
190
                  aryCell = CellLocationManager.
this
.cellInfoManager.dumpCells();
191
             
int
 nBid = CellLocationManager.
this
.cellInfoManager.bid();
192
              CellLocationManager.
this
.task =
new
 CellLocationManager.Task(aryCell, nBid);
193
              JSONArray[] aryJsonArray =
new
 JSONArray[
2
];
194
              aryJsonArray[
0
] =
this
.objCellTowersJson;
195
              aryJsonArray[
1
] = CellLocationManager.
this
.wifiManager.wifiTowers();
196
             
if
(
this
.objCellTowersJson !=
null
)
197
                  Log.i(
"CellTownerJSON"
,
this
.objCellTowersJson.toString());
198
             
if
(aryJsonArray[
1
] !=
null
)
199
                  Log.i(
"WIFITownerJSON"
, aryJsonArray[
1
].toString());
200
              CellLocationManager.
this
.debug(
"Post json"
);
201
              CellLocationManager.
this
.task.execute(aryJsonArray);
202
             
break
;
203
          
case
 MESSAGE_BEFORE_FINISH:
204
             
if
 (CellLocationManager.
this
.state != CellLocationManager.STATE_READY || CellLocationManager.
this
.paused)
205
                 
break
;
206
             
// L7
207
             
if
 (CellLocationManager.
this
.disableWifiAfterScan && CellLocationManager.
this
.wifiManager.wifiManager().setWifiEnabled(
false
))
208
                  CellLocationManager.
this
.disableWifiAfterScan =
false
;
209
             
if
 (!CellLocationManager.
this
.cellInfoManager.isGsm()) {
210
                 
// L9
211
                 
if
 (CellLocationManager.
this
.bid == CellLocationManager.
this
.cellInfoManager.bid()) {
212
                     flag =
true
;
213
                  }
else
 {
214
                     flag =
false
;
215
                  }
216
                 
// L14
217
                 
if
 (flag) {
218
                     requestUpdate();
219
                  }
else
 {
220
                    
this
.sendEmptyMessageDelayed(
10
, CellLocationManager.CHECK_INTERVAL);
221
                  }
222
              }
else
 {
223
                 
// L8
224
                 
if
 (CellLocationManager.
this
.aryGsmCells ==
null
 || CellLocationManager.
this
.aryGsmCells.length ==
0
) {
225
                    
// L10
226
                     flag =
true
;
227
                  }
else
 {
228
                    
int
[] aryCells = CellLocationManager.
this
.cellInfoManager.dumpCells();
229
                    
if
 (aryCells !=
null
 && aryCells.length !=
0
) {
230
                        
// L13
231
                        
int
 nFirstCellId = CellLocationManager.
this
.aryGsmCells[
0
];
232
                        
if
 (nFirstCellId == aryCells[
0
]) {
233
                           
// L16
234
                           
int
 cellLength = CellLocationManager.
this
.aryGsmCells.length /
2
;
235
                            List<Integer> arraylist =
new
 ArrayList<Integer>(cellLength);
236
                            List<Integer> arraylist1 =
new
 ArrayList<Integer>(aryCells.length /
2
);
237
                           
int
 nIndex =
0
;
238
                           
int
 nGSMCellLength = CellLocationManager.
this
.aryGsmCells.length;
239
                           
while
 (nIndex < nGSMCellLength) {
240
                               
// goto L18
241
                                arraylist.add(CellLocationManager.
this
.aryGsmCells[nIndex]);
242
                                nIndex +=
2
;
243
                            }
244
                           
// goto L17
245
                            nIndex =
0
;
246
                           
while
 (nIndex < aryCells.length) {
247
                               
// goto L20
248
                                arraylist1.add(aryCells[nIndex]);
249
                                nIndex +=
2
;
250
                            }
251
                           
// goto L19
252
                           
int
 nCounter =
0
;
253
                           
for
(Iterator<Integer> iterator = arraylist.iterator(); iterator.hasNext();) {
254
                               
// goto L22
255
                               
if
 (arraylist1.contains(iterator.next()))
256
                                   nCounter++;
257
                            }
258
                           
// goto L21
259
                           
int
 k4 = arraylist.size() - nCounter;
260
                           
int
 l4 = arraylist1.size() - nCounter;
261
                           
if
 (k4 + l4 > nCounter)
262
                                flag =
true
;
263
                           
else
264
                                flag =
false
;
265
                           
if
 (flag) {
266
                                StringBuilder stringbuilder =
new
 StringBuilder(k4).append(
" + "
);
267
                                stringbuilder.append(l4).append(
" > "
);
268
                                stringbuilder.append(nCounter);
269
                                CellLocationManager.
this
.debug(stringbuilder.toString());
270
                            }
271
                           
break
;
272
                         }
else
 {
273
                           
// L15
274
                            flag =
true
;
275
                            CellLocationManager.
this
.debug(
"PRIMARY CELL CHANGED"
);
276
                           
// goto L14
277
                           
if
 (flag) {
278
                                requestUpdate();
279
                            }
else
 {
280
                               
this
.sendEmptyMessageDelayed(MESSAGE_BEFORE_FINISH, CellLocationManager.CHECK_INTERVAL);
281
                            }
282
                         }
283
                     }
else
 {
284
                        
// L12
285
                         flag =
true
;
286
                        
// goto L14
287
                        
if
 (flag) {
288
                            requestUpdate();
289
                         }
else
 {
290
                           
this
.sendEmptyMessageDelayed(MESSAGE_BEFORE_FINISH,CellLocationManager.CHECK_INTERVAL);
291
                         }
292
                     }
293
                  }
294
              }
295
           }
296
       }
297
    }
298
   
class

Task

extends

UserTask
<
JSONArray
,
Void
,
Void
>
{
299
      
int
 accuracy;
300
      
int
 bid;
301
      
int
[] cells;
302
      
double
 lat;
303
      
double
 lng;
304
      
long
 time;
305
      
public

Task
(
int
[] aryCell,
int
 bid)

{
306
          
this
.time = System.currentTimeMillis();
307
          
this
.cells = aryCell;
308
          
this
.bid = bid;
309
       }
310
      
public
 Void
doInBackground
(JSONArray[] paramArrayOfJSONArray)

{
311
          
try
 {
312
              JSONObject jsonObject =
new
 JSONObject();
313
              jsonObject.put(
"version"
,
"1.1.0"
);
314
              jsonObject.put(
"host"
,
"maps.google.com"
);
315
              jsonObject.put(
"address_language"
,
"zh_CN"
);
316
              jsonObject.put(
"request_address"
,
true
);
317
              jsonObject.put(
"radio_type"
,
"gsm"
);
318
              jsonObject.put(
"carrier"
,
"HTC"
);
319
              JSONArray cellJson = paramArrayOfJSONArray[
0
];
320
              jsonObject.put(
"cell_towers"
, cellJson);
321
              JSONArray wifiJson = paramArrayOfJSONArray[
1
];
322
              jsonObject.put(
"wifi_towers"
, wifiJson);
323
              DefaultHttpClient localDefaultHttpClient =
new
 DefaultHttpClient();
324
              HttpPost localHttpPost =
new
 HttpPost(
"http://www.google.com/loc/json"
);
325
              String strJson = jsonObject.toString();
326
              StringEntity objJsonEntity =
new
 StringEntity(strJson);
327
              localHttpPost.setEntity(objJsonEntity);
328
              HttpResponse objResponse = localDefaultHttpClient.execute(localHttpPost);
329
             
int
 nStateCode = objResponse.getStatusLine().getStatusCode();
330
              HttpEntity httpEntity = objResponse.getEntity();
331
             
byte
[] arrayOfByte =
null
;
332
             
if
 (nStateCode /
100
 ==
2
)
333
                  arrayOfByte = EntityUtils.toByteArray(httpEntity);
334
              httpEntity.consumeContent();
335
              String strResponse =
new
 String(arrayOfByte,
"UTF-8"
);
336
              jsonObject =
new
 JSONObject(strResponse);
337
             
this
.lat = jsonObject.getJSONObject(
"location"
).getDouble(
"latitude"
);
338
             
this
.lng = jsonObject.getJSONObject(
"location"
).getDouble(
"longitude"
);
339
             
this
.accuracy = jsonObject.getJSONObject(
"location"
).getInt(
"accuracy"
);;
340
           }
catch
 (Exception localException) {
341
             
return

null
;
342
           }
343
          
return

null
;
344
       }
345
      
public

void

onPostExecute
(Void paramVoid)

{
346
          
if
 (CellLocationManager.
this
.state != CellLocationManager.STATE_SENDING || CellLocationManager.
this
.task !=
this
)
347
             
return
;
348
          
if
 ((
this
.lat !=
0.0
D) && (
this
.lng !=
0.0
D)) {
349
              CellLocationManager.
this
.timestamp =
this
.time;
350
              CellLocationManager.
this
.latitude =
this
.lat;
351
              CellLocationManager.
this
.longitude =
this
.lng;
352
              CellLocationManager.
this
.accuracy =
this
.accuracy;
353
              CellLocationManager.
this
.aryGsmCells =
this
.cells;
354
              CellLocationManager.
this
.bid =
this
.bid;
355
              StringBuilder sb =
new
 StringBuilder(
"CELL LOCATION DONE: ("
);
356
              sb.append(
this
.lat).append(
","
).append(
this
.lng).append(
")"
);
357
              CellLocationManager.
this
.debug(sb.toString());
358
              CellLocationManager.
this
.state = STATE_READY;
359
              CellLocationManager.
this
.looper.sendEmptyMessageDelayed(MESSAGE_BEFORE_FINISH, CellLocationManager.CHECK_INTERVAL);
360
              CellLocationManager.
this
.onLocationChanged();
361
           }
else
 {
362
              CellLocationManager.
this
.task =
null
;
363
              CellLocationManager.
this
.state = CellLocationManager.STATE_READY;
364
              CellLocationManager.
this
.looper.sendEmptyMessageDelayed(MESSAGE_BEFORE_FINISH,
5000L
);
365
           }
366
       }
367
    }
368
   
private

class

CellLocationManagerBroadcastReceiver

extends

BroadcastReceiver

{
369
      
370
      
public

void

onReceive
(Context arg0, Intent intent)

{
371
          
// access$0 state
372
          
// 1 debug
373
          
// access$2 loop
374
          
// 3 startScanTimestamp
375
          
// 4 disableWifiAfterScan
376
          
// 5 wifimanager
377
          
if
 (CellLocationManager.
this
.state != CellLocationManager.STATE_COLLECTING)
378
             
return
;
379
           String s = intent.getAction();
380
          
if
 (WifiManager.SCAN_RESULTS_AVAILABLE_ACTION.equals(s)) {
// goto _L4; else goto _L3
381
          
// _L3:
382
              CellLocationManager.
this
.debug(
"WIFI SCAN COMPLETE"
);
383
              CellLocationManager.
this
.looper.removeMessages(MESSAGE_COLLECTING_WIFI);
384
             
long
 lInterval = System.currentTimeMillis() - CellLocationManager.
this
.startScanTimestamp;
385
             
if
 (lInterval >
4000L
)
386
                  CellLocationManager.
this
.looper.sendEmptyMessageDelayed(MESSAGE_COLLECTING_WIFI,
4000L
);
387
             
else
388
                  CellLocationManager.
this
.looper.sendEmptyMessage(MESSAGE_COLLECTING_WIFI);
389
           }
else
 {
390
             
// _L4:
391
             
if
 (!CellLocationManager.
this
.waiting4WifiEnable)
392
                 
return
;
393
              String s1 = intent.getAction();
394
             
if
 (!WifiManager.WIFI_STATE_CHANGED_ACTION.equals(s1))
395
                 
return
;
396
             
int
 wifiState = intent.getIntExtra(WifiManager.EXTRA_WIFI_STATE,
4
);
397
             
// _L5:
398
             
if
 (wifiState == WifiManager.WIFI_STATE_ENABLING) {
399
                 
boolean
 flag2 = CellLocationManager.
this
.wifiManager.wifiManager().startScan();
400
                 
// _L8:
401
                  CellLocationManager.
this
.disableWifiAfterScan =
true
;
402
                  CellLocationManager.
this
.paused =
false
;
403
//                 int i = flag2 ? 1 : 0;
404
//                 int nDelay = i != 0 ? 8000 : 0;
405
//                 CellLocationManager.this.looper.sendEmptyMessageDelayed(MESSAGE_COLLECTING_WIFI, nDelay);
406
                  CellLocationManager.
this
.debug(
"WIFI ENABLED"
);
407
              }
408
           }
409
       }
410
    }
411
}
调用方法： 

1
CellInfoManager cellManager =
new
 CellInfoManager(
this
);
2
       WifiInfoManager wifiManager =
new
 WifiInfoManager(
this
);
3
       CellLocationManager locationManager =
new
 CellLocationManager(
this
, cellManager, wifiManager) {
4
          
5
          
public

void

onLocationChanged
()

{
6
              txtAutoNaviInfo.setText(
this
.latitude() +
"-"
 +
this
.longitude());
7
             
this
.stop();
8
           }
9
       };
10
       locationManager.start();
如果还想同时使用GPS定位，其实也很简单，可以和FourSquare提供的BestLocationListener结合起来,将上面那段代码添加到BestLocationListener的register方法里：

1
public

void

register
(LocationManager locationManager,
boolean
 gps, Context context)

{
2
   
if
 (DEBUG) Log.d(TAG,
"Registering this location listener: "
 +
this
.toString());
3
   
long
 updateMinTime = SLOW_LOCATION_UPDATE_MIN_TIME;
4
   
long
 updateMinDistance = SLOW_LOCATION_UPDATE_MIN_DISTANCE;
5
   
if
 (gps) {
6
      updateMinTime = LOCATION_UPDATE_MIN_TIME;
7
      updateMinDistance = LOCATION_UPDATE_MIN_DISTANCE;
8
    }
9
    List<String> providers = locationManager.getProviders(
true
);
10
   
int
 providersCount = providers.size();
11
   
if
 (!locationManager.isProviderEnabled(LocationManager.GPS_PROVIDER) && !locationManager.isProviderEnabled(LocationManager.NETWORK_PROVIDER)){
12
        setChanged();
13
        notifyObservers(
null
);
14
    }
15
   
for
 (
int
 i =
0
; i < providersCount; i++) {
16
      String providerName = providers.get(i);
17
     
if
 (locationManager.isProviderEnabled(providerName)) {
18
        updateLocation(locationManager.getLastKnownLocation(providerName));
19
      }
20
     
// Only register with GPS if we've explicitly allowed it.
21
     
if
 (gps || !LocationManager.GPS_PROVIDER.equals(providerName)) {
22
        locationManager.requestLocationUpdates(providerName, updateMinTime,
23
            updateMinDistance,
this
);
24
      }
25
    }
26
   
if
(cellLocationManager ==
null
) {
27
        CellInfoManager cellManager =
new
 CellInfoManager(context);
28
         WifiInfoManager wifiManager =
new
 WifiInfoManager(context);
29
         cellLocationManager =
new
 CellLocationManager(context, cellManager, wifiManager) {
30
           
31
           
public

void

onLocationChanged
()

{
32
               
if
 ((latitude() ==
0.0
D) || (longitude() ==
0.0
D))
return
;
33
                Location result =
new
 Location(
"CellLocationManager"
);
34
                result.setLatitude(latitude());
35
                result.setLongitude(longitude());
36
                result.setAccuracy(accuracy());
37
                onBestLocationChanged(result);
38
               
this
.stop();
39
            }
40
         };
41
    }
42
   
//cellLocationManager.stop();
43
    cellLocationManager.start();
44
//    LocationController controller = LocationController.requestLocationUpdates("", updateMinTime,updateMinDistance, this, context);
45
//    controller.requestCurrentLocation();
46
  }
复制
原文链接：http://www.jb51.net/article/52673.htm