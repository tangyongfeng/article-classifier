# 笔记与知识管理平台需求规划

## 1. 愿景与范围
- 构建一个服务于个人的本地化知识管控平台，能够长期接收多渠道输入（Evernote 备份、邮件、电子书、网页收藏等），自动完成清洗、整理、分类、摘要和存储。
- 平台提供可搜索、可编辑、可回溯的多维度知识库，同时支持邮件指令交互，实现“发送即归档 / 发送即检索 / 发送即提醒”。
- 所有能力在本地设备上运行，优先保障隐私、安全与可控性，允许用户按需手动介入修订。

## 2. 目标用户与典型场景
- **目标用户**：系统所有者（你本人），具备一定技术基础、习惯多终端记录信息，关注长期知识积累与检索效率。
- **核心场景**：
  - Evernote 旧笔记批量导入 → 自动清洗 → 结构化归档。
  - 将网页/论坛/社交媒体内容通过邮件转发 → 系统自动抓取正文、提炼摘要、归类。
  - 发送邮件指令（如“搜索某主题”“列出待办”）→ 系统查询后邮件回复。
  - 在 Web 端快速查找、编辑、补充标签与关联信息。
  - 随手笔记（文本/语音转文字）进入统一数据库，后续可检索与分析。

## 3. 核心需求概览
- **数据统合**：支持多格式、多语言内容（中文/德语/英语为主），统一转换为结构化 JSON + 数据库记录，保留原始文本与清洗文本的区分。
- **分类与知识组织**：提供多层级分类、标签体系、关键词/主题抽取、待办与引用识别，需可持续演化并支持人工调整。
- **搜索与分析**：全文检索、语义检索、模糊匹配、多条件过滤、时间线视图、相似笔记推荐。
- **邮件交互**：处理转发内容与指令，支持正文解析、链接抓取、附件 OCR、查询回复。
- **模型管理**：支持按任务选择不同模型，必要时自动切换至更大模型重跑；保留执行日志，便于回溯。
- **清洗与质量保障**：构建可扩展的数据清洗管线，应对来源多样、格式混乱、语言混杂的情况，确保归档文本可读。

### 系统分层架构
- **数据处理层（Agent Fabric）**：针对不同输入渠道（Evernote、邮件、网页、电子书等）配置独立的可替换 Agent；负责内容探测、清洗、结构化抽取、模型调用与多版本结果管理；通过标准化事件/任务接口让 Agent 能快速升级或并行迭代。
- **应用层（Knowledge Orchestration）**：管理分类、标签、任务提醒、知识关联、搜索索引与调度队列等“事务性”能力；提供领域规则、重跑策略、手动干预入口以及日志与度量治理。
- **交互层（Human Interface）**：面向用户的访问渠道，目前包括 Web 管理端与邮件交互；未来预留桌面端、移动端或 Chat 接口；负责权限校验、视图组合、反馈呈现与多模态输出。
- **跨层支撑**：统一的配置中心、模型管理、监控日志与审计链路，为三层提供共享的元数据与治理能力。

## 4. 数据来源与接入路径
- **Evernote 备份**：面向 HTML/ENEX/Markdown/纯文本等混合格式，兼容嵌入的资源（图片、附件、表格）；标签与笔记本层级无需保留，但需要记录原始来源信息。
- **邮件**：
  - IMAP 轮询 + SMTP 回执或 webhook 转发。
  - 自动识别正文、引用历史、附件、URL。
  - 指令类邮件：解析命令并返回查询结果或执行反馈。
- **网页 / 链接**：在邮件或 Web 前端输入 URL 时，自动抓取正文与元数据。
- **电子书与其他来源**：预留 EPUB/PDF 等格式解析扩展点，结合 OCR/文本抽取工具。

## 5. 内容处理与数据清洗
- **预处理管线**：格式探测 → 字符编码处理 → HTML/Markdown 渲染、去除噪音 → 段落重建 → 正文抽取 → 语言检测 → 去重与合并。
- **结构化抽取**：
  - 标题、作者/来源、发表时间、链接。
  - 摘要（可多版本）、关键词、主题标签、任务/提醒项、引用链接/参考资料。
  - 情感或语气分析（可选）。
- **质量控制**：
  - 可配置的清洗规则集（针对 Twitter、论坛、AI 生成内容等不同模板）。
  - 清洗后与原文并存，标记清洗版本的可信度与修改点。
  - 记录清洗日志，便于定位问题内容。

## 6. LLM 策略与模型管理
- **模型组合**：维持本地 Ollama 为默认通道，定义任务与模型映射（分类、摘要、关键词、待办抽取、重排版等），并支持高规格模型的二次执行。
- **重跑机制**：
  - 首次运行失败或结果不佳时，可自动切换到备用模型或提示人工重跑。
  - 保留各次运行的输出、模型参数、耗时与评分，方便比较。
- **提示模板与约束**：为不同任务设计可配置的 Prompt，注重输出结构化与语言控制。
- **成本与性能**：允许限制长文本的分段推理，支持异步或批处理以平衡速度与可用性。

## 7. 数据存储与模型
- **分层存储结构**：
  - `raw_content`：原始文件或抓取文本，保留完整上下文。
  - `clean_content`：清洗、排版、去噪后的正文，可多版本（如不同模型输出或人工修订记录）。
  - `structured_metadata`：JSON/关系型字段，记录分类路径、标签、摘要、任务、引用、语言、来源、抓取信息、处理状态等。
  - `processing_journal`：记录处理管线步骤、模型调用、错误日志、人工干预历史。
- **数据库组合**：PostgreSQL（主元数据 + 关系查询）+ JSON 文件库（原文/清洗内容快照）+ 向量库（语义检索；可选 Chroma/Faiss/PGVector）。
- **版本管理**：对笔记的原文、清洗文本、摘要、标签等分别维护版本号与时间戳，提供回滚能力。

## 8. Web 平台功能
- **信息总览**：分类树、标签云、统计面板、处理状态仪表盘。
- **搜索与浏览**：全文与语义检索、按分类/标签/来源/语言/时间筛选、时间线和聚类视图。
- **笔记详情**：展示原文、清洗版本、摘要/标签、附件、引用关系、历史版本、相关笔记推荐。
- **编辑能力**：
  - 修改分类、标签、摘要、待办、关系链接。
  - 提交清洗修订并保留差异。
  - 触发重新分类/重摘要/重生成标签。
- **知识结构工具**：
  - 手动调整分类层级。
  - 生成知识图谱或关系图（后续迭代）。
  - 待办/提醒面板，展示模型识别的任务项。
- **前端实现**：可沿用 Flask + Jinja，或在后续迭代引入前后端分离架构；设计保持组件化，便于扩展。

## 9. 搜索与分析能力
- **搜索引擎**：组合使用倒排索引（关键字、字段过滤）与向量检索（语义匹配、相似笔记）。
- **检索体验**：模糊匹配、拼写容错、搜索建议、多条件组合过滤（来源、语言、时间、标签、待办状态等）。
- **可视化**：时间轴、分类热度、主题趋势、语言分布；支持导出统计数据。
- **分析工具**：
  - 相似内容聚合，避免重复记录。
  - 主题聚类与演化跟踪。
  - 手动标注后进行模型调优。

## 10. 邮件交互设计
- **邮件输入工作流**：
  - 转发带正文的邮件 → 自动抽取内容、链接、附件。
  - 转发仅含链接 → 自动抓取网页内容并归档。
  - 指令邮件（如 `search: keyword`）→ 系统执行查询后以邮件回复。
- **安全与鉴权**：基于白名单邮箱、简易密钥或邮件令牌；支持邮件签名校验。
- **反馈机制**：处理成功/失败的回执邮件，包含摘要、分类、下一步建议。
- **任务调度**：
  - 定时轮询收件箱。
  - 异步队列执行抓取和模型任务。
  - 邮件指令需具备幂等性与错误提示。

## 11. 自动化与任务管线
- **处理队列**：统一任务调度器（如 Celery/RQ 简化版本）。
- **状态管理**：任务表记录状态、优先级、重试次数、输出摘要。
- **批量作业**：支持手动触发批量清洗、批量重跑分类、批量重摘要等。
- **手动干预**：提供重排队列、暂停、取消、重试等控制。

## 12. 非功能性需求
- **部署形态**：本地单机，兼容 macOS 主机环境。
- **可维护性**：模块化设计、明确接口、完整日志记录。
- **性能目标**：
  - Evernote 首次批量导入不追求实时；邮件输入应在可接受时间（可配置，如 5-10 分钟内）完成归档。
  - 搜索查询响应需在秒级。
- **可靠性**：数据落盘持久化，必要的自动备份（可由用户手动触发）。
- **可观测性**：提供任务监控、错误告警（本地通知 / 邮件提示）。

## 13. 迭代与里程碑建议
- **Phase 0：基础整理**
  - 归档现有脚本与文档（已完成）。
  - 评估现有代码的可复用模块与技术债务。

- **Phase 1：数据导入最小可用**
  - 构建统一的数据模型草案。
  - 实现 Evernote 混合格式解析 → 清洗 → JSON/数据库写入。
  - 搭建基础清洗规则与日志记录。
  - 简易管理界面或 CLI 校验导入效果。

- **Phase 2：清洗 + 分类 + 存储稳定化**
  - 完善 LLM 调度和重跑机制。
  - 引入原文/清洗/结构化分层存储逻辑。
  - 搭建初步 Web 浏览界面与全文检索能力。

- **Phase 3：搜索与知识管理增强**
  - 构建语义检索、时间线及相似笔记推荐。
  - 增强分类/标签手工维护能力。
  - 引入待办提醒、引用关系可视化。

- **Phase 4：邮件交互与多源输入**
  - 打通邮件收取、指令解析、结果回执。
  - 支持链接抓取、附件 OCR。
  - 预留电子书/其他内容源接入。

- **Phase 5：高级功能与优化**
  - 批量作业控制台、自动化规则引擎。
  - 模型评估与反馈闭环。
  - 知识图谱或跨笔记引用管理。

## 14. 风险与应对
- **模型表现不稳定**：保留多模型策略、建立失败重试与人工验收流程。
- **数据清洗复杂度高**：采取渐进式规则库，优先覆盖主流来源；提供人工增量修订工具。
- **开发范围大**：通过阶段划分与优先级管理，确保先实现核心链路（导入→清洗→分类→搜索）。
- **系统跨模块耦合**：保持组件化设计，定义清晰接口（数据导入、处理、存储、检索、交互）。

## 15. 后续准备工作
- 汇总典型数据样本（Evernote、邮件正文、含链接内容、电子书片段），用于验证清洗与模型效果。
- 初步草拟数据模型与字段说明，涵盖内容层、结构化层、日志层。
- 明确优先支持的邮件服务提供商和接入方式（IMAP/SMTP 参数）。
- 调研可行的全文检索与向量库方案，在本地部署可行性方面进行对比。
- 制定任务调度与日志规范，为后续开发提供约束。

---
以上规划可作为后续数据模型设计和阶段任务拆解的前置蓝图。若需调整或补充，请指出，我们可进一步细化每一阶段的执行清单与技术方案。